{% extends "base.html" %}

{% block content %}
<style>
    .fatturazione-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px 0;
    }
    
    .fatturazione-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
        margin: 0;
    }
    
    .fatturazione-header .back-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 15px;
        text-decoration: none;
        color: var(--text-dark);
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .fatturazione-header .back-btn:hover {
        background: #f5f5f5;
        transform: translateX(-3px);
    }
    
    .filtro-nome-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.03);
        margin-bottom: 30px;
    }
    
    .filtro-nome-section h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 15px 0;
        color: var(--text-dark);
    }
    
    .filtro-nome-section select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 12px;
        font-size: 1rem;
        outline: none;
        transition: all 0.2s;
    }
    
    .filtro-nome-section select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .fatturazione-summary {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .summary-card {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.03);
    }
    
    .summary-card h3 {
        font-size: 0.9rem;
        color: #666;
        margin: 0 0 10px 0;
        font-weight: 500;
    }
    
    .summary-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-dark);
    }
    
    .fatturazione-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 2px 20px rgba(0,0,0,0.03);
        margin-bottom: 30px;
    }
    
    .fatturazione-section h2 {
        font-size: 1.3rem;
        font-weight: 600;
        margin: 0 0 20px 0;
        color: var(--text-dark);
    }
    
    .fatturazione-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .fatturazione-table thead th {
        background: #f5f5f5;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        color: #666;
        border-bottom: 2px solid #ddd;
    }
    
    .fatturazione-table tbody td {
        padding: 15px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        vertical-align: top;
    }
    
    .fatturazione-table tbody tr:hover {
        background: #f9f9f9;
    }
    
    .fatturazione-table tbody tr.selected {
        background: #e3f2fd;
    }
    
    .bene-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
    }
    
    .bene-row:not(:last-child) {
        border-bottom: 1px dashed #eee;
        padding-bottom: 6px;
        margin-bottom: 4px;
    }
    
    .bene-nome {
        flex: 1;
        color: var(--text-dark);
    }
    
    .bene-importo {
        font-weight: 500;
        color: #555;
        white-space: nowrap;
        margin-left: 15px;
    }
    
    .fatturazione-input-group {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        margin-top: 20px;
    }
    
    .fatturazione-input-group .input-wrapper {
        flex: 1;
    }
    
    .fatturazione-input-group label {
        display: block;
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .fatturazione-input-group input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 12px;
        font-size: 1rem;
        outline: none;
        transition: all 0.2s;
    }
    
    .fatturazione-input-group input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }
    
    .btn-salva-fattura {
        padding: 12px 30px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }
    
    .btn-salva-fattura:hover {
        background: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    .btn-salva-fattura:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
    }
    
    .checkbox-cell {
        text-align: center;
        width: 50px;
    }
    
    .checkbox-cell input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
    }
    
    .fatture-emesse-list {
        margin-top: 20px;
    }
    
    .fattura-item {
        background: #f9f9f9;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 15px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .fattura-item:hover {
        background: #f0f0f0;
    }
    
    .fattura-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .fattura-item-header .fattura-numero {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--text-dark);
    }
    
    .fattura-item-header .fattura-data {
        font-size: 0.9rem;
        color: #666;
    }
    
    .fattura-item-header .fattura-totale {
        font-weight: 600;
        color: var(--primary);
        font-size: 1rem;
    }
    
    .fattura-item-header .expand-icon {
        transition: transform 0.3s;
    }
    
    .fattura-item.expanded .expand-icon {
        transform: rotate(180deg);
    }
    
    .fattura-item-lavori {
        display: none;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
    }
    
    .fattura-item.expanded .fattura-item-lavori {
        display: block;
    }
    
    .lavoro-item {
        padding: 10px;
        background: white;
        border-radius: 8px;
        margin-bottom: 10px;
    }
    
    .lavoro-item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    
    .lavoro-item-header .lavoro-numero {
        font-weight: 600;
        color: var(--text-dark);
    }
    
    .lavoro-item-header .lavoro-compenso {
        font-weight: 600;
        color: var(--primary);
    }
    
    .lavoro-item-cliente {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 5px;
    }
    
    .lavoro-item-beni {
        font-size: 0.85rem;
        color: #999;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        opacity: 0.5;
    }
    
    .select-all-row {
        background: #f5f5f5;
        font-weight: 600;
    }
    
    /* Modal modifica fattura */
    .modal-modifica-fattura {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        overflow-y: auto;
    }
    
    .modal-modifica-fattura.active {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }
    
    .modal-content-fattura {
        background: white;
        border-radius: 20px;
        padding: 30px;
        max-width: 900px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    
    .modal-header-fattura {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #eee;
    }
    
    .modal-header-fattura h2 {
        margin: 0;
        font-size: 1.5rem;
        color: var(--text-dark);
    }
    
    .btn-close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #999;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .btn-close-modal:hover {
        color: var(--text-dark);
    }
    
    .modal-input-group {
        margin-bottom: 20px;
    }
    
    .modal-input-group label {
        display: block;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .modal-lavori-section {
        margin-top: 25px;
    }
    
    .modal-lavori-section h3 {
        font-size: 1.1rem;
        margin-bottom: 15px;
        color: var(--text-dark);
    }
    
    .modal-lavori-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 10px;
    }
    
    .modal-lavoro-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
    }
    
    .modal-lavoro-item:hover {
        background: #f9f9f9;
    }
    
    .modal-lavoro-item:last-child {
        border-bottom: none;
    }
    
    .modal-lavoro-item input[type="checkbox"] {
        margin-right: 12px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .modal-lavoro-info {
        flex: 1;
    }
    
    .modal-lavoro-numero {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
    }
    
    .modal-lavoro-cliente {
        font-size: 0.85rem;
        color: #666;
        margin-bottom: 4px;
    }
    
    .modal-lavoro-beni {
        font-size: 0.8rem;
        color: #999;
    }
    
    .modal-lavoro-importi {
        text-align: right;
        margin-left: 15px;
    }
    
    .modal-lavoro-compenso {
        font-weight: 600;
        color: var(--primary);
        font-size: 0.9rem;
    }
    
    .modal-lavoro-importo {
        font-size: 0.85rem;
        color: #666;
        margin-top: 4px;
    }
    
    .modal-actions {
        display: flex;
        gap: 15px;
        margin-top: 25px;
        justify-content: flex-end;
    }
    
    .btn-modifica-fattura {
        padding: 8px 16px;
        background: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.85rem;
        color: #666;
        transition: all 0.2s;
    }
    
    .btn-modifica-fattura:hover {
        background: #e9e9e9;
    }
</style>

<div class="fatturazione-header">
    <h1>Fatturazione {{ nome_display }}</h1>
    <div style="display: flex; gap: 10px;">
        <a href="{{ url_for('main.fatturazione', tipo='fe') }}" class="back-btn">
            <i class="bi bi-people"></i>
            Passa ad Interni
        </a>
        <a href="{{ url_for('main.dashboard') }}" class="back-btn">
            <i class="bi bi-arrow-left"></i>
            Torna alla Dashboard
        </a>
    </div>
</div>

{% if campo_nome %}
<div class="filtro-nome-section">
    <h3>Filtra per Nome</h3>
    <select id="filtroNome" onchange="applicaFiltroNome()">
        <option value="">-- Tutti --</option>
        {% for nome in nomi_disponibili %}
        <option value="{{ nome }}" {% if filtro_nome == nome %}selected{% endif %}>{{ nome }}</option>
        {% endfor %}
    </select>
</div>
{% endif %}

<div class="fatturazione-summary">
    <div class="summary-card">
        <h3>Lavori da Fatturare</h3>
        <div class="value" id="countLavori">{{ lavori_data|length }}</div>
    </div>
    <div class="summary-card">
        <h3>Totale Compensi</h3>
        <div class="value">€ {{ "{:,.2f}".format(totale_compensi).replace(",", "X").replace(".", ",").replace("X", ".") }}</div>
    </div>
</div>

<div class="fatturazione-section" id="sezioneLavoriDaFatturare">
    <h2>Lavori con Stato "Incassata"</h2>
    
    {% if lavori_data %}
    <table class="fatturazione-table">
        <thead>
            <tr>
                <th class="checkbox-cell">
                    <input type="checkbox" id="selectAll" onchange="toggleAll(this)">
                </th>
                <th>N°</th>
                <th>Cliente</th>
                <th>Beni</th>
                <th>Compenso {{ nome_display }}</th>
            </tr>
        </thead>
        <tbody>
            {% for item in lavori_data %}
            <tr data-lavoro-id="{{ item.lavoro.id }}">
                <td class="checkbox-cell">
                    <input type="checkbox" class="lavoro-checkbox" value="{{ item.lavoro.id }}" onchange="updateSelectedCount()">
                </td>
                <td style="font-weight: 600;">{{ loop.index }}</td>
                <td>{{ item.lavoro.cliente_nome or '-' }}</td>
                <td>
                    {% for bene in item.beni %}
                    <div class="bene-row">
                        <span class="bene-nome">{{ bene.descrizione }}</span>
                        <span class="bene-importo">€ {{ "{:,.2f}".format(bene.importo).replace(",", "X").replace(".", ",").replace("X", ".") }}</span>
                    </div>
                    {% endfor %}
                </td>
                <td style="font-weight: 600; color: var(--primary);">
                    € {{ "{:,.2f}".format(item.compenso).replace(",", "X").replace(".", ",").replace("X", ".") }}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div class="fatturazione-input-group">
        <div class="input-wrapper">
            <label for="numeroFattura">Numero Fattura</label>
            <input type="text" id="numeroFattura" placeholder="Inserisci il numero di fattura" class="one-ui-input">
        </div>
        <button class="btn-salva-fattura" id="btnSalvaFattura" onclick="salvaFattura()" disabled>
            <i class="bi bi-check-circle"></i> Salva Fattura
        </button>
    </div>
    {% else %}
    <div class="empty-state">
        <i class="bi bi-inbox"></i>
        <p>Nessun lavoro con stato "incassata" e compenso {{ nome_display }} > 0</p>
    </div>
    {% endif %}
</div>

<div class="fatturazione-section" id="sezioneFattureEmesse">
    <h2>Fatture Emesse</h2>
    <div id="fattureEmesseList" class="fatture-emesse-list">
        <div class="empty-state">
            <i class="bi bi-hourglass-split"></i>
            <p>Caricamento fatture...</p>
        </div>
    </div>
</div>

<!-- Modal Modifica Fattura -->
<div id="modalModificaFattura" class="modal-modifica-fattura">
    <div class="modal-content-fattura">
        <div class="modal-header-fattura">
            <h2>Modifica Fattura</h2>
            <button class="btn-close-modal" onclick="chiudiModalModifica()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        
        <div class="modal-input-group">
            <label for="modalNumeroFattura">Numero Fattura</label>
            <input type="text" id="modalNumeroFattura" class="one-ui-input" placeholder="Inserisci il numero di fattura">
        </div>
        
        <div class="modal-lavori-section">
            <h3>Lavori da Includere</h3>
            <div id="modalLavoriList" class="modal-lavori-list">
                <div class="empty-state">
                    <i class="bi bi-hourglass-split"></i>
                    <p>Caricamento lavori...</p>
                </div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn-modifica-fattura" onclick="chiudiModalModifica()">Annulla</button>
            <button class="btn-salva-fattura" id="btnSalvaModifica" onclick="salvaModificaFattura()">
                <i class="bi bi-check-circle"></i> Salva Modifiche
            </button>
        </div>
    </div>
</div>

<script>
    const tipo = '{{ tipo }}';
    const campoNome = '{{ campo_nome or "" }}';
    const filtroNomeCorrente = '{{ filtro_nome or "" }}';
    let selectedLavori = new Set();
    
    function applicaFiltroNome() {
        const select = document.getElementById('filtroNome');
        if (select) {
            const nomeSelezionato = select.value;
            const url = new URL(window.location.href);
            if (nomeSelezionato) {
                url.searchParams.set('nome', nomeSelezionato);
            } else {
                url.searchParams.delete('nome');
            }
            window.location.href = url.toString();
        }
    }
    
    function toggleAll(checkbox) {
        const checkboxes = document.querySelectorAll('.lavoro-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = checkbox.checked;
            if (checkbox.checked) {
                selectedLavori.add(parseInt(cb.value));
            } else {
                selectedLavori.delete(parseInt(cb.value));
            }
        });
        updateSelectedCount();
    }
    
    document.querySelectorAll('.lavoro-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            const lavoroId = parseInt(this.value);
            if (this.checked) {
                selectedLavori.add(lavoroId);
            } else {
                selectedLavori.delete(lavoroId);
            }
            updateSelectedCount();
        });
    });
    
    function updateSelectedCount() {
        const count = selectedLavori.size;
        const btn = document.getElementById('btnSalvaFattura');
        const input = document.getElementById('numeroFattura');
        
        if (count > 0 && input && input.value.trim()) {
            btn.disabled = false;
        } else {
            if (btn) {
                btn.disabled = true;
            }
        }
        
        const countEl = document.getElementById('countLavori');
        if (countEl) {
            if (count > 0) {
                countEl.textContent = count + ' selezionati';
            } else {
                const totalRows = document.querySelectorAll('.lavoro-checkbox').length;
                countEl.textContent = totalRows;
            }
        }
    }
    
    const numeroFatturaInput = document.getElementById('numeroFattura');
    if (numeroFatturaInput) {
        numeroFatturaInput.addEventListener('input', updateSelectedCount);
    }
    
    function salvaFattura() {
        const numeroFattura = document.getElementById('numeroFattura').value.trim();
        
        if (!numeroFattura) {
            showToast('Inserisci un numero di fattura', 'error');
            return;
        }
        
        if (selectedLavori.size === 0) {
            showToast('Seleziona almeno un lavoro', 'error');
            return;
        }
        
        const btn = document.getElementById('btnSalvaFattura');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvataggio...';
        
        fetch('/api/fatturazione_esterni/salva', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tipo: tipo,
                numero_fattura: numeroFattura,
                lavori_ids: Array.from(selectedLavori)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Fattura ${numeroFattura} salvata su ${data.lavori_aggiornati} lavori`, 'success');
                // Ricarica la pagina per aggiornare tutto
                setTimeout(() => { window.location.reload(); }, 1000);
            } else {
                showToast(data.error || 'Errore nel salvataggio', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Salva Fattura';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Errore di connessione', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Salva Fattura';
        });
    }
    
    function caricaFattureEmesse() {
        const sezioneFatture = document.getElementById('sezioneFattureEmesse');
        if (!sezioneFatture) return;
        
        const container = document.getElementById('fattureEmesseList');
        if (!container) {
            setTimeout(caricaFattureEmesse, 200);
            return;
        }
        
        if (!sezioneFatture.contains(container)) return;
        
        const currentContent = container.innerHTML.trim();
        if (!currentContent || currentContent.includes('Caricamento fatture') || currentContent.includes('hourglass')) {
            container.innerHTML = '<div class="empty-state"><i class="bi bi-hourglass-split"></i><p>Caricamento fatture...</p></div>';
        }
        
        let url = `/api/fatturazione_esterni/lista/${tipo}`;
        if (campoNome && filtroNomeCorrente) {
            url += `?nome=${encodeURIComponent(filtroNomeCorrente)}`;
        }
        
        fetch(url)
        .then(response => {
            if (!response.ok) throw new Error(`Errore HTTP: ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (!data || !data.fatture) {
                const containerCheck = document.getElementById('fattureEmesseList');
                if (containerCheck) {
                    containerCheck.innerHTML = '<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>Errore nel formato dei dati</p></div>';
                }
                return;
            }
            
            const containerCheck = document.getElementById('fattureEmesseList');
            if (!containerCheck) return;
            
            if (data.fatture.length > 0) {
                containerCheck.innerHTML = '';
                data.fatture.forEach(fattura => {
                    const item = document.createElement('div');
                    item.className = 'fattura-item';
                    item.innerHTML = `
                        <div class="fattura-item-header">
                            <div onclick="toggleFattura(this)" style="flex: 1; cursor: pointer;">
                                <div class="fattura-numero">Fattura ${fattura.numero}</div>
                                <div class="fattura-data">${fattura.data ? new Date(fattura.data).toLocaleDateString('it-IT') : 'Data non disponibile'}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 20px;">
                                <div class="fattura-totale">€ ${formatCurrency(fattura.totale_compensi)}</div>
                                <button class="btn-modifica-fattura" onclick="apriModalModifica('${fattura.numero}')" style="padding: 6px 12px;">
                                    <i class="bi bi-pencil"></i> Modifica
                                </button>
                                <button class="btn-elimina-fattura" onclick="eliminaFatturaEsterni('${fattura.numero}')" style="padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                    <i class="bi bi-trash"></i> Elimina
                                </button>
                                <i class="bi bi-chevron-down expand-icon" onclick="toggleFattura(this)" style="cursor: pointer;"></i>
                            </div>
                        </div>
                        <div class="fattura-item-lavori">
                            ${fattura.lavori.map(lavoro => `
                                <div class="lavoro-item">
                                    <div class="lavoro-item-header">
                                        <span class="lavoro-numero">${lavoro.cliente}</span>
                                        <span class="lavoro-compenso">€ ${formatCurrency(lavoro.compenso)}</span>
                                    </div>
                                    <div class="lavoro-item-beni">${lavoro.beni.join(', ')}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    containerCheck.appendChild(item);
                });
            } else {
                containerCheck.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>Nessuna fattura emessa</p></div>';
            }
        })
        .catch(error => {
            console.error('Errore nel caricamento delle fatture:', error);
            if (container) {
                container.innerHTML = '<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>Errore nel caricamento delle fatture. Riprovo...</p></div>';
            }
            setTimeout(() => { caricaFattureEmesse(); }, 2000);
        });
    }
    
    function toggleFattura(header) {
        const item = header.closest('.fattura-item');
        item.classList.toggle('expanded');
    }
    
    function formatCurrency(value) {
        return parseFloat(value).toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }
    
    function initCaricaFatture() {
        try {
            const sezioneFatture = document.getElementById('sezioneFattureEmesse');
            const container = document.getElementById('fattureEmesseList');
            if (sezioneFatture && container) {
                caricaFattureEmesse();
            } else {
                setTimeout(initCaricaFatture, 100);
            }
        } catch (error) {
            console.error('Errore nell\'inizializzazione:', error);
            setTimeout(() => { caricaFattureEmesse(); }, 500);
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initCaricaFatture);
    } else {
        initCaricaFatture();
    }
    
    setTimeout(() => {
        const container = document.getElementById('fattureEmesseList');
        if (container) {
            const content = container.innerHTML.trim();
            if (content.includes('Caricamento fatture') || content.includes('hourglass') || content === '') {
                caricaFattureEmesse();
            }
        }
    }, 1000);
    
    let fatturaCorrente = null;
    let tuttiLavoriDisponibili = [];
    
    function apriModalModifica(numeroFattura) {
        fatturaCorrente = numeroFattura;
        document.getElementById('modalNumeroFattura').value = numeroFattura;
        document.getElementById('modalModificaFattura').classList.add('active');
        caricaLavoriDisponibili(numeroFattura);
    }
    
    function chiudiModalModifica() {
        document.getElementById('modalModificaFattura').classList.remove('active');
        fatturaCorrente = null;
        tuttiLavoriDisponibili = [];
    }
    
    function caricaLavoriDisponibili(numeroFattura) {
        const container = document.getElementById('modalLavoriList');
        container.innerHTML = '<div class="empty-state"><i class="bi bi-hourglass-split"></i><p>Caricamento lavori...</p></div>';
        
        let url = `/api/fatturazione_esterni/lavori-disponibili/${tipo}?fattura=${encodeURIComponent(numeroFattura)}`;
        if (campoNome && filtroNomeCorrente) {
            url += `&nome=${encodeURIComponent(filtroNomeCorrente)}`;
        }
        
        fetch(url)
        .then(response => response.json())
        .then(data => {
            tuttiLavoriDisponibili = data.lavori || [];
            mostraLavoriNelModal(numeroFattura);
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<div class="empty-state"><i class="bi bi-exclamation-triangle"></i><p>Errore nel caricamento</p></div>';
        });
    }
    
    function mostraLavoriNelModal(numeroFattura) {
        const container = document.getElementById('modalLavoriList');
        
        if (tuttiLavoriDisponibili.length === 0) {
            container.innerHTML = '<div class="empty-state"><i class="bi bi-inbox"></i><p>Nessun lavoro disponibile</p></div>';
            return;
        }
        
        container.innerHTML = '';
        
        const lavoriUnici = {};
        tuttiLavoriDisponibili.forEach(lavoro => {
            if (!lavoriUnici[lavoro.id]) {
                lavoriUnici[lavoro.id] = lavoro;
            }
        });
        
        Object.values(lavoriUnici).forEach(lavoro => {
            const fatturaAttuale = (lavoro.fattura_attuale || '').toString().trim();
            const numeroFatturaTrim = (numeroFattura || '').toString().trim();
            const isIncluso = fatturaAttuale === numeroFatturaTrim && fatturaAttuale !== '';
            const isChiusa = lavoro.stato === 'chiusa';
            
            const item = document.createElement('div');
            item.className = 'modal-lavoro-item';
            
            const beniList = lavoro.beni && lavoro.beni.length > 0 
                ? lavoro.beni.map(b => b.descrizione).join(', ')
                : 'Nessun bene';
            const importoTotale = lavoro.beni && lavoro.beni.length > 0
                ? lavoro.beni.reduce((sum, b) => sum + (b.importo || 0), 0)
                : (lavoro.importo_totale || 0);
            
            item.innerHTML = `
                <input type="checkbox" 
                       class="modal-lavoro-checkbox" 
                       value="${lavoro.id}" 
                       ${isIncluso ? 'checked' : ''}
                       ${isChiusa && isIncluso ? 'disabled' : ''}
                       onchange="updateModalSelected()">
                <div class="modal-lavoro-info">
                    <div class="modal-lavoro-numero">
                        ${lavoro.cliente}
                        ${isChiusa && isIncluso ? '<span style="color: #2e7d32; font-size: 0.75rem; margin-left: 8px;">(Chiusa)</span>' : ''}
                    </div>
                    <div class="modal-lavoro-beni">${beniList}</div>
                </div>
                <div class="modal-lavoro-importi">
                    <div>
                        <div class="modal-lavoro-compenso">€ ${formatCurrency(lavoro.compenso)}</div>
                        <div class="modal-lavoro-importo">€ ${formatCurrency(importoTotale)}</div>
                    </div>
                </div>
            `;
            container.appendChild(item);
        });
    }
    
    function updateModalSelected() {
        const btn = document.getElementById('btnSalvaModifica');
        const input = document.getElementById('modalNumeroFattura');
        btn.disabled = !input.value.trim();
    }
    
    function salvaModificaFattura() {
        const nuovoNumero = document.getElementById('modalNumeroFattura').value.trim();
        
        if (!nuovoNumero) {
            showToast('Inserisci un numero di fattura', 'error');
            return;
        }
        
        if (!fatturaCorrente) {
            showToast('Errore: fattura non identificata', 'error');
            return;
        }
        
        const checkboxes = document.querySelectorAll('.modal-lavoro-checkbox:checked');
        const lavoriSelezionati = new Set();
        checkboxes.forEach(cb => {
            lavoriSelezionati.add(parseInt(cb.value));
        });
        
        const btn = document.getElementById('btnSalvaModifica');
        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Salvataggio...';
        
        fetch('/api/fatturazione_esterni/aggiorna', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tipo: tipo,
                vecchio_numero: fatturaCorrente,
                nuovo_numero: nuovoNumero,
                lavori_ids_inclusi: Array.from(lavoriSelezionati)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Fattura ${nuovoNumero} aggiornata su ${data.lavori_aggiornati} lavori`, 'success');
                chiudiModalModifica();
                setTimeout(() => { window.location.reload(); }, 1000);
            } else {
                showToast(data.error || 'Errore nel salvataggio', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Salva Modifiche';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Errore di connessione', 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Salva Modifiche';
        });
    }
    
    const modalNumeroFatturaInput = document.getElementById('modalNumeroFattura');
    if (modalNumeroFatturaInput) {
        modalNumeroFatturaInput.addEventListener('input', updateModalSelected);
    }
    
    function eliminaFatturaEsterni(numeroFattura) {
        if (!confirm(`Sei sicuro di voler eliminare l'intera fattura ${numeroFattura}? Tutti i lavori associati torneranno disponibili per la fatturazione.`)) {
            return;
        }
        
        fetch('/api/fatturazione_esterni/elimina', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tipo: tipo,
                numero_fattura: numeroFattura
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`Fattura ${numeroFattura} eliminata. I lavori sono tornati disponibili per la fatturazione.`, 'success');
                setTimeout(() => { window.location.reload(); }, 500);
            } else {
                showToast(data.error || 'Errore nell\'eliminazione', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Errore di connessione', 'error');
        });
    }
</script>

{% endblock %}
