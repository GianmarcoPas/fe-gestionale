{% extends "base.html" %}

{% block content %}
<style>
/* ============================================================
       FIX SCROLLBAR ORIZZONTALE (METODO SICURO)
       ============================================================ */
    
    /* 1. Rimuoviamo overflow hidden da html/body */
    html, body {
        overflow-x: clip !important; /* 'clip' taglia l'eccesso senza creare un nuovo scroll container */
        width: 100%;
        margin: 0;
    }



    /* 2. Assicuriamo che il main-content non forzi larghezze strane */
    .main-content {
        max-width: 100vw !important; /* Forza a non superare la larghezza finestra */
        padding-top: 0 !important; /* Rimuoviamo il padding-top per avere più spazio */
        padding-left: 10px !important; 
        padding-right: 10px !important;
        box-sizing: border-box; /* Include il padding nel calcolo larghezza */
        
        /* Overflow visible per il contenuto */
        overflow: visible !important; 
        transition: padding-right 0.3s; 
    }

<!--     /* Aggiungi questa regola specifica per quando l'overlay è aperto */
    .main-content.allow-scroll {
        overflow-x: auto !important;
    }	 -->

    .table-container {
        position: relative !important; 
        overflow: visible !important; 
        padding-bottom: 0 !important; 
    }
    /* Evita spazio “vuoto” extra in extra1 (scroll) */
    .table-container:not(.table-scroll-horizontal) {
        min-height: 600px;
    }

    /* FIX MOVIMENTO CARD: Blocca lo spostamento e mantiene l'ombra fissa */
    .oneui-card.table-container,
    .oneui-card.table-scroll-horizontal {
        transition: none !important; 
        transform: none !important; /* Cruciale: rimuove il contesto di trasformazione */
    }

    .oneui-card.table-container:hover,
    .oneui-card.table-scroll-horizontal:hover {
        transform: none !important; 
        box-shadow: 0 2px 20px rgba(0,0,0,0.03) !important; 
    }

    /* ECCEZIONE EXTRA 1: Scroll orizzontale interno */
    .table-scroll-horizontal {
        overflow-x: auto !important;
        /* NON usare position: relative per permettere a sticky di funzionare rispetto al viewport */
        padding-top: 0 !important;
        margin-top: 0 !important;
        padding-bottom: 0 !important;
    }
    
    /* Assicura che il container extra1 non abbia padding che sposta l'intestazione */
    #extra1TableScroll {
        padding: 0 !important;
        margin-top: 0 !important;
    }
    
    /* Rimuovi il padding della card per extra1 */
    #extra1TableScroll.oneui-card {
        padding: 0 !important;
    }
    
    /* EXTRA 1: sticky header come standard, ma con top dinamico sotto l'header pagina */
    .table-scroll-horizontal .table-expanded {
        margin-top: 0 !important;
        padding-top: 0 !important;
    }
    
    /* Extra1: header NON sticky (gestito da JavaScript con header fisso) */
    .table-scroll-horizontal .table-expanded thead th {
        position: static !important; /* Non sticky, gestito da JS */
        z-index: 10 !important;
        background-color: #F0F2F5 !important;
        color: #000 !important;
        border-bottom: none !important;
        box-shadow: inset 0 -3px #bbb;
        background-clip: padding-box;
        height: 50px !important;
        padding: 0 10px !important;
        vertical-align: middle !important;
        box-sizing: border-box;
        margin: 0 !important;
    }
    
    /* Header fisso per extra1 */
    #extra1StickyHeader {
        position: fixed;
        z-index: 100;
        display: none;
        background: #F0F2F5;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    #extra1StickyHeaderScroll {
        overflow-x: auto;
        overflow-y: hidden;
        /* Nascondi la scrollbar */
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE e Edge */
    }
    
    #extra1StickyHeaderScroll::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
    
    /* Nel header fisso extra1: i 5 th "col-fixed" devono restare sticky (left),
       gli altri possono restare static. */
    #extra1StickyHeader .table-expanded thead th {
        position: static !important;
        background-color: #F0F2F5 !important;
        color: #000 !important;
        border-bottom: none !important;
        box-shadow: inset 0 -3px #bbb;
        background-clip: padding-box;
        height: 50px !important;
        padding: 0 10px !important;
        vertical-align: middle !important;
        box-sizing: border-box;
        margin: 0 !important;
    }

    #extra1StickyHeader .table-expanded thead th.col-fixed {
        position: -webkit-sticky !important;
        position: sticky !important;
        top: 0 !important;
        z-index: 20 !important;
        background-color: #F0F2F5 !important;
    }
    
    /* Le colonne fisse devono avere z-index maggiore per stare sopra le altre */
    .table-scroll-horizontal .table-expanded thead .col-fixed {
        z-index: 11 !important;
        background-color: #F0F2F5 !important;
    }

    /* ============================================================
       2. RIGHE E CELLE
       ============================================================ */
    .oneui-table {
        margin: 0 !important;
        border-spacing: 0;
        width: 100%;
    }

    .oneui-table tr {
        height: 50px !important;
        max-height: 50px !important;
    }

    .oneui-table td {
        white-space: nowrap;
        padding: 0 10px !important; 
        font-size: 0.8rem !important; 
        height: 50px !important; 
        vertical-align: middle !important;
        line-height: 1.2 !important;
        border-bottom: 2px solid #ddd;
        box-sizing: border-box; 
    }

    /* Standard + Extra1: separatori più sottili (lavori e beni) */
    .lavori-admin-standard-table tbody td {
        border-bottom: 1px solid #ddd !important;
    }
    .table-scroll-horizontal .table-expanded tbody td {
        /* in extra1 la linea è un box-shadow: qui solo per coerenza (colore) */
        border-bottom: none !important;
    }

    /* ============================================================
       3. HEADER TABLE (MAIN TABLE)
       ============================================================ */
    .table-container > .oneui-table > thead > tr > th {
        position: -webkit-sticky;
        position: sticky;
        top: 160px; /* Spazio per header-section con barra ricerca/filtri */
        z-index: 10; 
        background-color: #F0F2F5 !important; 
        color: #000 !important;
        border-bottom: 3px solid #bbb;
        height: 50px !important; 
        padding: 0 10px !important;
        vertical-align: middle !important;
        box-sizing: border-box;
        margin: 0 !important;
    }

    /* Standard: linea sotto header sempre "attaccata" (come extra1) */
    .table-container > .lavori-admin-standard-table > thead > tr > th {
        border-bottom: none !important;
        box-shadow: inset 0 -3px #bbb;
        background-clip: padding-box;
        z-index: 20;
    }
    
    /* Assicura che extra1 abbia lo stesso stile del bordo sticky */
    .table-scroll-horizontal .table-expanded thead th {
        border-bottom: none !important;
        box-shadow: inset 0 -3px #bbb !important;
        background-clip: padding-box !important;
    }
    
    /* Focus Table: stesso comportamento sticky */
    #focusTable thead th {
        position: -webkit-sticky;
        position: sticky;
        top: 160px !important; /* Allineato con standard */
        z-index: 10;
        background-color: #F0F2F5 !important;
        color: #000 !important;
        border-bottom: none !important;
        box-shadow: inset 0 -3px #bbb;
        background-clip: padding-box;
        height: 50px !important;
        padding: 0 10px !important;
        vertical-align: middle !important;
        box-sizing: border-box;
        margin: 0 !important;
    }
    
    /* ============================================================
       5. BARRA RICERCA E FILTRI
       ============================================================ */
    .search-filters-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px 20px;
        margin-top: 10px;
        flex-wrap: wrap;
    }
    
    .search-bar {
        flex: 1;
        min-width: 200px;
        max-width: 400px;
        transition: all 0.3s ease;
        display: none;
    }
    
    .search-bar.active {
        display: block;
    }
    
    .search-bar input {
        width: 100%;
        padding: 8px 15px;
        font-size: 0.9rem;
        border: 1px solid #ddd;
        border-radius: 20px;
        background: #fff;
    }
    
    .filter-badge {
        display: inline-block;
        min-width: 18px;
        text-align: center;
        background: var(--primary);
        color: white;
        border-radius: 10px;
        padding: 2px 6px;
        font-size: 0.75rem;
        margin-left: 4px;
    }
    
    .filters-panel {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(25px);
        padding: 20px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        border: 1px solid rgba(255,255,255,0.5);
        margin-top: 10px;
        display: none;
        animation: slideDown 0.3s ease;
    }
    
    .filters-panel.active {
        display: block;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        font-size: 0.9rem;
    }
    
    .filter-menu {
        position: absolute;
        top: 100%;
        right: 0;
        z-index: 1001;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(25px);
        padding: 10px;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        border: 1px solid rgba(255,255,255,0.5);
        margin-top: 5px;
        min-width: 200px;
        display: none;
    }
    
    .filter-menu.active {
        display: block;
    }
    
    .filter-menu .menu-item {
        padding: 10px;
        cursor: pointer;
        border-radius: 8px;
        transition: background 0.2s;
    }
    
    .filter-menu .menu-item:hover {
        background: rgba(0, 122, 255, 0.1);
    }
    
    .filter-menu .menu-item.active {
        background: rgba(0, 122, 255, 0.15);
        color: var(--primary);
        font-weight: 600;
    }
    
    /* Nascondi righe filtrate */
    .oneui-table tbody tr.filtered-out {
        display: none !important;
    }

    /* ============================================================
       4. SIDE OVERLAY & HEADER (FIX SCROLLBAR INTELLIGENTE)
       ============================================================ */
    .side-overlay {
        position: absolute; 
        top: 0;
        right: 0;
        bottom: 0; 
        height: 100%; 
        width: 0;
        background: rgba(255, 255, 255, 0.98);
        border-left: 1px solid #ccc;
        box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
        z-index: 50; 
        
        /* Overflow visible */
        overflow: visible !important; 
        clip-path: inset(0 0 0 0); 
        
        /* FIX SCROLLBAR FANTASMA: 
           Quando è chiuso (width:0), diventa 'visibility: hidden' DOPO l'animazione.
           Così il browser sa che non c'è nulla da scrollare. */
        visibility: hidden;
        transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), right 0.4s cubic-bezier(0.25, 1, 0.5, 1), visibility 0s 0.4s;
        
        display: block;
        padding: 0 !important;
    }

    .side-overlay.active {
        width: 60%; 
        max-width: 900px;
        
        /* Quando si apre, diventa subito visibile */
        visibility: visible;
        transition: width 0.4s cubic-bezier(0.25, 1, 0.5, 1), right 0.4s cubic-bezier(0.25, 1, 0.5, 1);
    }
    
    /* Override per overlay procacciatori: usa larghezza dinamica invece di 60% */
    .overlay-procacciatori.active {
        width: auto !important;
        max-width: none !important;
    }

    /* Header Overlay - Allineato con la tabella principale */
    .side-overlay .overlay-table thead th {
        position: -webkit-sticky;
        position: sticky;
        top: 160px !important; /* Stesso top della tabella principale */
        z-index: 60; 
        height: 50px !important; 
        padding: 0 10px !important;
        vertical-align: middle !important;
        border-bottom: none !important;
        box-shadow: inset 0 -3px #bbb;
        box-sizing: border-box;
        margin: 0 !important;
        background-clip: padding-box;
        color: #000 !important;
    }
    
    /* Overlay Compensi - Colori Blu (meno marcati) */
    #overlayCompensi .overlay-table thead th {
        background-color: #f5f9ff !important;
    }
    
    #overlayCompensi .overlay-table tbody td {
        background-color: #f5f9ff !important;
    }
    
    #overlayCompensi .overlay-table thead th[colspan="2"] {
        background-color: #e3f2fd !important;
        color: var(--primary) !important;
    }
    
    /* Overlay Fatture - Colori Arancione (meno marcati) */
    #overlayFatture .overlay-table thead th {
        background-color: #fffaf5 !important;
    }
    
    #overlayFatture .overlay-table tbody td {
        background-color: #fffaf5 !important;
    }
    
    #overlayFatture .overlay-table thead th[colspan="2"] {
        background-color: #fff3e0 !important;
        color: #e67e22 !important;
    }
    
    /* Overlay Procacciatori - Colori Blu chiaro */
    #overlayProcacciatori .overlay-table thead th {
        background-color: #f0f4ff !important;
    }
    
    #overlayProcacciatori .overlay-table thead th:first-child {
        background-color: #e3f2fd !important;
        color: var(--primary) !important;
    }
    
    #overlayProcacciatori .overlay-table tbody td {
        background-color: #f0f4ff !important;
        text-align: center !important;
    }
    
    /* Overlay Procacciatori: larghezza dinamica - override della regola .side-overlay.active */
    #overlayProcacciatori.side-overlay.active {
        width: auto !important;
        max-width: none !important;
    }

    .side-overlay .overlay-table tbody tr {
        height: 50px !important;
    }
    .side-overlay .overlay-table tbody td {
        height: 50px !important;
        padding: 0 10px !important;
        vertical-align: middle !important;
        border-bottom: 1px solid #ddd !important;
    }

    /* UI Elements */
    .btn-close-header { background: none; border: none; font-size: 1.2rem; cursor: pointer; color: #333; float: right; }
    .overlay-title { font-weight: 800; text-transform: uppercase; margin-right: 10px; display: inline-block; line-height: 1; }
    .status-select { height: 26px !important; font-size: 0.75rem !important; }
    
    /* Evidenziazione riga selezionata */
    .oneui-table tbody tr.row-selected {
        background-color: rgba(0, 122, 255, 0.15) !important;
    }
    .oneui-table tbody tr.row-selected td {
        background-color: rgba(0, 122, 255, 0.15) !important;
    }
    .text-truncate { max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 50px !important; }
    .gruppo-interni { background-color: rgba(0, 122, 255, 0.03); }
    .gruppo-esterni { background-color: rgba(255, 159, 67, 0.05); }
    
    /* Stile celle fatture editabili */
    .cell-fattura {
        transition: background-color 0.2s ease;
    }
    .cell-fattura:hover {
        background-color: rgba(255, 159, 67, 0.15) !important;
    }
    
    /* Colori celle compensi e fatture in Focus Table */
    /* Colonne: N°(1), Cliente(2), Bene(3), Valore(4), Stato(5), C.FE(6), F.FE(7), C.AMIN(8), F.AMIN(9)... */
    /* Compensi (pari dopo stato): 6, 8, 10, 12, 14, 16, 18, 20, 22 - azzurrino */
    /* Fatture (dispari dopo stato): 7, 9, 11, 13, 15, 17, 19, 21, 23 - arancione */
    #focusTable tbody tr td.gruppo-interni:nth-child(6),
    #focusTable tbody tr td.gruppo-interni:nth-child(8),
    #focusTable tbody tr td.gruppo-interni:nth-child(10),
    #focusTable tbody tr td.gruppo-interni:nth-child(12),
    #focusTable tbody tr td.gruppo-esterni:nth-child(14),
    #focusTable tbody tr td.gruppo-esterni:nth-child(16),
    #focusTable tbody tr td.gruppo-esterni:nth-child(18),
    #focusTable tbody tr td.gruppo-esterni:nth-child(20),
    #focusTable tbody tr td.gruppo-esterni:nth-child(22) {
        background-color: #f5f9ff !important; /* Colore compensi (blu chiaro) */
    }
    
    #focusTable tbody tr td.gruppo-interni:nth-child(7),
    #focusTable tbody tr td.gruppo-interni:nth-child(9),
    #focusTable tbody tr td.gruppo-interni:nth-child(11),
    #focusTable tbody tr td.gruppo-interni:nth-child(13),
    #focusTable tbody tr td.gruppo-esterni:nth-child(15),
    #focusTable tbody tr td.gruppo-esterni:nth-child(17),
    #focusTable tbody tr td.gruppo-esterni:nth-child(19),
    #focusTable tbody tr td.gruppo-esterni:nth-child(21),
    #focusTable tbody tr td.gruppo-esterni:nth-child(23) {
        background-color: #fffaf5 !important; /* Colore fatture (arancione chiaro) */
    }
    
    /* Stesso per le intestazioni */
    #focusTable thead th.gruppo-interni:nth-child(6),
    #focusTable thead th.gruppo-interni:nth-child(8),
    #focusTable thead th.gruppo-interni:nth-child(10),
    #focusTable thead th.gruppo-interni:nth-child(12),
    #focusTable thead th.gruppo-esterni:nth-child(14),
    #focusTable thead th.gruppo-esterni:nth-child(16),
    #focusTable thead th.gruppo-esterni:nth-child(18),
    #focusTable thead th.gruppo-esterni:nth-child(20),
    #focusTable thead th.gruppo-esterni:nth-child(22) {
        background-color: #f5f9ff !important; /* Colore compensi (blu chiaro) */
    }
    
    #focusTable thead th.gruppo-interni:nth-child(7),
    #focusTable thead th.gruppo-interni:nth-child(9),
    #focusTable thead th.gruppo-interni:nth-child(11),
    #focusTable thead th.gruppo-interni:nth-child(13),
    #focusTable thead th.gruppo-esterni:nth-child(15),
    #focusTable thead th.gruppo-esterni:nth-child(17),
    #focusTable thead th.gruppo-esterni:nth-child(19),
    #focusTable thead th.gruppo-esterni:nth-child(21),
    #focusTable thead th.gruppo-esterni:nth-child(23) {
        background-color: #fffaf5 !important; /* Colore fatture (arancione chiaro) */
    }
</style>

<div class="header-section">
    <h1>{% if view_mode == 'extra2' or view_mode == 'focus_special' %}Compensi e fatture{% else %}Lavori Admin{% endif %}</h1>
    
    <!-- Barra Ricerca e Filtri -->
    <div class="search-filters-bar">
        <!-- Pulsante Ricerca -->
        <button class="pill-btn" id="btnSearch" onclick="toggleSearchBar()" style="display: flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 0.9rem;">
            <i class="bi bi-search"></i> <span class="btn-text">Ricerca</span>
        </button>
        
        <!-- Barra di ricerca (nascosta inizialmente) -->
        <div id="searchBar" class="search-bar">
            <input type="text" id="searchInput" class="one-ui-input" placeholder="Cerca cliente o bene..." 
                   oninput="performSearch(this.value)" style="width: 100%;">
        </div>
        
        <!-- Pulsante Filtri -->
        <button class="pill-btn" id="btnFilters" onclick="toggleFiltersPanel()" style="display: flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 0.9rem;">
            <i class="bi bi-funnel"></i> <span class="btn-text">Filtri</span>
            <span id="filterBadge" class="filter-badge" style="display: none;">0</span>
        </button>
        
        <!-- Pulsante Filtro Redattore -->
        <button class="pill-btn" id="btnRedattore" onclick="toggleRedattoreFilter()" style="display: flex; align-items: center; gap: 6px; padding: 8px 16px; font-size: 0.9rem; position: relative;">
            <i class="bi bi-person-badge"></i> <span class="btn-text">Redattore</span>
            <span id="redattoreFilterText" style="font-weight: normal; color: #666; font-size: 0.85rem;">Tutti</span>
        </button>
        
        <!-- Pulsante Reset Filtri -->
        <button class="pill-btn" id="btnResetFilters" onclick="resetAllFilters()" style="display: none; background: #f5f5f5; color: #666; padding: 8px 16px; font-size: 0.9rem;">
            <i class="bi bi-x-circle"></i> <span class="btn-text">Reset</span>
        </button>
        
        <!-- Pannello Filtri -->
        <div id="filtersPanel" class="filters-panel">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px;">
                <!-- Filtro Stato -->
                <div class="filter-group">
                    <label>Stato</label>
                    <select id="filterStato" class="one-ui-input" onchange="applyFilters()" style="width: 100%;">
                        <option value="">Tutti</option>
                        <option value="vuoto">Vuoto</option>
                        <option value="pec da inviare">Pec da Inviare</option>
                        <option value="da fatturare">Da Fatturare</option>
                        <option value="da incassare">Da Incassare</option>
                        <option value="incassata">Incassata</option>
                        <option value="chiusa">Chiusa</option>
                    </select>
                </div>
                
                <!-- Filtro Collaboratore -->
                <div class="filter-group">
                    <label>Collaboratore</label>
                    <input type="text" id="filterCollaboratore" class="one-ui-input" placeholder="Cerca collaboratore..." 
                           oninput="applyFilters()" style="width: 100%;">
                </div>
                
                <!-- Filtro Origine -->
                <div class="filter-group">
                    <label>Origine</label>
                    <select id="filterOrigine" class="one-ui-input" onchange="applyFilters()" style="width: 100%;">
                        <option value="">Tutte</option>
                        <option value="ext">Esterno</option>
                        <option value="AMIN">AMIN</option>
                        <option value="GALVAN">GALVAN</option>
                        <option value="FH">FH</option>
                        <option value="BIANC">BIANC</option>
                        <option value="DELOITTE">DELOITTE</option>
                    </select>
                </div>
                
                <!-- Filtro Con/Senza Revisore -->
                <div class="filter-group">
                    <label>Revisore</label>
                    <select id="filterRevisore" class="one-ui-input" onchange="applyFilters()" style="width: 100%;">
                        <option value="">Tutti</option>
                        <option value="si">Con Revisore</option>
                        <option value="no">Senza Revisore</option>
                    </select>
                </div>
                
                <!-- Filtro Con/Senza Caricamento -->
                <div class="filter-group">
                    <label>Caricamento</label>
                    <select id="filterCaricamento" class="one-ui-input" onchange="applyFilters()" style="width: 100%;">
                        <option value="">Tutti</option>
                        <option value="si">Con Caricamento</option>
                        <option value="no">Senza Caricamento</option>
                    </select>
                </div>
                
                <!-- Filtro Spese Amministrative -->
                <div class="filter-group">
                    <label>Spese Amm.</label>
                    <select id="filterSpeseAmm" class="one-ui-input" onchange="applyFilters()" style="width: 100%;">
                        <option value="">Tutti</option>
                        <option value="si">Con Spese</option>
                        <option value="no">Senza Spese</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Menu Filtro Redattore -->
        <div id="redattoreFilterMenu" class="filter-menu">
            <div class="menu-item" onclick="setRedattoreFilter('')">
                <i class="bi bi-check2"></i> Tutti
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item" onclick="setRedattoreFilter('AMIN')">
                <i class="bi bi-person"></i> AMIN
            </div>
            <div class="menu-item" onclick="setRedattoreFilter('GALVAN')">
                <i class="bi bi-person"></i> GALVAN
            </div>
            <div class="menu-item" onclick="setRedattoreFilter('FH')">
                <i class="bi bi-person"></i> FH
            </div>
            <div class="menu-item" onclick="setRedattoreFilter('BIANC')">
                <i class="bi bi-person"></i> BIANC
            </div>
            <div class="menu-item" onclick="setRedattoreFilter('DELOITTE')">
                <i class="bi bi-person"></i> DELOITTE
            </div>
        </div>
    </div>
</div>

{# ==================== MODALITÀ STANDARD (Default) ==================== #}
{% if view_mode == 'standard' %}

<div class="table-container oneui-card">

    <table class="oneui-table lavori-admin-standard-table">
        <thead>
            <tr>
                <th>N°</th>
                <th>Cliente</th>
                <th>Bene</th>
                <th>Valore</th>
                <th>Importo</th>
                <th class="col-data-offerta">Data Offerta</th>
                <th class="col-data-firma">Data Firma</th>

                <th>Revisore</th>
                <th>Caric.</th>

                <th>Origine</th>
                <th>Redattore</th>
                <th>Data PEC</th>
                <th>Stato</th>
            </tr>
        </thead>
        <tbody>
            {% if lavori_with_beni %}
            {% for item in lavori_with_beni %}
            {% set l = item.lavoro %}
            {% set num_beni = item.beni|length %}
            {% for bene in item.beni %}
            {% set bene_idx = loop.index0 %}
            <tr data-id="{{ l.id }}" data-bene-id="{{ bene.id }}"
                {% if bene_idx == 0 %}
                data-offerta-generated="{{ 1 if l.data_offerta else 0 }}"
                data-offerta-dirty="{{ 1 if l.offerta_dirty else 0 }}"
                data-offerta-rev="{{ l.offerta_revision or 0 }}"
                data-offerta-tipo="{{ (l.offerta_tipo or '') }}"
                data-cliente="{{ (l.cliente_nome or '')|lower }}"
                data-redattore="{{ (l.redattore or '')|upper }}"
                data-collaboratore="{{ (l.collaboratore or '')|lower }}"
                data-origine="{{ (l.origine or '')|lower }}"
                data-has-revisore="{{ 'si' if l.has_revisore else 'no' }}"
                data-has-caricamento="{{ 'si' if l.has_caricamento else 'no' }}"
                data-spese-amm="{{ 'si' if l.spese_amministrative else 'no' }}"
                oncontextmenu="showContextMenu(event, {{ l.id }})"
                {% endif %}
                data-bene="{{ (bene.descrizione or '')|lower }}"
                data-stato="{{ (bene.stato or 'vuoto')|lower }}">
                {% if bene_idx == 0 %}
                <td class="col-numero" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.numero }}</td>
                <td class="col-cliente" rowspan="{{ num_beni }}" style="vertical-align: middle;">{{ l.cliente_nome }}</td>
                {% endif %}
                <td class="col-bene-desc text-truncate">{{ bene.descrizione if bene.descrizione else '-' }}</td>
                <td class="col-bene-valore">€ {{ "{:,.2f}".format(bene.valore if bene.valore else 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="col-bene-importo">€ {{ "{:,.2f}".format(bene.importo_offerta if bene.importo_offerta else 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                {% if bene_idx == 0 %}
                <td rowspan="{{ num_beni }}" class="cell-data-offerta col-data-offerta" style="vertical-align: middle; text-align: center;">
                    {% if l.data_offerta %}
                        {% set mesi = ['','gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'] %}
                        {% if l.offerta_revision and l.offerta_revision > 0 %}R{{ l.offerta_revision }} {% endif %}
                        {{ l.data_offerta.strftime('%d') }}-{{ mesi[l.data_offerta.month] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td rowspan="{{ num_beni }}" class="cell-data-firma col-data-firma" style="vertical-align: middle; text-align: center;" ondblclick="openFirmaMenu(event, {{ l.id }})">
                    {% if l.firma_esito %}
                        {{ l.firma_esito }}
                    {% elif l.data_firma %}
                        {% set mesi = ['','gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'] %}
                        {{ l.data_firma.strftime('%d') }}-{{ mesi[l.data_firma.month] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="col-imp-rev" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">
                    {% if l.importo_revisione and l.importo_revisione > 0 %}
                    € {{ "{:,.0f}".format(l.importo_revisione).replace(",", ".") }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="col-imp-car" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">
                    {% if l.importo_caricamento and l.importo_caricamento > 0 %}
                    € {{ "{:,.0f}".format(l.importo_caricamento).replace(",", ".") }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="col-origine" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.origine or '-' }}</td>
                <td class="col-redattore" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.redattore or '-' }}</td>
                {% endif %}
                <td class="col-data-pec" style="text-align: center;" {% if bene.id %}ondblclick="editDataPec(event, {{ bene.id }})"{% endif %}>
                    {% if bene.data_pec %}
                        {% set mesi = ['','gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'] %}
                        {{ bene.data_pec.strftime('%d') }}-{{ mesi[bene.data_pec.month] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <select class="status-select stato-{{ (bene.stato or 'vuoto')|replace(' ', '-') }}"
                        onchange="updateBeneStato(this, {{ bene.id or 0 }})" {% if not bene.id %}disabled{% endif %}>
                        <option value="vuoto" {% if (bene.stato or 'vuoto')=='vuoto' %}selected{% endif %}>-</option>
                        <option value="pec da inviare" {% if (bene.stato or '')=='pec da inviare' %}selected{% endif %}>Pec da Inviare</option>
                        <option value="da fatturare" {% if (bene.stato or '')=='da fatturare' %}selected{% endif %}>Da Fatturare</option>
                        <option value="da incassare" {% if (bene.stato or '')=='da incassare' %}selected{% endif %}>Da Incassare</option>
                        <option value="incassata" {% if (bene.stato or '')=='incassata' %}selected{% endif %}>Incassata</option>
                        <option value="chiusa" {% if (bene.stato or '')=='chiusa' %}selected{% endif %}>Chiusa</option>
                    </select>
                </td>
            </tr>
            {% endfor %}
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="14" style="text-align:center; color:#999; padding: 30px;">
                    Nessun lavoro presente. Clicca + per aggiungere.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <div id="overlayCompensi" class="side-overlay">
        <table class="oneui-table overlay-table" style="width: 100%;">
            <thead>
                <tr>
                    <th colspan="2" style="background-color: #e3f2fd; color: var(--primary);">
                        <span class="overlay-title"><i class="bi bi-calculator"></i> Compensi</span>
                    </th>
                    <th>FE</th>
                    <th>AMIN</th>
                    <th>GALVAN</th>
                    <th>FH</th>
                    <th>BIANC</th>
                    <th>DEL</th>
                    <th>Ext</th>
                    <th>Rev</th>
                    <th>Caric.</th>
                </tr>
            </thead>
            <tbody>
                {% if lavori_with_beni %}
                {% for item in lavori_with_beni %}
                {% set l = item.lavoro %}
                {% set num_beni = item.beni|length %}
                {% for bene in item.beni %}
                {% set bene_idx = loop.index0 %}
                <tr>
                    {% if bene_idx == 0 %}
                    <td rowspan="{{ num_beni }}" style="font-weight:bold; width: 40px; background:#f9f9f9; vertical-align: middle; text-align: center;">{{ l.numero }}</td>
                    <td rowspan="{{ num_beni }}" class="text-truncate" style="max-width: 120px; background:#f9f9f9; vertical-align: middle;">{{ l.cliente_nome }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fe).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_amin).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_galvan).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fh).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_bianc).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_deloitte or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_ext).replace(",", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_revisore).replace(",", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_caricamento).replace(",", ".") }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <div id="overlayFatture" class="side-overlay">
        <table class="oneui-table overlay-table" style="width: 100%;">
            <thead>
                <tr>
                    <th colspan="2" style="background-color: #fff3e0; color: #e67e22;">
                        <span class="overlay-title"><i class="bi bi-receipt"></i> Fatture</span>
                    </th>
                    <th>FE</th>
                    <th>AMIN</th>
                    <th>GALVAN</th>
                    <th>FH</th>
                    <th>BIANC</th>
                    <th>DEL</th>
                    <th>Ext</th>
                    <th>Rev</th>
                    <th>Caric.</th>
                </tr>
            </thead>
            <tbody>
                {% if lavori_with_beni %}
                {% for item in lavori_with_beni %}
                {% set l = item.lavoro %}
                {% set num_beni = item.beni|length %}
                {% for bene in item.beni %}
                {% set bene_idx = loop.index0 %}
                <tr>
                    {% if bene_idx == 0 %}
                    <td rowspan="{{ num_beni }}" style="font-weight:bold; width: 40px; background:#f9f9f9; vertical-align: middle; text-align: center;">{{ l.numero }}</td>
                    <td rowspan="{{ num_beni }}" class="text-truncate" style="max-width: 120px; background:#f9f9f9; vertical-align: middle;">{{ l.cliente_nome }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_fe or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_amin or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_galvan or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_fh or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_bianc or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_deloitte or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_ext or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_revisore or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_caricamento or '-' }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <div id="overlayProcacciatori" class="side-overlay overlay-procacciatori">
        <table class="oneui-table overlay-table" style="width: 100%;">
            <thead>
                <tr>
                    <th style="background-color: #e3f2fd; color: var(--primary);">
                        <span class="overlay-title"><i class="bi bi-person-badge"></i> Procacciatori</span>
                    </th>
                    <th>Nome Esterno</th>
                </tr>
            </thead>
            <tbody>
                {% if lavori_with_beni %}
                {% for item in lavori_with_beni %}
                {% set l = item.lavoro %}
                {% set num_beni = item.beni|length %}
                {% for bene in item.beni %}
                {% set bene_idx = loop.index0 %}
                <tr>
                    {% if bene_idx == 0 %}
                    <td colspan="2" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">
                        {% if l.origine and l.origine.lower() == 'ext' %}
                            {{ l.nome_esterno or '-' }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<div class="bottom-floating-bar">
    <button class="pill-btn" onclick="openOverlay('compensi')">
        <i class="bi bi-calculator"></i> Compensi
    </button>

    <button class="btn-add-circle" onclick="openAddModal()">
        <i class="bi bi-plus-lg"></i>
    </button>

    <button class="pill-btn" onclick="openOverlay('fatture')">
        <i class="bi bi-receipt"></i> Fatture
    </button>

    <button class="pill-btn" onclick="openOverlay('procacciatori')">
        <i class="bi bi-person-badge"></i> Procacc.
    </button>
</div>



{# ==================== MODALITÀ EXTRA 1 (Scroll Orizzontale) ==================== #}
{% elif view_mode == 'extra1' %}

<div id="extra1TableScroll" class="table-container oneui-card table-scroll-horizontal">
    <table class="oneui-table table-expanded">
        <thead>
            <tr>
                <th class="col-fixed col-numero">N°</th>
                <th class="col-fixed col-cliente">Cliente</th>
                <th class="col-fixed col-bene-desc">Bene</th>
                <th class="col-fixed col-bene-valore">Valore</th>
                <th class="col-fixed col-bene-importo">Importo</th>

                <th class="col-data-offerta">Data Offerta</th>
                <th class="col-data-firma">Data Firma</th>

                <th>Revisore</th>
                <th>Caric.</th>

                <th>Origine</th>
                <th>Redattore</th>
                <th>Data PEC</th>

                <th class="col-compensi">C. FE</th>
                <th class="col-compensi">C. AMIN</th>
                <th class="col-compensi">C. GALVAN</th>
                <th class="col-compensi">C. FH</th>
                <th class="col-compensi">C. BIANC</th>
                <th class="col-compensi">C. DELOITTE</th>
                <th class="col-compensi">C. Ext</th>
                <th class="col-compensi">C. Rev</th>
                <th class="col-compensi">C. Car</th>

                <th class="col-fatture">F. FE</th>
                <th class="col-fatture">F. AMIN</th>
                <th class="col-fatture">F. GALVAN</th>
                <th class="col-fatture">F. FH</th>
                <th class="col-fatture">F. BIANC</th>
                <th class="col-fatture">F. DEL</th>
                <th class="col-fatture">F. Ext</th>
                <th class="col-fatture">F. Rev</th>
                <th class="col-fatture">F. Car</th>
                
                <th class="col-stato">Stato</th>
            </tr>
        </thead>
        <tbody>
            {% if lavori_with_beni %}
            {% for item in lavori_with_beni %}
            {% set l = item.lavoro %}
            {% set num_beni = item.beni|length %}
            {% for bene in item.beni %}
            {% set bene_idx = loop.index0 %}
            <tr data-id="{{ l.id }}" data-bene-id="{{ bene.id }}"
                {% if bene_idx == 0 %}
                data-offerta-generated="{{ 1 if l.data_offerta else 0 }}"
                data-offerta-dirty="{{ 1 if l.offerta_dirty else 0 }}"
                data-offerta-rev="{{ l.offerta_revision or 0 }}"
                data-offerta-tipo="{{ (l.offerta_tipo or '') }}"
                data-cliente="{{ (l.cliente_nome or '')|lower }}"
                data-redattore="{{ (l.redattore or '')|upper }}"
                data-collaboratore="{{ (l.collaboratore or '')|lower }}"
                data-origine="{{ (l.origine or '')|lower }}"
                data-has-revisore="{{ 'si' if l.has_revisore else 'no' }}"
                data-has-caricamento="{{ 'si' if l.has_caricamento else 'no' }}"
                data-spese-amm="{{ 'si' if l.spese_amministrative else 'no' }}"
                oncontextmenu="showContextMenu(event, {{ l.id }})"
                {% endif %}
                data-bene="{{ (bene.descrizione or '')|lower }}"
                data-stato="{{ (bene.stato or 'vuoto')|lower }}">
                {% if bene_idx == 0 %}
                <td class="col-fixed col-numero" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.numero }}</td>
                <td class="col-fixed col-cliente" rowspan="{{ num_beni }}" style="vertical-align: middle;">{{ l.cliente_nome }}</td>
                {% endif %}
                <td class="col-fixed col-bene-desc text-truncate">{{ bene.descrizione if bene.descrizione else '-' }}</td>
                <td class="col-fixed col-bene-valore">€ {{ "{:,.2f}".format(bene.valore if bene.valore else 0).replace(",", "X").replace(".",
                    ",").replace("X", ".") }}</td>
                <td class="col-fixed col-bene-importo">€ {{ "{:,.2f}".format(bene.importo_offerta if bene.importo_offerta else 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>

                {% if bene_idx == 0 %}
                <td rowspan="{{ num_beni }}" class="cell-data-offerta col-data-offerta" style="vertical-align: middle; text-align: center;">
                    {% if l.data_offerta %}
                        {% set mesi = ['','gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'] %}
                        {% if l.offerta_revision and l.offerta_revision > 0 %}R{{ l.offerta_revision }} {% endif %}
                        {{ l.data_offerta.strftime('%d') }}-{{ mesi[l.data_offerta.month] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td rowspan="{{ num_beni }}" class="cell-data-firma col-data-firma" style="vertical-align: middle; text-align: center;" ondblclick="openFirmaMenu(event, {{ l.id }})">
                    {% if l.firma_esito %}
                        {{ l.firma_esito }}
                    {% elif l.data_firma %}
                        {% set mesi = ['','gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'] %}
                        {{ l.data_firma.strftime('%d') }}-{{ mesi[l.data_firma.month] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td class="col-imp-rev" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">
                    {% if l.importo_revisione and l.importo_revisione > 0 %}
                    € {{ "{:,.0f}".format(l.importo_revisione).replace(",", ".") }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="col-imp-car" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">
                    {% if l.importo_caricamento and l.importo_caricamento > 0 %}
                    € {{ "{:,.0f}".format(l.importo_caricamento).replace(",", ".") }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td class="col-origine" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.origine or '-' }}</td>
                <td class="col-redattore" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.redattore or '-' }}</td>
                {% endif %}
                <td class="col-data-pec" style="text-align: center;" {% if bene.id %}ondblclick="editDataPec(event, {{ bene.id }})"{% endif %}>
                    {% if bene.data_pec %}
                        {% set mesi = ['','gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'] %}
                        {{ bene.data_pec.strftime('%d') }}-{{ mesi[bene.data_pec.month] }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                {% if bene_idx == 0 %}
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fe).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_amin).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_galvan).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fh).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_bianc).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_deloitte or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_ext).replace(",", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_revisore).replace(",", ".") }}</td>
                <td class="col-compensi" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_caricamento).replace(",", ".") }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'fe')" data-fattura-type="fe" data-lavoro-id="{{ l.id }}">{{ l.f_fe or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'amin')" data-fattura-type="amin" data-lavoro-id="{{ l.id }}">{{ l.f_amin or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'galvan')" data-fattura-type="galvan" data-lavoro-id="{{ l.id }}">{{ l.f_galvan or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'fh')" data-fattura-type="fh" data-lavoro-id="{{ l.id }}">{{ l.f_fh or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'bianc')" data-fattura-type="bianc" data-lavoro-id="{{ l.id }}">{{ l.f_bianc or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'deloitte')" data-fattura-type="deloitte" data-lavoro-id="{{ l.id }}">{{ l.f_deloitte or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'ext')" data-fattura-type="ext" data-lavoro-id="{{ l.id }}">{{ l.f_ext or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'revisore')" data-fattura-type="revisore" data-lavoro-id="{{ l.id }}">{{ l.f_revisore or '-' }}</td>
                <td class="col-fatture cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'caricamento')" data-fattura-type="caricamento" data-lavoro-id="{{ l.id }}">{{ l.f_caricamento or '-' }}</td>
                {% endif %}
                <td class="col-stato">
                    <select class="status-select stato-{{ (bene.stato or 'vuoto')|replace(' ', '-') }}"
                        onchange="updateBeneStato(this, {{ bene.id or 0 }})" {% if not bene.id %}disabled{% endif %}>
                        <option value="vuoto" {% if (bene.stato or 'vuoto')=='vuoto' %}selected{% endif %}>-</option>
                        <option value="pec da inviare" {% if (bene.stato or '')=='pec da inviare' %}selected{% endif %}>Pec da Inviare</option>
                        <option value="da fatturare" {% if (bene.stato or '')=='da fatturare' %}selected{% endif %}>Da Fatturare</option>
                        <option value="da incassare" {% if (bene.stato or '')=='da incassare' %}selected{% endif %}>Da Incassare</option>
                        <option value="incassata" {% if (bene.stato or '')=='incassata' %}selected{% endif %}>Incassata</option>
                        <option value="chiusa" {% if (bene.stato or '')=='chiusa' %}selected{% endif %}>Chiusa</option>
                    </select>
                </td>
            </tr>
            {% endfor %}
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="31" style="text-align:center; color:#999; padding: 30px;">
                    Nessun lavoro presente. Clicca + per aggiungere.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Header fisso per extra1 (gestito da JavaScript) -->
<div id="extra1StickyHeader" style="display: none;">
    <div id="extra1StickyHeaderScroll"></div>
</div>

<!-- Scrollbar orizzontale fissa in basso (sempre visibile) -->
<div id="extra1FixedHScroll" class="fixed-hscroll" aria-hidden="true">
    <div id="extra1FixedHScrollInner"></div>
</div>

<div class="bottom-floating-bar">
    <button class="btn-add-circle" onclick="openAddModal()">
        <i class="bi bi-plus-lg"></i>
    </button>
</div>

{# ==================== MODALITÀ EXTRA 2 (Focus) ==================== #}
{% elif view_mode == 'extra2' or view_mode == 'focus_special' %}

<div class="table-container oneui-card">

    <table class="oneui-table" id="focusTable">
        <thead>
            <tr>
                <th>N°</th>
                <th>Cliente</th>
                <th>Bene</th>
                <th>Valore</th>
                <th>Stato</th>
                <th class="gruppo-interni">C. FE</th>
                <th class="gruppo-interni">F. FE</th>
                <th class="gruppo-interni">C. AMIN</th>
                <th class="gruppo-interni">F. AMIN</th>
                <th class="gruppo-interni">C. GALVAN</th>
                <th class="gruppo-interni">F. GALVAN</th>
                <th class="gruppo-interni">C. FH</th>
                <th class="gruppo-interni">F. FH</th>
                <th class="gruppo-esterni" style="display:none;">C. BIANC</th>
                <th class="gruppo-esterni" style="display:none;">F. BIANC</th>
                <th class="gruppo-esterni" style="display:none;">C. DEL</th>
                <th class="gruppo-esterni" style="display:none;">F. DEL</th>
                <th class="gruppo-esterni" style="display:none;">C. Ext</th>
                <th class="gruppo-esterni" style="display:none;">F. Ext</th>
                <th class="gruppo-esterni" style="display:none;">C. Rev</th>
                <th class="gruppo-esterni" style="display:none;">F. Rev</th>
                <th class="gruppo-esterni" style="display:none;">C. Car</th>
                <th class="gruppo-esterni" style="display:none;">F. Car</th>
            </tr>
        </thead>
        <tbody>
            {% if lavori_with_beni %}
            {% for item in lavori_with_beni %}
            {% set l = item.lavoro %}
            {% set num_beni = item.beni|length %}
            {% for bene in item.beni %}
            {% set bene_idx = loop.index0 %}
            <tr data-id="{{ l.id }}" data-bene-id="{{ bene.id }}"
                {% if bene_idx == 0 %}
                data-offerta-generated="{{ 1 if l.data_offerta else 0 }}"
                data-offerta-dirty="{{ 1 if l.offerta_dirty else 0 }}"
                data-offerta-rev="{{ l.offerta_revision or 0 }}"
                data-offerta-tipo="{{ (l.offerta_tipo or '') }}"
                data-cliente="{{ (l.cliente_nome or '')|lower }}"
                data-redattore="{{ (l.redattore or '')|upper }}"
                data-collaboratore="{{ (l.collaboratore or '')|lower }}"
                data-origine="{{ (l.origine or '')|lower }}"
                data-has-revisore="{{ 'si' if l.has_revisore else 'no' }}"
                data-has-caricamento="{{ 'si' if l.has_caricamento else 'no' }}"
                data-spese-amm="{{ 'si' if l.spese_amministrative else 'no' }}"
                oncontextmenu="showContextMenu(event, {{ l.id }})"
                {% endif %}
                data-bene="{{ (bene.descrizione or '')|lower }}"
                data-stato="{{ (bene.stato or 'vuoto')|lower }}">
                {% if bene_idx == 0 %}
                <td class="col-numero" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.numero }}</td>
                <td class="col-cliente" rowspan="{{ num_beni }}" style="vertical-align: middle;">{{ l.cliente_nome }}</td>
                {% endif %}
                <td class="col-bene-desc text-truncate">{{ bene.descrizione if bene.descrizione else '-' }}</td>
                <td class="col-bene-valore">€ {{ "{:,.2f}".format(bene.valore if bene.valore else 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td>
                    <select class="status-select stato-{{ (bene.stato or 'vuoto')|replace(' ', '-') }}"
                        onchange="updateBeneStato(this, {{ bene.id or 0 }})" {% if not bene.id %}disabled{% endif %}>
                        <option value="vuoto" {% if (bene.stato or 'vuoto')=='vuoto' %}selected{% endif %}>-</option>
                        <option value="pec da inviare" {% if (bene.stato or '')=='pec da inviare' %}selected{% endif %}>Pec da Inviare</option>
                        <option value="da fatturare" {% if (bene.stato or '')=='da fatturare' %}selected{% endif %}>Da Fatturare</option>
                        <option value="da incassare" {% if (bene.stato or '')=='da incassare' %}selected{% endif %}>Da Incassare</option>
                        <option value="incassata" {% if (bene.stato or '')=='incassata' %}selected{% endif %}>Incassata</option>
                        <option value="chiusa" {% if (bene.stato or '')=='chiusa' %}selected{% endif %}>Chiusa</option>
                    </select>
                </td>
                {% if bene_idx == 0 %}
                <td class="gruppo-interni" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fe).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="gruppo-interni cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'fe')" data-fattura-type="fe" data-lavoro-id="{{ l.id }}">{{ l.f_fe or '-' }}</td>
                <td class="gruppo-interni" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_amin).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="gruppo-interni cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'amin')" data-fattura-type="amin" data-lavoro-id="{{ l.id }}">{{ l.f_amin or '-' }}</td>
                <td class="gruppo-interni" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_galvan).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="gruppo-interni cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'galvan')" data-fattura-type="galvan" data-lavoro-id="{{ l.id }}">{{ l.f_galvan or '-' }}</td>
                <td class="gruppo-interni" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fh).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="gruppo-interni cell-fattura" rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'fh')" data-fattura-type="fh" data-lavoro-id="{{ l.id }}">{{ l.f_fh or '-' }}</td>
                <td class="gruppo-esterni" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_bianc).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="gruppo-esterni cell-fattura" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'bianc')" data-fattura-type="bianc" data-lavoro-id="{{ l.id }}">{{ l.f_bianc or '-' }}</td>
                <td class="gruppo-esterni" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_deloitte or 0).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                <td class="gruppo-esterni" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: center;">{{ '-' }}</td>
                <td class="gruppo-esterni" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_ext).replace(",", ".") }}</td>
                <td class="gruppo-esterni cell-fattura" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'ext')" data-fattura-type="ext" data-lavoro-id="{{ l.id }}">{{ l.f_ext or '-' }}</td>
                <td class="gruppo-esterni" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_revisore).replace(",", ".") }}</td>
                <td class="gruppo-esterni cell-fattura" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'revisore')" data-fattura-type="revisore" data-lavoro-id="{{ l.id }}">{{ l.f_revisore or '-' }}</td>
                <td class="gruppo-esterni" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_caricamento).replace(",", ".") }}</td>
                <td class="gruppo-esterni cell-fattura" rowspan="{{ num_beni }}" style="display:none; vertical-align: middle; text-align: center; cursor: pointer;" ondblclick="editFattura(event, {{ l.id }}, 'caricamento')" data-fattura-type="caricamento" data-lavoro-id="{{ l.id }}">{{ l.f_caricamento or '-' }}</td>
                {% endif %}
            </tr>
            {% endfor %}
            {% endfor %}
            {% else %}
            <tr>
                <td colspan="21" style="text-align:center; color:#999; padding: 30px;">
                    Nessun lavoro presente. Clicca + per aggiungere.
                </td>
            </tr>
            {% endif %}
        </tbody>
    </table>

    <div id="overlayCompensi" class="side-overlay">
        <table class="oneui-table overlay-table" style="width: 100%;">
            <thead>
                <tr>
                    <th colspan="2" style="background-color: #e3f2fd; color: var(--primary);">
                        <span class="overlay-title"><i class="bi bi-calculator"></i> Compensi</span>
                    </th>
                    <th>FE</th>
                    <th>AMIN</th>
                    <th>GALVAN</th>
                    <th>FH</th>
                    <th>BIANC</th>
                    <th>Ext</th>
                    <th>Rev</th>
                    <th>Caric.</th>
                </tr>
            </thead>
            <tbody>
                {% if lavori_with_beni %}
                {% for item in lavori_with_beni %}
                {% set l = item.lavoro %}
                {% set num_beni = item.beni|length %}
                {% for bene in item.beni %}
                {% set bene_idx = loop.index0 %}
                <tr>
                    {% if bene_idx == 0 %}
                    <td rowspan="{{ num_beni }}" style="font-weight:bold; width: 40px; background:#f9f9f9; vertical-align: middle; text-align: center;">{{ l.numero }}</td>
                    <td rowspan="{{ num_beni }}" class="text-truncate" style="max-width: 120px; background:#f9f9f9; vertical-align: middle;">{{ l.cliente_nome }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fe).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_amin).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_galvan).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_fh).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.2f}".format(l.c_bianc).replace(",", "X").replace(".", ",").replace("X", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_ext).replace(",", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_revisore).replace(",", ".") }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: right;">€ {{ "{:,.0f}".format(l.c_caricamento).replace(",", ".") }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

    <div id="overlayFatture" class="side-overlay">
        <table class="oneui-table overlay-table" style="width: 100%;">
            <thead>
                <tr>
                    <th colspan="2" style="background-color: #fff3e0; color: #e67e22;">
                        <span class="overlay-title"><i class="bi bi-receipt"></i> Fatture</span>
                    </th>
                    <th>FE</th>
                    <th>AMIN</th>
                    <th>GALVAN</th>
                    <th>FH</th>
                    <th>BIANC</th>
                    <th>Ext</th>
                    <th>Rev</th>
                    <th>Caric.</th>
                </tr>
            </thead>
            <tbody>
                {% if lavori_with_beni %}
                {% for item in lavori_with_beni %}
                {% set l = item.lavoro %}
                {% set num_beni = item.beni|length %}
                {% for bene in item.beni %}
                {% set bene_idx = loop.index0 %}
                <tr>
                    {% if bene_idx == 0 %}
                    <td rowspan="{{ num_beni }}" style="font-weight:bold; width: 40px; background:#f9f9f9; vertical-align: middle; text-align: center;">{{ l.numero }}</td>
                    <td rowspan="{{ num_beni }}" class="text-truncate" style="max-width: 120px; background:#f9f9f9; vertical-align: middle;">{{ l.cliente_nome }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_fe or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_amin or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_galvan or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_fh or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_bianc or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_ext or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_revisore or '-' }}</td>
                    <td rowspan="{{ num_beni }}" style="vertical-align: middle; text-align: center;">{{ l.f_caricamento or '-' }}</td>
                    {% endif %}
                </tr>
                {% endfor %}
                {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>

</div>

<div class="bottom-floating-bar">
    <button class="pill-btn" id="btnToggleGruppo" onclick="toggleGruppoFocus()">
        <i class="bi bi-arrow-left-right"></i> Passa a Esterni
    </button>
</div>

{% endif %}

{% if view_mode == 'extra1' %}
<div style="height: 0;"></div>
{% else %}
<div style="height: 120px;"></div>
{% endif %}

<div id="addModal" class="modal-overlay">
    <div class="modal-glass modal-large">
        <div class="modal-header">
            <h3 id="modalTitle">Nuovo Lavoro</h3>
            <button class="btn-close" onclick="closeAddModal()"><i class="bi bi-x-lg"></i></button>
        </div>

        <div id="alertCompensi" class="alert error" style="display:none;">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <span id="alertCompensiText">Attenzione: alcuni compensi risultano negativi!</span>
        </div>

        <form action="{{ url_for('main.add_lavoro_admin') }}" method="POST" id="formAddLavoro"
            onsubmit="return validateForm()">
            <input type="hidden" name="lavoro_id" id="lavoroId" value="">

            <div class="form-section">
                <h4><i class="bi bi-person-lines-fill"></i> Anagrafica Cliente</h4>
                <div class="form-row">
                    <div class="input-group flex-2">
                        <label>Cliente</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" name="cliente_nome" id="inpCliente" class="one-ui-input" required
                                placeholder="Cerca o inserisci..." oninput="searchCliente(this.value)"
                                onfocus="showSuggestions()" autocomplete="off">
                            <div id="clienteSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>
                    <div class="input-group flex-1">
                        <label>P. IVA</label>
                        <input type="text" name="cliente_piva" id="inpPiva" class="one-ui-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group flex-2">
                        <label>Indirizzo</label>
                        <input type="text" name="cliente_indirizzo" id="inpIndirizzo" class="one-ui-input">
                    </div>
                    <div class="input-group" style="flex: 0.5;">
                        <label>Civico</label>
                        <input type="text" name="cliente_civico" id="inpCivico" class="one-ui-input">
                    </div>
                    <div class="input-group" style="flex: 0.5;">
                        <label>CAP</label>
                        <input type="text" name="cliente_cap" id="inpCap" class="one-ui-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="input-group flex-1">
                        <label>Comune</label>
                        <input type="text" name="cliente_comune" id="inpComune" class="one-ui-input">
                    </div>
                    <div class="input-group" style="flex: 0.3;">
                        <label>Prov.</label>
                        <input type="text" name="cliente_provincia" id="inpProv" class="one-ui-input" maxlength="2">
                    </div>
                    <div class="input-group flex-2">
                        <label>PEC</label>
                        <input type="email" name="cliente_pec" id="inpPec" class="one-ui-input">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h4><i class="bi bi-briefcase-fill"></i> Ordine di Lavoro</h4>

                <div id="beniContainer">
                    <div class="bene-row form-row" data-index="0">
                        <input type="hidden" name="beni[0][id]" class="bene-id" value="">
                        <div class="input-group flex-2">
                            <label>Bene (Descrizione)</label>
                            <input type="text" name="beni[0][descrizione]" class="one-ui-input bene-desc" required>
                        </div>
                        <div class="input-group flex-1">
                            <label>Valore Bene (€)</label>
                            <input type="text" name="beni[0][valore]" class="one-ui-input currency-input bene-valore"
                                oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                        </div>
                        <div class="input-group flex-1">
                            <label>Importo Offerta (€)</label>
                            <input type="text" name="beni[0][importo_offerta]" class="one-ui-input currency-input bene-importo"
                                oninput="formatCurrencyInput(this); calcolaTotaleOfferta();" onblur="formatCurrencyBlur(this); calcolaTotaleOfferta();">
                        </div>
                        <div class="input-group btn-remove-group" style="display:none;">
                            <button type="button" class="btn-remove-bene" onclick="removeBene(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <button type="button" class="btn-add-bene" onclick="addBene()">
                    <i class="bi bi-plus-circle"></i> Aggiungi Bene
                </button>

                <div class="form-row align-items-end">

                    <div class="input-group flex-1">
                        <label>Totale Offerta 4.0</label>
                        <div class="currency-wrapper">
                            <span class="currency-symbol">€</span>
                            <input type="text" name="importo_offerta" id="impOfferta"
                                class="one-ui-input has-symbol currency-input"
                                readonly style="background-color: #f5f5f5; cursor: not-allowed;">
                        </div>
                    </div>

                    <div class="input-group flex-1">
                        <div class="switch-group">
                            <span class="switch-label">Spese ammin. 6%</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="chkSpeseAmm" name="spese_amministrative"
                                    onchange="calcolaCompensi()">
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="form-row">

                    <div class="input-group flex-1">
                        <div class="switch-group">
                            <span class="switch-label">Revisione</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="chkRevisione" name="has_revisore" onchange="toggleSpese()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div id="divImportoRevisione" class="sub-input" style="display:none; margin-top: 10px;">
                            <label style="font-size: 12px; margin-bottom: 4px;">Nome Revisore</label>
                            <div class="autocomplete-wrapper" style="margin-bottom: 8px;">
                                <input type="text" name="nome_revisore" id="inpNomeRevisore" class="one-ui-input compact"
                                    placeholder="Nome revisore" autocomplete="off"
                                    oninput="searchRevisori(this.value)">
                                <div id="revisoreSuggestions" class="suggestions-list"></div>
                            </div>
                            <label style="font-size: 12px; margin-bottom: 4px;">Importo</label>
                            <div class="currency-wrapper">
                                <span class="currency-symbol">€</span>
                                <input type="text" name="importo_revisione" id="impRevisione"
                                    class="one-ui-input has-symbol compact currency-input" placeholder="0,00"
                                    oninput="formatCurrencyInput(this); calcolaCompensi();"
                                    onblur="formatCurrencyBlur(this); calcolaCompensi();">
                            </div>
                        </div>
                    </div>

                    <div class="input-group flex-1">
                        <div class="switch-group">
                            <span class="switch-label">Caricamento</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="chkCaricamento" name="has_caricamento"
                                    onchange="toggleSpese()">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div id="divImportoCaricamento" class="sub-input" style="display:none; margin-top: 10px;">
                            <label style="font-size: 12px; margin-bottom: 4px;">Nome Caricamento</label>
                            <div class="autocomplete-wrapper" style="margin-bottom: 8px;">
                                <input type="text" name="nome_caricamento" id="inpNomeCaricamento" class="one-ui-input compact"
                                    placeholder="Nome caricamento" autocomplete="off"
                                    oninput="searchCaricamenti(this.value)">
                                <div id="caricamentoSuggestions" class="suggestions-list"></div>
                            </div>
                            <label style="font-size: 12px; margin-bottom: 4px;">Importo</label>
                            <div class="currency-wrapper">
                                <span class="currency-symbol">€</span>
                                <input type="text" name="importo_caricamento" id="impCaricamento"
                                    class="one-ui-input has-symbol compact currency-input" placeholder="0,00"
                                    oninput="formatCurrencyInput(this); calcolaCompensi();"
                                    onblur="formatCurrencyBlur(this); calcolaCompensi();">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="input-group flex-1">
                        <label>Origine</label>
                        <select name="origine" id="selOrigine" class="one-ui-input"
                            onchange="toggleExtInput(); calcolaCompensi();">
                            <option value="">-- Seleziona --</option>
                            <option value="AMIN">AMIN</option>
                            <option value="GALVAN">GALVAN</option>
                            <option value="FH">FH</option>
                            <option value="BIANC">BIANC</option>
                            <option value="DELOITTE">DELOITTE</option>
                            <option value="ext">Esterno</option>
                        </select>
                    </div>
                    <div class="input-group flex-1" id="divNomeEsterno" style="display:none;">
                        <label>Nome Esterno</label>
                        <div class="autocomplete-wrapper">
                            <input type="text" name="nome_esterno" id="inpEsterno" class="one-ui-input"
                                placeholder="Cerca o inserisci..." oninput="searchEsterno(this.value)"
                                onfocus="showSuggestionsEsterno()" autocomplete="off">
                            <div id="esternoSuggestions" class="suggestions-dropdown"></div>
                        </div>
                    </div>

                    <div class="input-group flex-1">
                        <label>Redattore</label>
                        <select name="redattore" id="selRedattore" class="one-ui-input" onchange="toggleExtInput(); calcolaCompensi();">
                            <option value="">-- Seleziona --</option>
                            <option value="AMIN">AMIN</option>
                            <option value="GALVAN">GALVAN</option>
                            <option value="BIANC">BIANC</option>
                            <option value="DELOITTE">DELOITTE</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="input-group flex-1">
                        <label>Collaboratore</label>
                        <input type="text" name="collaboratore" id="inpCollaboratore" class="one-ui-input">
                    </div>
                </div>
            </div>

            <div class="form-section result-section">
                <h4><i class="bi bi-calculator"></i> Ripartizione Compensi</h4>

                <div class="form-row toggles-row" id="togglesRevCar" style="display:none; margin-bottom: 15px;">
                    <div id="revOptions" class="toggle-option" style="display:none;">
                        <span>Compenso Revisore:</span>
                        <select id="revType" name="rev_type" class="small-select" onchange="calcolaCompensi()">
                            <option value="perc">%</option>
                            <option value="euro">€</option>
                        </select>
                        <input type="text" id="revVal" name="rev_val" value="0" class="small-input" oninput="calcolaCompensi()">
                    </div>
                    <div id="carOptions" class="toggle-option" style="display:none;">
                        <span>Compenso Caricamento:</span>
                        <select id="carType" name="car_type" class="small-select" onchange="calcolaCompensi()">
                            <option value="perc">%</option>
                            <option value="euro">€</option>
                        </select>
                        <input type="text" id="carVal" name="car_val" value="0" class="small-input" oninput="calcolaCompensi()">
                    </div>
                    <div id="extOptions" class="toggle-option" style="display:none;">
                        <span>Compenso Esterno:</span>
                        <select id="extType" name="ext_type" class="small-select" onchange="calcolaCompensi()">
                            <option value="perc">%</option>
                            <option value="euro">€</option>
                        </select>
                        <input type="text" id="extVal" name="ext_val" value="0" class="small-input" oninput="calcolaCompensi()">
                    </div>
                </div>

                <div class="compensi-grid">
                    <div class="c-item" id="fieldFE">
                        <label>FE (15% + Sp.Amm.)</label>
                        <input type="text" name="c_fe" id="c_fe" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="c-item" id="fieldAmin">
                        <label>AMIN</label>
                        <input type="text" name="c_amin" id="c_amin" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="c-item" id="fieldGalvan">
                        <label>GALVAN</label>
                        <input type="text" name="c_galvan" id="c_galvan" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="c-item" id="fieldFH">
                        <label>FH</label>
                        <input type="text" name="c_fh" id="c_fh" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>

                    <div class="c-item" id="fieldBianc" style="display:none;">
                        <label>BIANC</label>
                        <input type="text" name="c_bianc" id="c_bianc" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="c-item" id="fieldDeloitte" style="display:none;">
                        <label>DELOITTE</label>
                        <input type="text" name="c_deloitte" id="c_deloitte" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="c-item" id="fieldExt" style="display:none;">
                        <label>Esterno (10%)</label>
                        <input type="text" name="c_ext" id="c_ext" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="c-item" id="fieldRev" style="display:none;">
                        <label>Revisore</label>
                        <input type="text" name="c_revisore" id="c_revisore" class="one-ui-input compact currency-input"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="c-item" id="fieldCar" style="display:none;">
                        <label>Caricamento</label>
                        <input type="text" name="c_caricamento" id="c_caricamento"
                            class="one-ui-input compact currency-input" oninput="formatCurrencyInput(this)"
                            onblur="formatCurrencyBlur(this)">
                    </div>
                </div>
            </div>

            <button type="submit" class="btn-primary-oneui mt-3" id="btnSaveLavoro">Salva Lavoro</button>
            <button type="button" class="btn-primary-oneui mt-2" id="btnRevisionaOfferta"
                style="display:none; width:100%;"
                onclick="revisionaOffertaDaForm()">
                Revisiona Offerta
            </button>
        </form>
    </div>
</div>

<div id="contextMenu" class="context-menu glass-panel" onclick="event.stopPropagation();">
    <div class="menu-item" onclick="editLavoro(currentLavoroId)">
        <i class="bi bi-pencil-fill"></i> Modifica
    </div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="openGeneraOffertaModal(currentLavoroId)">
        <i class="bi bi-file-earmark-word-fill"></i> <span id="menuGeneraOffertaLabel">Genera Offerta</span>
    </div>
    <div class="menu-divider"></div>
    <div class="menu-item delete" onclick="deleteLavoro(currentLavoroId)">
        <i class="bi bi-trash-fill"></i> Elimina
    </div>
</div>

<!-- Modal scelta generazione offerta -->
<div id="generaOffertaModal" class="modal-overlay">
    <div class="modal-glass" style="max-width: 520px;">
        <div class="modal-header">
            <h3>Genera Offerta</h3>
            <button type="button" class="modal-close" onclick="closeGeneraOffertaModal()">×</button>
        </div>
        <div class="modal-body" style="padding: 20px;">
            <p style="margin-top: 0;">Seleziona il tipo di offerta da generare:</p>
            <div style="display:flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn-primary-oneui" style="flex:1;" onclick="confirmGeneraOfferta('old')">
                    Industria 4.0 OLD
                </button>
                <button type="button" class="btn-primary-oneui" style="flex:1;" onclick="confirmGeneraOfferta('iper')">
                    Industria 4.0 IPERAMMORTAMENTO
                </button>
            </div>
            <div style="margin-top: 14px; color:#666; font-size: 0.9rem;">
                Il sistema sceglierà automaticamente il template `_amm` se nel lavoro sono state spuntate le spese amministrative.
            </div>
        </div>
    </div>
</div>

<!-- Mini menu Data Firma -->
<div id="firmaMenu" class="firma-menu" onclick="event.stopPropagation();">
    <div class="menu-item" onclick="firmaSetMode('date')">Inserisci data firma</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="firmaSetMode('OK')">OK</div>
    <div class="menu-item" onclick="firmaSetMode('AUTORIZZ.')">AUTORIZZ.</div>
    <div class="menu-divider"></div>
    <div class="menu-item" onclick="firmaSetMode('clear')">Svuota</div>
</div>

<form id="deleteForm" method="POST" style="display:none;"></form>

<script>
    /* ==================== VARIABILI GLOBALI ==================== */
    let currentLavoroId = null;
    let showingEsterni = false;
    let clientiCache = [];
    let esterniCache = []; // Cache per nomi esterni
    let beneIndex = 1;

    /* ==================== BLOCCA INVIO SU ENTER E VALIDA ==================== */
    document.getElementById('formAddLavoro').addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
            e.preventDefault();

            // 1. Forza l'evento BLUR sull'elemento attuale
            e.target.blur();

            // 2. Cerca il prossimo campo e dacci il focus
            const inputs = Array.from(this.querySelectorAll('input:not([type="hidden"]):not([type="checkbox"]), select, textarea'));
            const currentIndex = inputs.indexOf(e.target);

            setTimeout(() => {
                if (currentIndex > -1 && currentIndex < inputs.length - 1) {
                    inputs[currentIndex + 1].focus();
                }
            }, 10);
        }
    });

    /* ==================== FORMATTAZIONE VALUTA (MANUALE E FORZATA) ==================== */

    function parseCurrency(value) {
        if (!value) return 0;
        let str = value.toString();

        // Gestione intelligente: se l'utente scrive "1000.50" (punto come decimale)
        if (str.indexOf('.') !== -1 && str.indexOf(',') === -1) {
            const parts = str.split('.');
            if (parts[parts.length - 1].length === 2 || parts[0].length >= 4) {
                str = str.replace('.', ',');
            }
        }

        str = str.replace(/\./g, '');
        str = str.replace(',', '.');

        return parseFloat(str) || 0;
    }

    function formatCurrency(value) {
        if (value === null || value === '' || isNaN(value)) return '';

        let num = parseFloat(value);
        let fixed = num.toFixed(2);
        let parts = fixed.split('.');

        parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        return parts.join(',');
    }

    function formatCurrencyInput(input) {
        let value = input.value.replace(/[^\d.,]/g, '');
        input.value = value;
    }

    function formatCurrencyBlur(input) {
        let value = parseCurrency(input.value);
        if (value !== 0 || input.value !== '') {
            input.value = formatCurrency(value);
        } else if (input.value !== '') {
            input.value = '0,00';
        }

        // Ricalcola totali se necessario
        if (input.name === 'importo_offerta' ||
            input.name === 'importo_revisione' ||
            input.name === 'importo_caricamento' ||
            input.classList.contains('bene-valore')) {
            calcolaCompensi();
        }
    }

    function setCurrencyValue(inputId, value) {
        const input = document.getElementById(inputId);
        if (input) {
            input.value = formatCurrency(value);
            if (value < 0) {
                input.classList.add('negative-value');
            } else {
                input.classList.remove('negative-value');
            }
        }
    }

    /* ==================== AUTOCOMPLETE CLIENTI ==================== */
    async function searchCliente(query) {
        const suggestionsDiv = document.getElementById('clienteSuggestions');
        if (query.length < 1) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        try {
            const res = await fetch(`/api/clienti?q=${encodeURIComponent(query)}`);
            clientiCache = await res.json();
            if (clientiCache.length > 0) {
                suggestionsDiv.innerHTML = clientiCache.map((c, i) => `
                <div class="suggestion-item" onclick="selectCliente(${i})">
                    <strong>${c.nome}</strong>
                    ${c.p_iva ? `<small>P.IVA: ${c.p_iva}</small>` : ''}
                </div>
            `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        } catch (err) {
            console.error('Errore fetch clienti:', err);
            suggestionsDiv.style.display = 'none';
        }
    }

    function selectCliente(index) {
        const c = clientiCache[index];
        if (c) {
            document.getElementById('inpCliente').value = c.nome;
            document.getElementById('inpPiva').value = c.p_iva || '';
            document.getElementById('inpIndirizzo').value = c.indirizzo || '';
            document.getElementById('inpCivico').value = c.civico || '';
            document.getElementById('inpCap').value = c.cap || '';
            document.getElementById('inpComune').value = c.comune || '';
            document.getElementById('inpProv').value = c.provincia || '';
            document.getElementById('inpPec').value = c.pec || '';
        }
        document.getElementById('clienteSuggestions').style.display = 'none';
    }

    function showSuggestions() {
        const query = document.getElementById('inpCliente').value;
        if (query.length >= 1 && clientiCache.length > 0) {
            document.getElementById('clienteSuggestions').style.display = 'block';
        }
    }

    /* ==================== AUTOCOMPLETE ESTERNI (NUOVO) ==================== */
    async function searchEsterno(query) {
        const suggestionsDiv = document.getElementById('esternoSuggestions');
        if (query.length < 1) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        try {
            const res = await fetch(`/api/esterni?q=${encodeURIComponent(query)}`);
            esterniCache = await res.json(); // Array di stringhe ['Nome1', 'Nome2']
            if (esterniCache.length > 0) {
                suggestionsDiv.innerHTML = esterniCache.map((nome, i) => `
                <div class="suggestion-item" onclick="selectEsterno(${i})">
                    <strong>${nome}</strong>
                </div>
            `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        } catch (err) {
            console.error('Errore fetch esterni:', err);
            suggestionsDiv.style.display = 'none';
        }
    }

    function selectEsterno(index) {
        const nome = esterniCache[index];
        if (nome) {
            document.getElementById('inpEsterno').value = nome;
        }
        document.getElementById('esternoSuggestions').style.display = 'none';
    }

    function showSuggestionsEsterno() {
        const query = document.getElementById('inpEsterno').value;
        if (query.length >= 1 && esterniCache.length > 0) {
            document.getElementById('esternoSuggestions').style.display = 'block';
        }
    }

    /* ==================== AUTOCOMPLETE REVISORI ==================== */
    let revisoriCache = [];
    async function searchRevisori(query) {
        const suggestionsDiv = document.getElementById('revisoreSuggestions');
        if (query.length < 1) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        try {
            const res = await fetch(`/api/revisori?q=${encodeURIComponent(query)}`);
            revisoriCache = await res.json();
            if (revisoriCache.length > 0) {
                suggestionsDiv.innerHTML = revisoriCache.map((nome, i) => `
                <div class="suggestion-item" onclick="selectRevisore(${i})">
                    <strong>${nome}</strong>
                </div>
            `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        } catch (err) {
            console.error('Errore fetch revisori:', err);
            suggestionsDiv.style.display = 'none';
        }
    }

    function selectRevisore(index) {
        const nome = revisoriCache[index];
        if (nome) {
            document.getElementById('inpNomeRevisore').value = nome;
        }
        document.getElementById('revisoreSuggestions').style.display = 'none';
    }

    /* ==================== AUTOCOMPLETE CARICAMENTI ==================== */
    let caricamentiCache = [];
    async function searchCaricamenti(query) {
        const suggestionsDiv = document.getElementById('caricamentoSuggestions');
        if (query.length < 1) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        try {
            const res = await fetch(`/api/caricamenti?q=${encodeURIComponent(query)}`);
            caricamentiCache = await res.json();
            if (caricamentiCache.length > 0) {
                suggestionsDiv.innerHTML = caricamentiCache.map((nome, i) => `
                <div class="suggestion-item" onclick="selectCaricamento(${i})">
                    <strong>${nome}</strong>
                </div>
            `).join('');
                suggestionsDiv.style.display = 'block';
            } else {
                suggestionsDiv.style.display = 'none';
            }
        } catch (err) {
            console.error('Errore fetch caricamenti:', err);
            suggestionsDiv.style.display = 'none';
        }
    }

    function selectCaricamento(index) {
        const nome = caricamentiCache[index];
        if (nome) {
            document.getElementById('inpNomeCaricamento').value = nome;
        }
        document.getElementById('caricamentoSuggestions').style.display = 'none';
    }

    // Chiudi dropdown al click fuori
    document.addEventListener('click', function (e) {
        if (!e.target.closest('.autocomplete-wrapper')) {
            document.getElementById('clienteSuggestions').style.display = 'none';
            document.getElementById('esternoSuggestions').style.display = 'none';
            const revSug = document.getElementById('revisoreSuggestions');
            const carSug = document.getElementById('caricamentoSuggestions');
            if (revSug) revSug.style.display = 'none';
            if (carSug) carSug.style.display = 'none';
        }
    });

    /* ==================== GESTIONE BENI MULTIPLI ==================== */
    function addBene() {
        const container = document.getElementById('beniContainer');
        const newRow = document.createElement('div');
        newRow.className = 'bene-row form-row';
        newRow.dataset.index = beneIndex;

        newRow.innerHTML = `
        <input type="hidden" name="beni[${beneIndex}][id]" class="bene-id" value="">
        <div class="input-group flex-2">
            <label>Bene (Descrizione)</label>
            <input type="text" name="beni[${beneIndex}][descrizione]" class="one-ui-input bene-desc">
        </div>
        <div class="input-group flex-1">
            <label>Valore Bene (€)</label>
            <input type="text" name="beni[${beneIndex}][valore]" class="one-ui-input currency-input bene-valore"
                   oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
        </div>
        <div class="input-group flex-1">
            <label>Importo Offerta (€)</label>
            <input type="text" name="beni[${beneIndex}][importo_offerta]" class="one-ui-input currency-input bene-importo"
                   oninput="formatCurrencyInput(this); calcolaTotaleOfferta();" onblur="formatCurrencyBlur(this); calcolaTotaleOfferta();">
        </div>
        <div class="input-group btn-remove-group">
            <button type="button" class="btn-remove-bene" onclick="removeBene(this)">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;

        container.appendChild(newRow);
        beneIndex++;
        updateRemoveButtons();
    }

    function removeBene(btn) {
        const row = btn.closest('.bene-row');
        row.remove();
        updateRemoveButtons();
        calcolaTotaleOfferta(); // Ricalcola il totale dopo la rimozione
    }
    
    // Calcola il totale offerta dalla somma degli importi offerta dei beni
    function calcolaTotaleOfferta() {
        let totale = 0;
        document.querySelectorAll('.bene-importo').forEach(input => {
            totale += parseCurrency(input.value);
        });
        document.getElementById('impOfferta').value = formatCurrency(totale);
        calcolaCompensi(); // Ricalcola i compensi
    }

    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.bene-row');
        rows.forEach((row, index) => {
            const removeGroup = row.querySelector('.btn-remove-group');
            if (removeGroup) {
                removeGroup.style.display = rows.length > 1 ? 'flex' : 'none';
            }
        });
    }

	/* ==================== OVERLAY & UI ==================== */
    function openOverlay(type) {
        // 2. Trova l'overlay giusto
        const overlayId = 'overlay' + capitalize(type);
        const overlay = document.getElementById(overlayId);
        
        if (overlay) {
            // Se l'overlay è già aperto, chiudilo
            if (overlay.classList.contains('active')) {
                closeOverlay(type);
                return;
            }
            
            // 1. Chiudi eventuali altri overlay
            closeOverlay('compensi');
            closeOverlay('fatture');
            closeOverlay('procacciatori');
            
            // Per l'overlay procacciatori, calcola e imposta la larghezza PRIMA di aprire
            if (type === 'procacciatori') {
                // Calcola la larghezza quando l'overlay è ancora chiuso
                const calculatedWidth = calculateProcacciatoriOverlayWidth();
                // Imposta la larghezza inline PRIMA di aggiungere la classe active
                // Questo ha priorità sul CSS
                if (calculatedWidth > 0) {
                    overlay.style.width = calculatedWidth + 'px';
                    overlay.style.setProperty('width', calculatedWidth + 'px', 'important');
                }
            }
            
            // Apri l'overlay selezionato
            overlay.classList.add('active');
            
            // Per l'overlay procacciatori, ricalcola e riapplica la larghezza dopo che la classe active è stata aggiunta
            if (type === 'procacciatori') {
                // Usa requestAnimationFrame per assicurarsi che il CSS sia applicato
                requestAnimationFrame(() => {
                    const recalculatedWidth = calculateProcacciatoriOverlayWidth();
                    if (recalculatedWidth > 0) {
                        overlay.style.setProperty('width', recalculatedWidth + 'px', 'important');
                    }
                    // Ricalcola anche dopo un breve delay per sicurezza
                    setTimeout(() => {
                        const finalWidth = calculateProcacciatoriOverlayWidth();
                        if (finalWidth > 0) {
                            overlay.style.setProperty('width', finalWidth + 'px', 'important');
                        }
                        syncProcacciatoriScroll();
                    }, 100);
                });
            }
            
            // 3. FONDAMENTALE: Aggiunge la classe al BODY per mostrare la barra di scorrimento
            document.body.classList.add('overlay-open');
        }
    }

    function closeOverlay(type) {
        const overlayId = 'overlay' + capitalize(type);
        const overlay = document.getElementById(overlayId);
        
        if (overlay) {
            // Per l'overlay procacciatori, rimuovi la larghezza inline per permettere la chiusura immediata
            if (type === 'procacciatori') {
                overlay.style.removeProperty('width');
            }
            
            overlay.classList.remove('active');
            
            // 4. Rimuove la classe dal BODY (nasconde la barra)
            document.body.classList.remove('overlay-open');
        }
    }

    function calculateProcacciatoriOverlayWidth() {
        // Trova la colonna "Redattore" nella tabella principale (standard o extra1)
        const mainTable = document.querySelector('.lavori-admin-standard-table') || 
                         document.querySelector('.table-expanded');
        const overlay = document.getElementById('overlayProcacciatori');
        
        if (!mainTable || !overlay) {
            return 200; // Larghezza di fallback
        }
        
        const headerRow = mainTable.querySelector('thead tr');
        if (!headerRow) {
            return 200;
        }
        
        const headers = Array.from(headerRow.querySelectorAll('th'));
        const redattoreIndex = headers.findIndex(th => th.textContent.trim() === 'Redattore');
        
        if (redattoreIndex === -1) {
            return 200;
        }
        
        // Calcola la larghezza usando le colonne dell'header
        // Forza un reflow per assicurarsi che le dimensioni siano aggiornate
        void mainTable.offsetHeight;
        
        let widthFromRedattore = 0;
        for (let i = redattoreIndex; i < headers.length; i++) {
            const header = headers[i];
            const rect = header.getBoundingClientRect();
            widthFromRedattore += rect.width;
        }
        
        // Se il calcolo dall'header non funziona, prova con le celle del body
        if (widthFromRedattore === 0 || widthFromRedattore < 50) {
            const tbody = mainTable.querySelector('tbody');
            if (tbody) {
                const firstRow = tbody.querySelector('tr');
                if (firstRow) {
                    const cells = Array.from(firstRow.querySelectorAll('td'));
                    if (redattoreIndex < cells.length) {
                        widthFromRedattore = 0;
                        for (let i = redattoreIndex; i < cells.length; i++) {
                            const cell = cells[i];
                            const rect = cell.getBoundingClientRect();
                            widthFromRedattore += rect.width;
                        }
                    }
                }
            }
        }
        
        // Se non riusciamo a calcolare, usa una larghezza di default
        if (widthFromRedattore === 0 || widthFromRedattore < 150) {
            widthFromRedattore = 200; // Larghezza minima
        }
        
        // Imposta anche la larghezza inline (verrà sovrascritta dal chiamante se necessario)
        overlay.style.right = '0px'; // Sempre parte da destra
        overlay.style.maxWidth = 'none';
        
        // Ritorna la larghezza calcolata
        return widthFromRedattore;
    }

    /* ==================== RICERCA E FILTRI ==================== */
    let currentSearchTerm = '';
    let currentRedattoreFilter = '';
    let activeFilters = {
        stato: '',
        collaboratore: '',
        origine: '',
        revisore: '',
        caricamento: '',
        speseAmm: ''
    };
    
    function toggleSearchBar() {
        const searchBar = document.getElementById('searchBar');
        const btnSearch = document.getElementById('btnSearch');
        if (searchBar.style.display === 'none' || !searchBar.style.display) {
            searchBar.style.display = 'flex';
            document.getElementById('searchInput').focus();
            btnSearch.style.background = 'var(--primary)';
            btnSearch.style.color = 'white';
        } else {
            searchBar.style.display = 'none';
            document.getElementById('searchInput').value = '';
            currentSearchTerm = '';
            btnSearch.style.background = '';
            btnSearch.style.color = '';
            applyAllFilters();
        }
    }
    
    function performSearch(term) {
        currentSearchTerm = term.toLowerCase().trim();
        applyAllFilters();
    }
    
    function toggleFiltersPanel() {
        const panel = document.getElementById('filtersPanel');
        const btnFilters = document.getElementById('btnFilters');
        if (panel.style.display === 'none' || !panel.style.display) {
            panel.style.display = 'block';
            btnFilters.style.background = 'var(--primary)';
            btnFilters.style.color = 'white';
        } else {
            panel.style.display = 'none';
            btnFilters.style.background = '';
            btnFilters.style.color = '';
        }
    }
    
    function applyFilters() {
        activeFilters.stato = document.getElementById('filterStato').value.toLowerCase();
        activeFilters.collaboratore = document.getElementById('filterCollaboratore').value.toLowerCase().trim();
        activeFilters.origine = document.getElementById('filterOrigine').value.toLowerCase();
        activeFilters.revisore = document.getElementById('filterRevisore').value;
        activeFilters.caricamento = document.getElementById('filterCaricamento').value;
        activeFilters.speseAmm = document.getElementById('filterSpeseAmm').value;
        
        updateFilterBadge();
        applyAllFilters();
    }
    
    function updateFilterBadge() {
        const badge = document.getElementById('filterBadge');
        const btnReset = document.getElementById('btnResetFilters');
        let count = 0;
        
        if (activeFilters.stato) count++;
        if (activeFilters.collaboratore) count++;
        if (activeFilters.origine) count++;
        if (activeFilters.revisore) count++;
        if (activeFilters.caricamento) count++;
        if (activeFilters.speseAmm) count++;
        if (currentRedattoreFilter) count++;
        
        if (count > 0) {
            badge.textContent = count;
            badge.style.display = 'inline-block';
            btnReset.style.display = 'inline-flex';
        } else {
            badge.style.display = 'none';
            btnReset.style.display = 'none';
        }
    }
    
    function applyAllFilters() {
        // Prima raggruppa le righe per lavoro (data-id)
        const lavoriRows = {};
        const allRows = document.querySelectorAll('.oneui-table tbody tr[data-id]');
        
        allRows.forEach(row => {
            const lavoroId = row.getAttribute('data-id');
            if (!lavoriRows[lavoroId]) {
                lavoriRows[lavoroId] = [];
            }
            lavoriRows[lavoroId].push(row);
        });
        
        // Per ogni lavoro, applica i filtri
        Object.keys(lavoriRows).forEach(lavoroId => {
            const lavoroRows = lavoriRows[lavoroId];
            
            // Trova la prima riga del lavoro (quella con gli attributi a livello di lavoro)
            const firstRow = lavoroRows.find(row => row.hasAttribute('data-cliente') || row.hasAttribute('data-offerta-generated')) || lavoroRows[0];
            
            // Controlla i filtri a livello di lavoro sulla prima riga
            let lavoroPassaFiltri = true;
            
            // Ricerca (cliente)
            if (currentSearchTerm && lavoroPassaFiltri) {
                const cliente = (firstRow.getAttribute('data-cliente') || '').toLowerCase();
                if (!cliente.includes(currentSearchTerm)) {
                    // Se non matcha il cliente, controlla i beni
                    let beneMatch = false;
                    lavoroRows.forEach(row => {
                const bene = (row.getAttribute('data-bene') || '').toLowerCase();
                        if (bene.includes(currentSearchTerm)) {
                            beneMatch = true;
                        }
                    });
                    if (!beneMatch) {
                        lavoroPassaFiltri = false;
                    }
                }
            }
            
            // Filtro Redattore
            if (currentRedattoreFilter && lavoroPassaFiltri) {
                const redattore = (firstRow.getAttribute('data-redattore') || '').toUpperCase();
                if (redattore !== currentRedattoreFilter.toUpperCase()) {
                    lavoroPassaFiltri = false;
                }
            }
            
            // Filtro Collaboratore
            if (activeFilters.collaboratore && lavoroPassaFiltri) {
                const collaboratore = (firstRow.getAttribute('data-collaboratore') || '').toLowerCase();
                if (!collaboratore.includes(activeFilters.collaboratore)) {
                    lavoroPassaFiltri = false;
                }
            }
            
            // Filtro Origine
            if (activeFilters.origine && lavoroPassaFiltri) {
                const origine = (firstRow.getAttribute('data-origine') || '').toLowerCase();
                if (origine !== activeFilters.origine) {
                    lavoroPassaFiltri = false;
                }
            }
            
            // Filtro Revisore
            if (activeFilters.revisore && lavoroPassaFiltri) {
                const hasRevisore = firstRow.getAttribute('data-has-revisore');
                if (hasRevisore !== activeFilters.revisore) {
                    lavoroPassaFiltri = false;
                }
            }
            
            // Filtro Caricamento
            if (activeFilters.caricamento && lavoroPassaFiltri) {
                const hasCaricamento = firstRow.getAttribute('data-has-caricamento');
                if (hasCaricamento !== activeFilters.caricamento) {
                    lavoroPassaFiltri = false;
                }
            }
            
            // Filtro Spese Amministrative
            if (activeFilters.speseAmm && lavoroPassaFiltri) {
                const speseAmm = firstRow.getAttribute('data-spese-amm');
                if (speseAmm !== activeFilters.speseAmm) {
                    lavoroPassaFiltri = false;
                }
            }
            
            // Se il lavoro non passa i filtri a livello di lavoro, nascondi tutte le righe
            if (!lavoroPassaFiltri) {
                lavoroRows.forEach(row => {
                    row.classList.add('filtered-out');
                });
                return;
            }
            
            // Se il lavoro passa i filtri a livello di lavoro, applica i filtri a livello di bene
            lavoroRows.forEach(row => {
                let benePassaFiltri = true;
                
                // Filtro Stato (a livello di bene)
                if (activeFilters.stato && benePassaFiltri) {
                    const stato = (row.getAttribute('data-stato') || '').toLowerCase();
                    if (stato !== activeFilters.stato) {
                        benePassaFiltri = false;
                }
            }
            
                // Ricerca (bene) - se già non matchava il cliente
                if (currentSearchTerm && benePassaFiltri) {
                    const cliente = (firstRow.getAttribute('data-cliente') || '').toLowerCase();
                    if (cliente.includes(currentSearchTerm)) {
                        // Se matcha il cliente, mostra tutti i beni
                        benePassaFiltri = true;
                    } else {
                        // Se non matcha il cliente, controlla questo specifico bene
                        const bene = (row.getAttribute('data-bene') || '').toLowerCase();
                        if (bene.includes(currentSearchTerm)) {
                            benePassaFiltri = true;
                        } else {
                            benePassaFiltri = false;
                        }
                    }
                }
                
                if (benePassaFiltri) {
                row.classList.remove('filtered-out');
            } else {
                row.classList.add('filtered-out');
            }
            });
        });
        
        // Ricalcola i rowspan dopo il filtraggio
        recalculateRowspans();
    }
    
    function recalculateRowspans() {
        // Raggruppa le righe per lavoro (data-id)
        const lavoriRows = {};
        const allRows = document.querySelectorAll('.oneui-table tbody tr[data-id]');
        
        allRows.forEach(row => {
            const lavoroId = row.getAttribute('data-id');
            if (!lavoriRows[lavoroId]) {
                lavoriRows[lavoroId] = [];
            }
            lavoriRows[lavoroId].push(row);
        });
        
        // Per ogni lavoro, ricalcola i rowspan
        Object.keys(lavoriRows).forEach(lavoroId => {
            const lavoroRows = lavoriRows[lavoroId];
            
            // Trova la PRIMA riga originale del lavoro (quella con data-cliente o data-offerta-generated)
            // Questa è sempre la riga che contiene le celle con rowspan
            const firstRow = lavoroRows.find(row => row.hasAttribute('data-cliente') || row.hasAttribute('data-offerta-generated')) || lavoroRows[0];
            
            // Conta solo le righe visibili (non filtered-out)
            const visibleRows = lavoroRows.filter(row => !row.classList.contains('filtered-out'));
            const visibleCount = visibleRows.length;
            
            if (visibleCount === 0) {
                // Se non ci sono righe visibili, nascondi anche la prima riga
                firstRow.classList.add('filtered-out');
                return;
            }
            
            // Se ci sono righe visibili, la prima riga DEVE essere visibile per mostrare le celle comuni
            // Rimuovi filtered-out dalla prima riga se presente
            firstRow.classList.remove('filtered-out');
            
            // Trova tutte le celle con rowspan nella prima riga
            const rowspanCells = firstRow.querySelectorAll('td[rowspan]');
            
            // Aggiorna il rowspan di tutte le celle con il numero di righe visibili
            rowspanCells.forEach(cell => {
                cell.setAttribute('rowspan', visibleCount);
            });
        });
    }
    
    function toggleRedattoreFilter() {
        const menu = document.getElementById('redattoreFilterMenu');
        const btn = document.getElementById('btnRedattore');
        const rect = btn.getBoundingClientRect();
        
        if (menu.style.display === 'none' || !menu.style.display) {
            menu.style.display = 'block';
            menu.style.top = (rect.bottom + 5) + 'px';
            menu.style.right = (window.innerWidth - rect.right) + 'px';
            menu.style.left = 'auto';
            
            // Evidenzia l'opzione attiva
            menu.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
                const text = item.textContent.trim();
                if (text === 'Tutti' && !currentRedattoreFilter) {
                    item.classList.add('active');
                } else if (text === currentRedattoreFilter) {
                    item.classList.add('active');
                }
            });
        } else {
            menu.style.display = 'none';
        }
    }
    
    function setRedattoreFilter(redattore) {
        currentRedattoreFilter = redattore;
        const textEl = document.getElementById('redattoreFilterText');
        textEl.textContent = redattore || 'Tutti';
        document.getElementById('redattoreFilterMenu').style.display = 'none';
        updateFilterBadge();
        applyAllFilters();
    }
    
    function resetAllFilters() {
        currentSearchTerm = '';
        currentRedattoreFilter = '';
        activeFilters = {
            stato: '',
            collaboratore: '',
            origine: '',
            revisore: '',
            caricamento: '',
            speseAmm: ''
        };
        
        document.getElementById('searchInput').value = '';
        document.getElementById('filterStato').value = '';
        document.getElementById('filterCollaboratore').value = '';
        document.getElementById('filterOrigine').value = '';
        document.getElementById('filterRevisore').value = '';
        document.getElementById('filterCaricamento').value = '';
        document.getElementById('filterSpeseAmm').value = '';
        document.getElementById('redattoreFilterText').textContent = 'Tutti';
        
        document.getElementById('searchBar').style.display = 'none';
        document.getElementById('filtersPanel').style.display = 'none';
        document.getElementById('btnSearch').style.background = '';
        document.getElementById('btnSearch').style.color = '';
        document.getElementById('btnFilters').style.background = '';
        document.getElementById('btnFilters').style.color = '';
        
        updateFilterBadge();
        applyAllFilters();
    }
    
    // Chiudi menu quando si clicca fuori
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('redattoreFilterMenu');
        const btn = document.getElementById('btnRedattore');
        const panel = document.getElementById('filtersPanel');
        const btnFilters = document.getElementById('btnFilters');
        
        if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
            menu.style.display = 'none';
        }
        
        if (panel && btnFilters && !panel.contains(e.target) && !btnFilters.contains(e.target)) {
            panel.style.display = 'none';
            btnFilters.style.background = '';
            btnFilters.style.color = '';
        }
    });

    function syncProcacciatoriScroll() {
        // Sincronizza lo scroll verticale tra la tabella principale e l'overlay
        const mainTable = document.querySelector('.lavori-admin-standard-table') || 
                         document.querySelector('.table-expanded');
        const overlayTable = document.querySelector('#overlayProcacciatori .overlay-table');
        
        if (!mainTable || !overlayTable) return;
        
        // Trova i container scrollabili
        const mainContainer = mainTable.closest('.table-container') || 
                             document.querySelector('#extra1TableScroll');
        const overlayContainer = overlayTable.closest('#overlayProcacciatori');
        
        if (!mainContainer || !overlayContainer) return;
        
        // Rimuovi eventuali listener precedenti
        const syncScroll = () => {
            overlayContainer.scrollTop = mainContainer.scrollTop || window.scrollY;
        };
        
        // Sincronizza quando la tabella principale scrolla
        mainContainer.addEventListener('scroll', syncScroll, { passive: true });
        window.addEventListener('scroll', syncScroll, { passive: true });
        
        // Sincronizza anche quando l'overlay scrolla (bidirezionale)
        overlayContainer.addEventListener('scroll', () => {
            mainContainer.scrollTop = overlayContainer.scrollTop;
        }, { passive: true });
    }

    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function toggleGruppoFocus() {
        showingEsterni = !showingEsterni;
        const btn = document.getElementById('btnToggleGruppo');
        document.querySelectorAll('.gruppo-interni').forEach(el => el.style.display = showingEsterni ? 'none' : '');
        document.querySelectorAll('.gruppo-esterni').forEach(el => el.style.display = showingEsterni ? '' : 'none');
        btn.innerHTML = showingEsterni
            ? '<i class="bi bi-arrow-left-right"></i> Passa a Interni'
            : '<i class="bi bi-arrow-left-right"></i> Passa a Esterni';
    }

    function toggleDateField(chk, field, id) {
        // FUNZIONE RIMASTA PER COMPATIBILITÀ (NON PIÙ USATA NELLA VIEW STANDARD)
        if (chk.checked) {
            const dateVal = prompt("Inserisci la data (AAAA-MM-GG):", new Date().toISOString().split('T')[0]);
            if (dateVal) {
                updateField(id, field, dateVal);
                updateField(id, field + '_check', true);
                setTimeout(() => location.reload(), 500);
            } else {
                chk.checked = false;
            }
        } else {
            updateField(id, field + '_check', false);
            updateField(id, field, null);
        }
    }

    async function updateBeneStato(select, beneId) {
        if (!beneId) return;
        const res = await fetch(`/update_bene_field/${beneId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field: 'stato', value: select.value })
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(err.error || 'Errore aggiornamento stato');
            return;
        }
        select.className = 'status-select stato-' + select.value.replace(/ /g, '-');
    }

    async function editDataPec(ev, beneId) {
        ev.stopPropagation();
        if (!beneId) return;
        const raw = prompt('Inserisci data PEC (gg/mm/aa oppure gg/mm/aaaa):', '');
        if (!raw) return;
        const m = /^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/.exec(raw.trim());
        if (!m) { alert('Formato data non valido. Usa gg/mm/aa o gg/mm/aaaa.'); return; }
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        let yy = parseInt(m[3], 10);
        if (yy < 100) yy = 2000 + yy;
        const iso = `${yy.toString().padStart(4,'0')}-${mm.toString().padStart(2,'0')}-${dd.toString().padStart(2,'0')}`;

        const res = await fetch(`/update_bene_field/${beneId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field: 'data_pec', value: iso })
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            alert(err.error || 'Errore aggiornamento data PEC');
            return;
        }

        // Aggiorna UI: mostra sempre gg-mes
        const mesi = ['', 'gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
        const txt = `${dd.toString().padStart(2,'0')}-${mesi[mm]}`;
        const row = document.querySelector(`tr[data-bene-id="${beneId}"]`);
        if (row) {
            const cell = row.querySelector('.col-data-pec');
            if (cell) cell.textContent = txt;
        }
    }

    async function editFattura(event, lavoroId, fatturaType) {
        event.stopPropagation();
        const cell = event.currentTarget;
        const currentValue = cell.textContent.trim() === '-' ? '' : cell.textContent.trim();
        
        // Crea un input inline
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentValue;
        input.className = 'one-ui-input compact';
        input.style.width = '100%';
        input.style.textAlign = 'center';
        input.style.padding = '4px 8px';
        input.style.fontSize = '0.9rem';
        input.style.margin = '0';
        input.style.border = '2px solid var(--primary)';
        input.style.borderRadius = '8px';
        
        // Salva il contenuto originale della cella
        const originalContent = cell.innerHTML;
        
        // Sostituisci il contenuto della cella con l'input
        cell.innerHTML = '';
        cell.appendChild(input);
        input.focus();
        input.select();
        
        // Funzione per salvare
        const saveFattura = async () => {
            const newValue = input.value.trim();
            const valueToSave = newValue || null;
            const displayValue = newValue || '-';
            
            try {
                const res = await fetch(`/update_fattura/${lavoroId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        fattura_type: fatturaType,
                        value: valueToSave
                    })
                });
                
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.error || 'Errore aggiornamento fattura');
                    cell.innerHTML = originalContent;
                    return;
                }
                
                // Aggiorna tutte le celle con lo stesso data-fattura-type e data-lavoro-id
                const allCells = document.querySelectorAll(`td.cell-fattura[data-fattura-type="${fatturaType}"][data-lavoro-id="${lavoroId}"]`);
                allCells.forEach(c => {
                    c.textContent = displayValue;
                });
                
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore durante il salvataggio');
                cell.innerHTML = originalContent;
            }
        };
        
        // Salva quando si preme Enter o quando l'input perde il focus
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveFattura();
            } else if (e.key === 'Escape') {
                cell.innerHTML = originalContent;
            }
        });
        
        input.addEventListener('blur', () => {
            saveFattura();
        });
    }

    function showContextMenu(e, id) {
        e.preventDefault();
        currentLavoroId = id;
        const menu = document.getElementById('contextMenu');
        const label = document.getElementById('menuGeneraOffertaLabel');
        
        // Rimuovi evidenziazione da tutte le righe
        document.querySelectorAll('.oneui-table tbody tr.row-selected').forEach(row => {
            row.classList.remove('row-selected');
        });
        
        // Evidenzia tutte le righe del lavoro selezionato (per lavori con più beni)
        const selectedRow = e.currentTarget.closest('tr');
        if (selectedRow) {
            const lavoroId = selectedRow.getAttribute('data-id');
            // Aggiorna label Genera/Revisiona
            if (label) {
                const generated = selectedRow.getAttribute('data-offerta-generated') === '1';
                label.textContent = generated ? 'Revisiona Offerta' : 'Genera Offerta';
            }
            // Evidenzia tutte le righe con lo stesso data-id
            const rowsToHighlight = document.querySelectorAll(`.oneui-table tbody tr[data-id="${lavoroId}"]`);
            rowsToHighlight.forEach(row => {
                row.classList.add('row-selected');
            });
            console.log('Evidenziate', rowsToHighlight.length, 'righe per lavoro', lavoroId);
        }
        
        // Usa clientX/clientY per position: fixed (relativi alla viewport)
        let x = e.clientX;
        let y = e.clientY;
        
        // Rendiamo il menu temporaneamente visibile per calcolare le dimensioni
        menu.style.visibility = 'hidden';
        menu.style.display = 'block';
        menu.style.top = '0px';
        menu.style.left = '0px';
        
        const menuRect = menu.getBoundingClientRect();
        const viewportWidth = window.innerWidth;
        const viewportHeight = window.innerHeight;
        
        // Se il menu andrebbe fuori a destra, allinealo a destra
        if (x + menuRect.width > viewportWidth) {
            x = viewportWidth - menuRect.width - 10;
        }
        
        // Se il menu andrebbe fuori in basso, posizionalo sopra il cursore
        if (y + menuRect.height > viewportHeight) {
            y = e.clientY - menuRect.height;
        }
        
        // Assicurati che non vada fuori a sinistra o in alto
        if (x < 0) x = 10;
        if (y < 0) y = 10;
        
        menu.style.top = `${y}px`;
        menu.style.left = `${x}px`;
        menu.style.visibility = 'visible';
        menu.classList.add('active');
    }

    function hideContextMenu() {
        const menu = document.getElementById('contextMenu');
        if (menu) {
            menu.classList.remove('active');
            menu.style.display = 'none';
            menu.style.visibility = 'hidden';
        }
        // Rimuovi evidenziazione da tutte le righe
        document.querySelectorAll('.oneui-table tbody tr.row-selected').forEach(row => {
            row.classList.remove('row-selected');
        });
    }
    
    // Listener globale per chiudere il menu quando si clicca fuori
    // Rimuovi eventuali listener precedenti
    if (window.contextMenuClickHandler) {
        document.removeEventListener('click', window.contextMenuClickHandler, true);
    }
    
    window.contextMenuClickHandler = function(e) {
        const menu = document.getElementById('contextMenu');
        if (!menu || !menu.classList.contains('active')) {
            return;
        }
        
        // Se il click è dentro il menu, non fare nulla
        if (menu.contains(e.target)) {
            return;
        }
        
        // Se il click è fuori, chiudi il menu
        hideContextMenu();
    };
    
    document.addEventListener('click', window.contextMenuClickHandler, true);

    /* ==================== GENERA OFFERTA ==================== */
    let currentOffertaLavoroId = null;

    let revisioneOffertaMode = false;
    let pendingRevisionTipoPick = false;

    function openGeneraOffertaModal(id) {
        hideContextMenu();
        currentOffertaLavoroId = id;

        const row = document.querySelector(`tr[data-id="${id}"]`);
        const generated = row && row.getAttribute('data-offerta-generated') === '1';

        if (generated) {
            // Revisiona: apri direttamente il form di modifica lavoro
            revisioneOffertaMode = true;
            editLavoro(id);
            return;
        }

        // Prima emissione: scegli il tipo dal modal
        revisioneOffertaMode = false;
        const modal = document.getElementById('generaOffertaModal');
        if (modal) modal.classList.add('active');
    }

    function closeGeneraOffertaModal() {
        const modal = document.getElementById('generaOffertaModal');
        if (modal) modal.classList.remove('active');
        // se era un pick per la revisione, NON azzeriamo l'id lavoro
        if (!pendingRevisionTipoPick) {
            currentOffertaLavoroId = null;
        }
    }

    async function confirmGeneraOfferta(tipo) {
        const id = currentOffertaLavoroId;
        if (!id) return;

        try {
            // Caso: ci serve solo scegliere il tipo per la revisione (lavori legacy senza offerta_tipo)
            if (pendingRevisionTipoPick) {
                pendingRevisionTipoPick = false;
                closeGeneraOffertaModal();
                await revisionaOffertaDaForm(tipo);
                return;
            }

            const res = await fetch(`/api/lavoro/${id}/genera_offerta`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tipo })
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || 'Errore generazione offerta');
            }

            const dataBreve = res.headers.get('X-Offerta-Data-Breve');
            const rev = parseInt(res.headers.get('X-Offerta-Revision') || '0', 10) || 0;
            const blob = await res.blob();
            const ct = res.headers.get('Content-Type') || '';
            if (!ct.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document')) {
                const txt = await blob.text().catch(() => '');
                throw new Error('Risposta non è un .docx. ' + (txt ? ('Dettaglio: ' + txt.slice(0, 200)) : ''));
            }
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Prova a usare il filename dal Content-Disposition (supporta anche filename*=UTF-8'')
            const cd = res.headers.get('Content-Disposition') || '';
            let fname = '';
            const mStar = /filename\*\s*=\s*UTF-8''([^;]+)/i.exec(cd);
            if (mStar && mStar[1]) {
                try { fname = decodeURIComponent(mStar[1]); } catch (e) { fname = mStar[1]; }
            }
            if (!fname) {
                const m = /filename=\"?([^\";]+)\"?/i.exec(cd);
                fname = (m && m[1]) ? m[1] : '';
            }
            a.download = fname || `Prev. First Eng_${id}_4.0.docx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

            // Aggiorna UI: Data Offerta (se presente in tabella standard/extra1)
            if (dataBreve) {
                const firstRow = document.querySelector(`tr[data-id="${id}"]`);
                if (firstRow) {
                    firstRow.setAttribute('data-offerta-generated', '1');
                    firstRow.setAttribute('data-offerta-dirty', '0');
                    firstRow.setAttribute('data-offerta-rev', String(rev));
                    const cell = firstRow.querySelector('.cell-data-offerta');
                    if (cell) cell.textContent = (rev > 0 ? `R${rev} ` : '') + dataBreve;
                }
            }
        } catch (e) {
            alert(e.message || 'Errore generazione offerta');
        } finally {
            closeGeneraOffertaModal();
        }
    }

    async function revisionaOffertaDaForm(tipoOverride = null) {
        const form = document.getElementById('formAddLavoro');
        if (!form) return;

        const fd = new FormData(form);
        // usa l’id già presente nel form
        const lavoroId = fd.get('lavoro_id');
        if (!lavoroId) {
            alert('ID lavoro mancante.');
            return;
        }

        // Se il lavoro è legacy e non ha offerta_tipo, chiedi il tipo prima di procedere
        if (!tipoOverride) {
            const row = document.querySelector(`tr[data-id="${lavoroId}"]`);
            const hasTipo = row && row.getAttribute('data-offerta-tipo') && row.getAttribute('data-offerta-tipo').trim();
            if (!hasTipo) {
                pendingRevisionTipoPick = true;
                currentOffertaLavoroId = lavoroId;
                const modal = document.getElementById('generaOffertaModal');
                if (modal) modal.classList.add('active');
                return;
            }
        }

        try {
            const requestUrl = tipoOverride
                ? `/add_lavoro_admin?download_offerta=1&tipo=${encodeURIComponent(tipoOverride)}`
                : `/add_lavoro_admin?download_offerta=1`;
            const res = await fetch(requestUrl, {
                method: 'POST',
                body: fd
            });

            if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                throw new Error(err.error || 'Errore revisione offerta');
            }

            const dataBreve = res.headers.get('X-Offerta-Data-Breve');
            const rev = parseInt(res.headers.get('X-Offerta-Revision') || '0', 10) || 0;
            const blob = await res.blob();
            const ct = res.headers.get('Content-Type') || '';
            if (!ct.includes('application/vnd.openxmlformats-officedocument.wordprocessingml.document')) {
                const txt = await blob.text().catch(() => '');
                throw new Error('Risposta non è un .docx. ' + (txt ? ('Dettaglio: ' + txt.slice(0, 200)) : ''));
            }
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = blobUrl;
            const cd = res.headers.get('Content-Disposition') || '';
            let fname = '';
            const mStar = /filename\*\s*=\s*UTF-8''([^;]+)/i.exec(cd);
            if (mStar && mStar[1]) {
                try { fname = decodeURIComponent(mStar[1]); } catch (e) { fname = mStar[1]; }
            }
            if (!fname) {
                const m = /filename=\"?([^\";]+)\"?/i.exec(cd);
                fname = (m && m[1]) ? m[1] : '';
            }
            a.download = fname || `Prev. First Eng_${lavoroId}_4.0.docx`;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(blobUrl);

            if (dataBreve) {
                const firstRow = document.querySelector(`tr[data-id="${lavoroId}"]`);
                if (firstRow) {
                    firstRow.setAttribute('data-offerta-generated', '1');
                    firstRow.setAttribute('data-offerta-dirty', '0');
                    firstRow.setAttribute('data-offerta-rev', String(rev));
                    // Se abbiamo fatto override tipo (legacy), persistilo anche nella UI
                    if (tipoOverride) firstRow.setAttribute('data-offerta-tipo', tipoOverride);
                    const cell = firstRow.querySelector('.cell-data-offerta');
                    if (cell) cell.textContent = (rev > 0 ? `R${rev} ` : '') + dataBreve;
                }
            }

            // Aggiorna subito le celle della tabella con i dati salvati (senza refresh pagina)
            await refreshLavoroRowsFromApi(lavoroId);

            // chiudi modal e reset modalità
            closeAddModal();
            revisioneOffertaMode = false;
        } catch (e) {
            alert(e.message || 'Errore revisione offerta');
        }
    }

    function _formatDdMesFromIso(iso) {
        if (!iso) return '-';
        const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(iso).trim());
        if (!m) return '-';
        const dd = parseInt(m[3], 10);
        const mm = parseInt(m[2], 10);
        const mesi = ['', 'gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
        return `${dd.toString().padStart(2,'0')}-${mesi[mm] || ''}`.trim();
    }

    function _formatEuroCell(amount, decimals = 2) {
        const n = Number(amount || 0);
        if (!n || n <= 0) return '-';
        if (decimals === 0) {
            return '€ ' + Math.round(n).toLocaleString('it-IT').replace(/\./g, '.');
        }
        // usa helper già presenti se esistono
        if (typeof formatCurrency === 'function') return '€ ' + formatCurrency(n);
        return '€ ' + n.toLocaleString('it-IT', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }

    async function refreshLavoroRowsFromApi(lavoroId) {
        const res = await fetch(`/api/lavoro/${lavoroId}`);
        if (!res.ok) return;
        const data = await res.json().catch(() => null);
        if (!data) return;

        const rows = Array.from(document.querySelectorAll(`.oneui-table tbody tr[data-id="${lavoroId}"]`));
        if (!rows.length) return;

        const beni = Array.isArray(data.beni) ? data.beni : [];
        if (beni.length && beni.length !== rows.length) {
            // Caso raro: cambiato numero beni. Non tocchiamo il DOM per non rompere i rowspan.
            // L’utente può ricaricare se ha aggiunto/rimosso beni.
            return;
        }

        // Aggiorna celle "rowspan" sulla prima riga (se presenti)
        const first = rows[0];
        const cNum = first.querySelector('.col-numero');
        if (cNum) cNum.textContent = data.numero ?? cNum.textContent;

        const cCli = first.querySelector('.col-cliente');
        if (cCli) cCli.textContent = (data.cliente && data.cliente.nome) ? data.cliente.nome : (data.cliente_nome || cCli.textContent);

        const cOri = first.querySelector('.col-origine');
        if (cOri) cOri.textContent = data.origine ? data.origine : '-';

        const cRed = first.querySelector('.col-redattore');
        if (cRed) cRed.textContent = data.redattore ? data.redattore : '-';

        const cImpRev = first.querySelector('.col-imp-rev');
        if (cImpRev) cImpRev.textContent = _formatEuroCell(data.importo_revisione || 0, 0);

        const cImpCar = first.querySelector('.col-imp-car');
        if (cImpCar) cImpCar.textContent = _formatEuroCell(data.importo_caricamento || 0, 0);

        // Aggiorna righe bene
        rows.forEach((row, idx) => {
            const bene = beni[idx] || {};

            const d = row.querySelector('.col-bene-desc');
            if (d) d.textContent = bene.descrizione ? bene.descrizione : '-';

            const v = row.querySelector('.col-bene-valore');
            if (v) v.textContent = _formatEuroCell(bene.valore || 0, 2);

            const i = row.querySelector('.col-bene-importo');
            if (i) i.textContent = _formatEuroCell(bene.importo_offerta || 0, 2);

            const pec = row.querySelector('.col-data-pec');
            if (pec) pec.textContent = _formatDdMesFromIso(bene.data_pec);

            const sel = row.querySelector('select.status-select');
            if (sel && bene.stato) {
                sel.value = bene.stato;
                sel.className = 'status-select stato-' + String(bene.stato).replace(/ /g, '-');
            }
        });
    }

    /* ==================== DATA FIRMA (dblclick) ==================== */
    let currentFirmaLavoroId = null;

    function openFirmaMenu(ev, lavoroId) {
        ev.preventDefault();
        ev.stopPropagation();
        currentFirmaLavoroId = lavoroId;
        const menu = document.getElementById('firmaMenu');
        if (!menu) return;
        menu.style.left = `${ev.clientX}px`;
        menu.style.top = `${ev.clientY}px`;
        menu.style.display = 'block';
    }

    function closeFirmaMenu() {
        const menu = document.getElementById('firmaMenu');
        if (menu) menu.style.display = 'none';
        currentFirmaLavoroId = null;
    }

    async function firmaSetMode(mode) {
        const id = currentFirmaLavoroId;
        if (!id) return;

        try {
            if (mode === 'date') {
                const raw = prompt('Inserisci data firma (gg/mm/aa oppure gg/mm/aaaa):', '');
                if (!raw) { closeFirmaMenu(); return; }
                const m = /^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/.exec(raw.trim());
                if (!m) throw new Error('Formato data non valido. Usa gg/mm/aa o gg/mm/aaaa.');
                const dd = parseInt(m[1], 10);
                const mm = parseInt(m[2], 10);
                let yy = parseInt(m[3], 10);
                if (yy < 100) yy = 2000 + yy;
                const iso = `${yy.toString().padStart(4,'0')}-${mm.toString().padStart(2,'0')}-${dd.toString().padStart(2,'0')}`;
                await updateFirma(id, { field: 'data_firma', value: iso });
            } else if (mode === 'OK' || mode === 'AUTORIZZ.') {
                await updateFirma(id, { field: 'firma_esito', value: mode });
            } else if (mode === 'clear') {
                await updateFirma(id, { field: 'firma_esito', value: '' });
                await updateFirma(id, { field: 'data_firma', value: '' });
            }
        } catch (e) {
            alert(e.message || 'Errore aggiornamento firma');
        } finally {
            closeFirmaMenu();
        }
    }

    async function updateFirma(id, payload) {
        const res = await fetch(`/update_lavoro_field/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || 'Errore aggiornamento');
        }

        // Aggiorna UI cella Data Firma in tutte le righe dello stesso lavoro
        const rows = document.querySelectorAll(`tr[data-id="${id}"] .cell-data-firma`);
        if (!rows.length) return;

        // Calcola testo display: OK / AUTORIZZ. / gg-mes / '-'
        let display = null;
        if (payload.field === 'firma_esito') {
            display = (payload.value || '').trim() || '-';
        } else if (payload.field === 'data_firma') {
            if (!payload.value) {
                display = '-';
            } else {
                const parts = payload.value.split('-');
                const dd = parts[2];
                const mm = parseInt(parts[1], 10);
                const mesi = ['', 'gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
                display = `${dd}-${mesi[mm]}`;
            }
        }

        if (display !== null) {
            rows.forEach(el => { el.textContent = display; });
        }
    }

    // Chiudi menu Data Firma al click fuori
    document.addEventListener('click', function(e) {
        const menu = document.getElementById('firmaMenu');
        if (!menu) return;
        if (menu.style.display === 'block' && !menu.contains(e.target)) {
            closeFirmaMenu();
        }
    }, true);

    function deleteLavoro(id) {
        if (confirm('Sei sicuro di voler eliminare il lavoro #' + id + '?')) {
            const form = document.getElementById('deleteForm');
            form.action = "/delete_lavoro_admin/" + id;
            form.submit();
        }
    }

    async function editLavoro(id) {
        // Chiudi il menu contestuale
        hideContextMenu();
        
        try {
            // Recupera i dati del lavoro
            const response = await fetch(`/api/lavoro/${id}`);
            if (!response.ok) {
                throw new Error('Errore nel recupero dei dati');
            }
            const data = await response.json();
            
            // Apri il modal
            document.getElementById('addModal').classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Cambia il titolo
            document.getElementById('modalTitle').textContent = `Modifica Lavoro #${data.numero}`;
            
            // Imposta l'ID del lavoro da modificare
            document.getElementById('lavoroId').value = data.id;
            
            // Reset del form
            document.getElementById('formAddLavoro').reset();
            document.getElementById('alertCompensi').style.display = 'none';
            
            // Compila anagrafica cliente
            document.getElementById('inpCliente').value = data.cliente.nome;
            document.getElementById('inpPiva').value = data.cliente.p_iva || '';
            document.getElementById('inpIndirizzo').value = data.cliente.indirizzo || '';
            document.getElementById('inpCivico').value = data.cliente.civico || '';
            document.getElementById('inpCap').value = data.cliente.cap || '';
            document.getElementById('inpComune').value = data.cliente.comune || '';
            document.getElementById('inpProv').value = data.cliente.provincia || '';
            document.getElementById('inpPec').value = data.cliente.pec || '';
            
            // Compila beni
            const container = document.getElementById('beniContainer');
            // Rimuovi tutte le righe esistenti
            container.innerHTML = '';
            beneIndex = 0;
            
            // Aggiungi tutte le righe beni
            data.beni.forEach((bene, idx) => {
                if (idx === 0) {
                    // Prima riga: crea direttamente
                    const firstRow = document.createElement('div');
                    firstRow.className = 'bene-row form-row';
                    firstRow.dataset.index = 0;
                    firstRow.innerHTML = `
                        <input type="hidden" name="beni[0][id]" class="bene-id" value="${bene.id || ''}">
                        <div class="input-group flex-2">
                            <label>Bene (Descrizione)</label>
                            <input type="text" name="beni[0][descrizione]" class="one-ui-input bene-desc" required value="${(bene.descrizione || '').replace(/"/g, '&quot;')}">
                        </div>
                        <div class="input-group flex-1">
                            <label>Valore Bene (€)</label>
                            <input type="text" name="beni[0][valore]" class="one-ui-input currency-input bene-valore"
                                value="${formatCurrency(bene.valore || 0)}"
                                oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                        </div>
                        <div class="input-group flex-1">
                            <label>Importo Offerta (€)</label>
                            <input type="text" name="beni[0][importo_offerta]" class="one-ui-input currency-input bene-importo"
                                value="${formatCurrency(bene.importo_offerta || 0)}"
                                oninput="formatCurrencyInput(this); calcolaTotaleOfferta();" onblur="formatCurrencyBlur(this); calcolaTotaleOfferta();">
                        </div>
                        <div class="input-group btn-remove-group" style="display:none;">
                            <button type="button" class="btn-remove-bene" onclick="removeBene(this)">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(firstRow);
                    beneIndex = 1;
                } else {
                    // Aggiungi nuove righe
                    addBene();
                    const rows = container.querySelectorAll('.bene-row');
                    const newRow = rows[rows.length - 1];
                    newRow.querySelector('.bene-desc').value = bene.descrizione || '';
                    newRow.querySelector('.bene-valore').value = formatCurrency(bene.valore || 0);
                    newRow.querySelector('.bene-importo').value = formatCurrency(bene.importo_offerta || 0);
                    const hid = newRow.querySelector('.bene-id');
                    if (hid) hid.value = bene.id || '';
                }
            });
            
            // Calcola il totale offerta dopo aver popolato i beni
            calcolaTotaleOfferta();
            
            // Se non ci sono beni, crea almeno una riga vuota
            if (data.beni.length === 0) {
                const firstRow = document.createElement('div');
                firstRow.className = 'bene-row form-row';
                firstRow.dataset.index = 0;
                firstRow.innerHTML = `
                    <input type="hidden" name="beni[0][id]" class="bene-id" value="">
                    <div class="input-group flex-2">
                        <label>Bene (Descrizione)</label>
                        <input type="text" name="beni[0][descrizione]" class="one-ui-input bene-desc" required>
                    </div>
                    <div class="input-group flex-1">
                        <label>Valore Bene (€)</label>
                        <input type="text" name="beni[0][valore]" class="one-ui-input currency-input bene-valore"
                            oninput="formatCurrencyInput(this)" onblur="formatCurrencyBlur(this)">
                    </div>
                    <div class="input-group flex-1">
                        <label>Importo Offerta (€)</label>
                        <input type="text" name="beni[0][importo_offerta]" class="one-ui-input currency-input bene-importo"
                            oninput="formatCurrencyInput(this); calcolaTotaleOfferta();" onblur="formatCurrencyBlur(this); calcolaTotaleOfferta();">
                    </div>
                    <div class="input-group btn-remove-group" style="display:none;">
                        <button type="button" class="btn-remove-bene" onclick="removeBene(this)">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(firstRow);
                beneIndex = 1;
            }
            
            updateRemoveButtons();
            
            // Compila importi revisione e caricamento
            if (data.has_revisore && data.importo_revisione) {
                document.getElementById('impRevisione').value = formatCurrency(data.importo_revisione || 0);
            } else {
                document.getElementById('impRevisione').value = formatCurrency(0);
            }
            
            if (data.has_caricamento && data.importo_caricamento) {
                document.getElementById('impCaricamento').value = formatCurrency(data.importo_caricamento || 0);
            } else {
                document.getElementById('impCaricamento').value = formatCurrency(0);
            }
            
            // Compila origine e redattore
            document.getElementById('selOrigine').value = data.origine || '';
            document.getElementById('selRedattore').value = data.redattore || '';
            document.getElementById('inpEsterno').value = data.nome_esterno || '';
            document.getElementById('inpCollaboratore').value = data.collaboratore || '';

            // Compila checkbox e importi
            document.getElementById('chkRevisione').checked = data.has_revisore;
            document.getElementById('chkCaricamento').checked = data.has_caricamento;
            document.getElementById('chkSpeseAmm').checked = !!data.spese_amministrative;
            
            // Compila nomi revisore e caricamento
            document.getElementById('inpNomeRevisore').value = data.nome_revisore || '';
            document.getElementById('inpNomeCaricamento').value = data.nome_caricamento || '';

            // Se siamo entrati da "Revisiona Offerta", mostra il bottone dedicato
            const revBtn = document.getElementById('btnRevisionaOfferta');
            const saveBtn = document.getElementById('btnSaveLavoro');
            if (revBtn) {
                const generated = !!data.data_offerta; // offerta già emessa
                revBtn.style.display = (revisioneOffertaMode && generated) ? 'block' : 'none';
            }
            if (saveBtn) {
                const generated = !!data.data_offerta;
                saveBtn.style.display = (revisioneOffertaMode && generated) ? 'none' : 'inline-block';
            }

            // Aggiorna toggle PRIMA di impostare i valori (per mostrare i campi)
            // Ma NON chiamare calcolaCompensi() ancora, lo faremo dopo aver impostato i valori
            const hasRev = data.has_revisore;
            const hasCar = data.has_caricamento;
            
            document.getElementById('chkRevisione').checked = hasRev;
            document.getElementById('chkCaricamento').checked = hasCar;
            
            // Mostra/nascondi i campi senza ricalcolare
            document.getElementById('divImportoRevisione').style.display = hasRev ? 'block' : 'none';
            document.getElementById('divImportoCaricamento').style.display = hasCar ? 'block' : 'none';
            document.getElementById('revOptions').style.display = hasRev ? 'flex' : 'none';
            document.getElementById('fieldRev').style.display = hasRev ? 'block' : 'none';
            document.getElementById('carOptions').style.display = hasCar ? 'flex' : 'none';
            document.getElementById('fieldCar').style.display = hasCar ? 'block' : 'none';
            document.getElementById('togglesRevCar').style.display = (hasRev || hasCar) ? 'flex' : 'none';
            
            toggleExtInput();
            
            // Imposta i valori per revisore e caricamento dai dati salvati DOPO aver mostrato i campi
            // Usa setTimeout per assicurarsi che i campi siano visibili
            setTimeout(() => {
                console.log('Dati ricevuti dall\'API:', {
                    has_revisore: data.has_revisore,
                    rev_type: data.rev_type,
                    rev_value: data.rev_value,
                    has_caricamento: data.has_caricamento,
                    car_type: data.car_type,
                    car_value: data.car_value
                });
                
                if (data.has_revisore) {
                    const revType = data.rev_type || 'perc';
                    const revValue = parseFloat(data.rev_value) || 0;
                    console.log('Imposto revisore - tipo:', revType, 'valore:', revValue);
                    document.getElementById('revType').value = revType;
                    if (revType === 'euro') {
                        const formatted = formatCurrency(revValue);
                        console.log('Valore formattato (euro):', formatted);
                        document.getElementById('revVal').value = formatted;
                    } else {
                        // Per percentuali, mostra il valore come numero intero se possibile
                        const valStr = (revValue % 1 === 0) ? Math.round(revValue).toString() : revValue.toString();
                        console.log('Valore (percentuale):', valStr);
                        document.getElementById('revVal').value = valStr;
                    }
                    console.log('Valore finale nel campo revVal:', document.getElementById('revVal').value);
                } else {
                    document.getElementById('revType').value = 'perc';
                    document.getElementById('revVal').value = '0';
                }
                
                if (data.has_caricamento) {
                    const carType = data.car_type || 'perc';
                    const carValue = parseFloat(data.car_value) || 0;
                    console.log('Imposto caricamento - tipo:', carType, 'valore:', carValue);
                    document.getElementById('carType').value = carType;
                    if (carType === 'euro') {
                        const formatted = formatCurrency(carValue);
                        console.log('Valore formattato (euro):', formatted);
                        document.getElementById('carVal').value = formatted;
                    } else {
                        // Per percentuali, mostra il valore come numero intero se possibile
                        const valStr = (carValue % 1 === 0) ? Math.round(carValue).toString() : carValue.toString();
                        console.log('Valore (percentuale):', valStr);
                        document.getElementById('carVal').value = valStr;
                    }
                    console.log('Valore finale nel campo carVal:', document.getElementById('carVal').value);
                } else {
                    document.getElementById('carType').value = 'perc';
                    document.getElementById('carVal').value = '0';
                }
                
                // Imposta i valori per esterno se origine è 'ext'
                if (data.origine === 'ext') {
                    const extType = data.ext_type || 'perc';
                    const extValue = parseFloat(data.ext_value) || 0;
                    console.log('Imposto esterno - tipo:', extType, 'valore:', extValue);
                    document.getElementById('extType').value = extType;
                    if (extType === 'euro') {
                        const formatted = formatCurrency(extValue);
                        document.getElementById('extVal').value = formatted;
                    } else {
                        const valStr = extValue.toString().replace('.', ',');
                        document.getElementById('extVal').value = valStr;
                    }
                    console.log('Valore finale nel campo extVal:', document.getElementById('extVal').value);
                } else {
                    document.getElementById('extType').value = 'perc';
                    document.getElementById('extVal').value = '0';
                }
                
                // Assicurati che gli importi di revisione e caricamento siano impostati prima di ricalcolare
                // (potrebbero essere stati sovrascritti da calcolaCompensi se chiamato prima)
                if (data.has_revisore && data.importo_revisione) {
                    document.getElementById('impRevisione').value = formatCurrency(data.importo_revisione || 0);
                }
                if (data.has_caricamento && data.importo_caricamento) {
                    document.getElementById('impCaricamento').value = formatCurrency(data.importo_caricamento || 0);
                }
                
                // Ricalcola i compensi dopo aver impostato tutti i valori
                calcolaCompensi();
            }, 100);
            
            // Compila compensi (senza ricalcolare, usa i valori salvati)
            setCurrencyValue('c_fe', data.c_fe || 0);
            setCurrencyValue('c_amin', data.c_amin || 0);
            setCurrencyValue('c_galvan', data.c_galvan || 0);
            setCurrencyValue('c_fh', data.c_fh || 0);
            // Per BIANC e DELOITTE, imposta 0,00 se vuoto o null
            setCurrencyValue('c_bianc', data.c_bianc || 0);
            setCurrencyValue('c_deloitte', data.c_deloitte || 0);
            setCurrencyValue('c_ext', data.c_ext || 0);
            setCurrencyValue('c_revisore', data.c_revisore || 0);
            setCurrencyValue('c_caricamento', data.c_caricamento || 0);
            
            // Assicurati che BIANC e DELOITTE mostrino 0,00 se vuoti quando sono selezionati
            const origine = document.getElementById('selOrigine').value;
            const redattore = document.getElementById('selRedattore').value;
            if (origine === 'BIANC' || redattore === 'BIANC') {
                const biancInput = document.getElementById('c_bianc');
                if (biancInput && (!biancInput.value || biancInput.value === '')) {
                    biancInput.value = '0,00';
                }
            }
            if (origine === 'DELOITTE' || redattore === 'DELOITTE') {
                const deloitteInput = document.getElementById('c_deloitte');
                if (deloitteInput && (!deloitteInput.value || deloitteInput.value === '')) {
                    deloitteInput.value = '0,00';
                }
            }
            
        } catch (error) {
            console.error('Errore nel caricamento del lavoro:', error);
            alert('Errore nel caricamento dei dati del lavoro');
        }
    }

    function updateField(id, field, value) {
        fetch(`/update_lavoro_field/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field: field, value: value })
        });
    }

    function openAddModal() {
        document.getElementById('addModal').classList.add('active');

        // --- FIX: BLOCCA LO SCROLL DELLA PAGINA DIETRO ---
        document.body.style.overflow = 'hidden';
        // -------------------------------------------------

        // Reset titolo
        document.getElementById('modalTitle').textContent = 'Nuovo Lavoro';
        
        // Reset ID lavoro (per nuovo lavoro)
        document.getElementById('lavoroId').value = '';

        document.getElementById('formAddLavoro').reset();
        document.getElementById('alertCompensi').style.display = 'none';
        // Reset pulsanti revisione
        revisioneOffertaMode = false;
        const revBtn = document.getElementById('btnRevisionaOfferta');
        const saveBtn = document.getElementById('btnSaveLavoro');
        if (revBtn) revBtn.style.display = 'none';
        if (saveBtn) saveBtn.style.display = 'inline-block';

        // Reset beni
        const container = document.getElementById('beniContainer');
        const rows = container.querySelectorAll('.bene-row');
        rows.forEach((row, i) => { if (i > 0) row.remove(); });
        beneIndex = 1;
        updateRemoveButtons();

        toggleSpese();
        toggleExtInput();
    }

    function closeAddModal() {
        document.getElementById('addModal').classList.remove('active');

        // --- FIX: RIATTIVA LO SCROLL DELLA PAGINA ---
        document.body.style.overflow = '';
        // --------------------------------------------
    }

    /* ==================== CALCOLO COMPENSI ==================== */
    function toggleSpese() {
        const hasRev = document.getElementById('chkRevisione').checked;
        const hasCar = document.getElementById('chkCaricamento').checked;
        const origine = document.getElementById('selOrigine').value;
        const isExt = origine === 'ext';

        document.getElementById('divImportoRevisione').style.display = hasRev ? 'block' : 'none';
        document.getElementById('divImportoCaricamento').style.display = hasCar ? 'block' : 'none';

        document.getElementById('revOptions').style.display = hasRev ? 'flex' : 'none';
        document.getElementById('fieldRev').style.display = hasRev ? 'block' : 'none';

        document.getElementById('carOptions').style.display = hasCar ? 'flex' : 'none';
        document.getElementById('fieldCar').style.display = hasCar ? 'block' : 'none';

        // Aggiorna la visibilità del toggle row includendo anche ext
        document.getElementById('togglesRevCar').style.display = (hasRev || hasCar || isExt) ? 'flex' : 'none';

        calcolaCompensi();
    }

    function calcolaCompensi() {
        const origine = document.getElementById('selOrigine').value;
        const redattore = document.getElementById('selRedattore').value;
        
        // Non calcolare i compensi finché origine e redattore non sono entrambi selezionati
        if (!origine || !redattore) {
            // Nascondi eventuali alert e esci senza calcolare
            const alertDiv = document.getElementById('alertCompensi');
            if (alertDiv) {
                alertDiv.style.display = 'none';
            }
            return; // Esci dalla funzione senza calcolare
        }

        // Se c'è BIANC o DELOITTE in origine o redattore, inserimento manuale (non calcolare automaticamente)
        if (origine === 'BIANC' || redattore === 'BIANC' || origine === 'DELOITTE' || redattore === 'DELOITTE') {
            // Non calcolare i compensi, lasciare i valori esistenti (inserimento manuale)
            const alertDiv = document.getElementById('alertCompensi');
            if (alertDiv) {
                alertDiv.style.display = 'none'; // Nascondi eventuali alert precedenti
            }
            return; // Esci dalla funzione senza calcolare
        }

        // Totale Offerta 4.0 (somma importi offerta dei beni)
        const importoOfferta = parseCurrency(document.getElementById('impOfferta').value);
        const importoRevisione = parseCurrency(document.getElementById('impRevisione').value);
        const importoCaricamento = parseCurrency(document.getElementById('impCaricamento').value);

        const hasSpeseAmm = document.getElementById('chkSpeseAmm').checked;
        const hasRevisione = document.getElementById('chkRevisione').checked;
        const hasCaricamento = document.getElementById('chkCaricamento').checked;

        // Totale Lavoro = Totale Offerta 4.0 + Offerta Revisione + Offerta Caricamento
        const totaleLavoro = importoOfferta + importoRevisione + importoCaricamento;

        // 1. SPESE AMM (6%) - calcolate su Totale Lavoro
        let speseAmm = 0;
        if (hasSpeseAmm) {
            speseAmm = totaleLavoro * 0.06;
        }

        // 2. ESTERNO - calcola il compenso (percentuale o euro)
        let valExt = 0;
        if (origine === 'ext') {
            const extType = document.getElementById('extType').value;
            let rawExtVal = document.getElementById('extVal').value;

            if (extType === 'euro') {
                valExt = parseCurrency(rawExtVal);
            } else {
                const extPerc = parseFloat(rawExtVal.replace(',', '.')) || 0;
                // Calcolato su Totale Offerta 4.0 (NON su totale lavoro)
                valExt = (importoOfferta * extPerc / 100);
            }
        }

        // 3. REVISORE - calcola il compenso
        let valRev = 0;
        let diffRevisione = 0; // Differenza tra importo revisione e compenso revisore → va a FE
        if (hasRevisione) {
            const revType = document.getElementById('revType').value;
            let rawRevVal = document.getElementById('revVal').value;

            if (revType === 'euro') {
                valRev = parseCurrency(rawRevVal);
            } else {
                const revPerc = parseFloat(rawRevVal.replace(',', '.')) || 0;
                valRev = (totaleLavoro * revPerc / 100);
            }
            
            // Calcola la differenza tra importo revisione e compenso revisore
            diffRevisione = importoRevisione - valRev;
            if (diffRevisione < 0) diffRevisione = 0; // Non consideriamo differenze negative
        }

        // 4. CARICAMENTO - calcola il compenso
        let valCar = 0;
        let diffCaricamento = 0; // Differenza tra importo caricamento e compenso caricamento → va a FE
        if (hasCaricamento) {
            const carType = document.getElementById('carType').value;
            let rawCarVal = document.getElementById('carVal').value;

            if (carType === 'euro') {
                valCar = parseCurrency(rawCarVal);
            } else {
                const carPerc = parseFloat(rawCarVal.replace(',', '.')) || 0;
                valCar = (totaleLavoro * carPerc / 100);
            }
            
            // Calcola la differenza tra importo caricamento e compenso caricamento
            diffCaricamento = importoCaricamento - valCar;
            if (diffCaricamento < 0) diffCaricamento = 0; // Non consideriamo differenze negative
        }

        // 5. Calcola BASE per il 15% FE
        // Base = Totale Lavoro - C.Rev - C.Car - DiffRev - DiffCar - C.Ext
        let basePer15 = totaleLavoro - valRev - valCar - diffRevisione - diffCaricamento - valExt;

        // 6. FE 15% - calcolato sulla base
        const fe15 = basePer15 * 0.15;
        
        // 7. C.FE totale = Differenze + Spese Amm + 15%
        let valFE = diffRevisione + diffCaricamento + speseAmm + fe15;

        // 8. Resto per lo split = Base - 15%
        let resto = basePer15 - fe15;

        // 9. SPLIT RESTO
        let valAmin = 0, valGalvan = 0, valFH = 0, valBianc = 0, valDeloitte = 0;

        if (origine === 'BIANC' || origine === 'DELOITTE') {
            // Manuale
        } else if (origine === 'ext') {
            valFH = resto * 0.30;
            if (redattore === 'AMIN') valAmin = resto * 0.70;
            else if (redattore === 'GALVAN') valGalvan = resto * 0.70;
            else if (redattore === 'BIANC') valBianc = resto * 0.70;
            else if (redattore === 'DELOITTE') valDeloitte = resto * 0.70;
        } else if (origine === 'AMIN' && redattore === 'AMIN') {
            valAmin = resto * 0.70;
            valFH = resto * 0.30;
        } else if (origine === 'GALVAN' && redattore === 'GALVAN') {
            valGalvan = resto * 0.70;
            valFH = resto * 0.30;
        } else if (origine === 'FH') {
            valFH = resto * 0.50;
            if (redattore === 'AMIN') valAmin = resto * 0.50;
            else if (redattore === 'GALVAN') valGalvan = resto * 0.50;
        }

        setCurrencyValue('c_fe', valFE);
        setCurrencyValue('c_amin', valAmin);
        setCurrencyValue('c_galvan', valGalvan);
        setCurrencyValue('c_fh', valFH);
        setCurrencyValue('c_bianc', valBianc);
        setCurrencyValue('c_deloitte', valDeloitte);
        setCurrencyValue('c_ext', valExt);
        setCurrencyValue('c_revisore', valRev);
        setCurrencyValue('c_caricamento', valCar);

        // Aggiorna la visibilità dei campi in base ai valori calcolati
        updateCompensiFieldsVisibility(valFE, valAmin, valGalvan, valFH, valBianc, valDeloitte, valExt, valRev, valCar);

        const allValues = [valFE, valAmin, valGalvan, valFH, valBianc, valExt, valRev, valCar, resto];
        const hasNegative = allValues.some(v => v < -0.01);

        const alertDiv = document.getElementById('alertCompensi');
        if (hasNegative) {
            alertDiv.style.display = 'flex';
            document.getElementById('alertCompensiText').textContent = 'Attenzione: alcuni compensi risultano negativi!';
        } else {
            alertDiv.style.display = 'none';
        }
    }

    function toggleExtInput() {
        const origine = document.getElementById('selOrigine').value;
        const redattore = document.getElementById('selRedattore').value;
        const isExt = origine === 'ext';
        const isBianc = origine === 'BIANC' || redattore === 'BIANC';
        const isDeloitte = origine === 'DELOITTE' || redattore === 'DELOITTE';

        document.getElementById('divNomeEsterno').style.display = isExt ? 'block' : 'none';
        
        // Mostra/nascondi il campo per il compenso esterno
        const extOptions = document.getElementById('extOptions');
        if (extOptions) {
            extOptions.style.display = isExt ? 'flex' : 'none';
            // Se è la prima volta che si seleziona ext e il valore è 0, imposta il default a 10%
            if (isExt) {
                const extValInput = document.getElementById('extVal');
                if (extValInput && (!extValInput.value || extValInput.value === '0' || extValInput.value === '0,00')) {
                    extValInput.value = '10';
                    document.getElementById('extType').value = 'perc';
                }
            }
        }
        
        // Aggiorna la visibilità del toggle row
        const togglesRow = document.getElementById('togglesRevCar');
        if (togglesRow) {
            const hasRev = document.getElementById('chkRevisione').checked;
            const hasCar = document.getElementById('chkCaricamento').checked;
            togglesRow.style.display = (hasRev || hasCar || isExt) ? 'flex' : 'none';
        }
        
        // Per BIANC e DELOITTE, mostra sempre i campi e imposta 0,00 se vuoti
        if (isBianc) {
            const biancField = document.getElementById('fieldBianc');
            if (biancField) {
                biancField.style.display = 'block';
                const biancInput = document.getElementById('c_bianc');
                if (biancInput && !biancInput.value) {
                    biancInput.value = '0,00';
                }
            }
        } else {
            document.getElementById('fieldBianc').style.display = 'none';
        }
        
        if (isDeloitte) {
            const deloitteField = document.getElementById('fieldDeloitte');
            if (deloitteField) {
                deloitteField.style.display = 'block';
                const deloitteInput = document.getElementById('c_deloitte');
                if (deloitteInput && !deloitteInput.value) {
                    deloitteInput.value = '0,00';
                }
            }
        } else {
            const deoField = document.getElementById('fieldDeloitte');
            if (deoField) deoField.style.display = 'none';
        }
        
        // Per Ext, mostra solo se origine è ext (gestito da updateCompensiFieldsVisibility per i calcoli)
        // Ma qui lo mostriamo sempre se origine è ext
        document.getElementById('fieldExt').style.display = isExt ? 'block' : 'none';
    }
    
    function updateCompensiFieldsVisibility(valFE, valAmin, valGalvan, valFH, valBianc, valDeloitte, valExt, valRev, valCar) {
        const origine = document.getElementById('selOrigine').value;
        const redattore = document.getElementById('selRedattore').value;
        const isManual = origine === 'BIANC' || redattore === 'BIANC' || origine === 'DELOITTE' || redattore === 'DELOITTE';
        
        // Se è modalità manuale (BIANC o DELOITTE), mostra solo i campi rilevanti
        if (isManual) {
            // Mostra sempre FE
            document.getElementById('fieldFE').style.display = 'block';
            // Mostra Ext solo se origine è ext
            document.getElementById('fieldExt').style.display = (origine === 'ext') ? 'block' : 'none';
            // Mostra Revisore e Caricamento solo se hanno valore > 0
            const revField = document.getElementById('fieldRev');
            if (revField) revField.style.display = valRev > 0 ? 'block' : 'none';
            const carField = document.getElementById('fieldCar');
            if (carField) carField.style.display = valCar > 0 ? 'block' : 'none';
            // Nascondi gli altri campi che non sono rilevanti
            document.getElementById('fieldAmin').style.display = 'none';
            document.getElementById('fieldGalvan').style.display = 'none';
            document.getElementById('fieldFH').style.display = 'none';
            // BIANC e DELOITTE vengono gestiti da toggleExtInput
            toggleExtInput();
            return;
        }
        
        // Modalità calcolo automatico: mostra solo i campi con valore > 0
        document.getElementById('fieldFE').style.display = valFE > 0 ? 'block' : 'none';
        document.getElementById('fieldAmin').style.display = valAmin > 0 ? 'block' : 'none';
        document.getElementById('fieldGalvan').style.display = valGalvan > 0 ? 'block' : 'none';
        document.getElementById('fieldFH').style.display = valFH > 0 ? 'block' : 'none';
        document.getElementById('fieldExt').style.display = valExt > 0 ? 'block' : 'none';
        const revField = document.getElementById('fieldRev');
        if (revField) revField.style.display = valRev > 0 ? 'block' : 'none';
        const carField = document.getElementById('fieldCar');
        if (carField) carField.style.display = valCar > 0 ? 'block' : 'none';
        // BIANC e DELOITTE non vengono mostrati in modalità automatica (solo se selezionati manualmente)
        document.getElementById('fieldBianc').style.display = 'none';
        const deoField = document.getElementById('fieldDeloitte');
        if (deoField) deoField.style.display = 'none';
    }

    function validateForm() {
        const alertDiv = document.getElementById('alertCompensi');
        if (alertDiv.style.display !== 'none') {
            alert('Impossibile salvare: ci sono compensi negativi.');
            return false;
        }

        // Validazione Revisore
        if (document.getElementById('chkRevisione').checked) {
            const revInputVal = parseCurrency(document.getElementById('revVal').value);
            if (revInputVal <= 0) {
                alert('Hai attivato "Revisione" ma non hai inserito il compenso.');
                document.getElementById('revVal').focus();
                return false;
            }
        }

        // Validazione Caricamento
        if (document.getElementById('chkCaricamento').checked) {
            const carInputVal = parseCurrency(document.getElementById('carVal').value);
            if (carInputVal <= 0) {
                alert('Hai attivato "Caricamento" ma non hai inserito il compenso.');
                document.getElementById('carVal').focus();
                return false;
            }
        }

        // Converti tutti i valori currency in formato italiano (numero puro con virgola decimale)
        // Esempio: "1.170,75" -> "1170,75" (rimuove separatori migliaia, mantiene virgola decimale)
        document.querySelectorAll('.currency-input').forEach(input => {
            const numValue = parseCurrency(input.value); // Converte in numero (es. 1170.75)
            // Converti in formato italiano: numero puro con virgola decimale (es. "1170,75")
            input.value = numValue.toFixed(2).replace('.', ',');
        });
        
        // Converti i valori di revisore e caricamento prima di inviare
        // Per le percentuali, mantieni il valore numerico semplice
        // Per gli euro, converti in formato numerico (senza formattazione valuta nel campo)
        const revType = document.getElementById('revType').value;
        const revValInput = document.getElementById('revVal');
        if (revType === 'euro') {
            // Se è euro, converti in formato italiano (numero puro con virgola decimale)
            const val = parseCurrency(revValInput.value);
            revValInput.value = val.toFixed(2).replace('.', ',');
        } else {
            // Se è percentuale, mantieni il valore come numero con virgola decimale
            const val = parseFloat(revValInput.value.replace(',', '.')) || 0;
            revValInput.value = val.toString().replace('.', ',');
        }
        
        const carType = document.getElementById('carType').value;
        const carValInput = document.getElementById('carVal');
        if (carType === 'euro') {
            // Se è euro, converti in formato italiano (numero puro con virgola decimale)
            const val = parseCurrency(carValInput.value);
            carValInput.value = val.toFixed(2).replace('.', ',');
        } else {
            // Se è percentuale, mantieni il valore come numero con virgola decimale
            const val = parseFloat(carValInput.value.replace(',', '.')) || 0;
            carValInput.value = val.toString().replace('.', ',');
        }
        
        // Converti anche il valore esterno se presente
        const origine = document.getElementById('selOrigine').value;
        if (origine === 'ext') {
            const extType = document.getElementById('extType').value;
            const extValInput = document.getElementById('extVal');
            if (extType === 'euro') {
                // Se è euro, converti in formato italiano (numero puro con virgola decimale)
                const val = parseCurrency(extValInput.value);
                extValInput.value = val.toFixed(2).replace('.', ',');
            } else {
                // Se è percentuale, mantieni il valore come numero con virgola decimale
                const val = parseFloat(extValInput.value.replace(',', '.')) || 0;
                extValInput.value = val.toString().replace('.', ',');
            }
        }
        
        return true;
    }

    // Inizializzazione
    toggleExtInput();
    toggleSpese();
    
    // Fix per header sticky in modalità EXTRA 1
    {% if view_mode == 'extra1' %}
    function initExtra1FixedScrollbar() {
        const scroller = document.getElementById('extra1TableScroll');
        const bar = document.getElementById('extra1FixedHScroll');
        const inner = document.getElementById('extra1FixedHScrollInner');
        const table = document.querySelector('#extra1TableScroll .table-expanded');
        if (!scroller || !bar || !inner || !table) return;

        const syncSizes = () => {
            // larghezza scrollabile reale
            const w = table.scrollWidth;
            inner.style.width = w + 'px';
            // mostra la barra solo se serve
            bar.style.display = (w > scroller.clientWidth + 2) ? 'block' : 'none';
        };

        let lock = false;
        scroller.addEventListener('scroll', () => {
            if (lock) return;
            lock = true;
            bar.scrollLeft = scroller.scrollLeft;
            lock = false;
        }, { passive: true });

        bar.addEventListener('scroll', () => {
            if (lock) return;
            lock = true;
            scroller.scrollLeft = bar.scrollLeft;
            lock = false;
        }, { passive: true });

        // prima sync
        syncSizes();
        // sync dopo layout/fonts
        window.requestAnimationFrame(syncSizes);
        window.addEventListener('resize', syncSizes);
    }

    function initExtra1StickyHeader() {
        const scroller = document.getElementById('extra1TableScroll');
        const fixedHeader = document.getElementById('extra1StickyHeader');
        const fixedScroll = document.getElementById('extra1StickyHeaderScroll');
        const table = document.querySelector('#extra1TableScroll .table-expanded');
        const headerSection = document.querySelector('.header-section');
        if (!scroller || !fixedHeader || !fixedScroll || !table || !headerSection) return;

        const thead = table.querySelector('thead');
        if (!thead) return;

        // Costruisci tabella header clonata (solo thead)
        fixedScroll.innerHTML = '';
        const headerTable = document.createElement('table');
        headerTable.className = 'oneui-table table-expanded';
        headerTable.appendChild(thead.cloneNode(true));
        fixedScroll.appendChild(headerTable);

        // Funzione per sincronizzare le larghezze delle colonne
        const syncColumnWidths = () => {
            const originalHeaders = thead.querySelectorAll('th');
            const clonedHeaders = headerTable.querySelectorAll('th');
            
            if (originalHeaders.length !== clonedHeaders.length) return;
            
            originalHeaders.forEach((original, index) => {
                const cloned = clonedHeaders[index];
                if (original && cloned) {
                    const width = original.getBoundingClientRect().width;
                    cloned.style.width = `${width}px`;
                    cloned.style.minWidth = `${width}px`;
                    cloned.style.maxWidth = `${width}px`;
                }
            });
        };

        const syncH = () => {
            // sync orizzontale
            fixedScroll.scrollLeft = scroller.scrollLeft;
        };

        const update = () => {
            const headerRect = headerSection.getBoundingClientRect();
            const scrollerRect = scroller.getBoundingClientRect();
            const theadHeight = thead.getBoundingClientRect().height || 50;

            const top = Math.ceil(headerRect.bottom);
            const shouldShow = (scrollerRect.top <= top) && (scrollerRect.bottom > top + theadHeight);

            if (!shouldShow) {
                fixedHeader.style.display = 'none';
                return;
            }

            // Sincronizza le larghezze delle colonne prima di mostrare
            syncColumnWidths();
            
            fixedHeader.style.display = 'block';
            fixedHeader.style.top = `${top}px`;
            fixedHeader.style.left = `${Math.ceil(scrollerRect.left)}px`;
            fixedHeader.style.width = `${Math.ceil(scrollerRect.width)}px`;
            syncH();
        };

        // listeners
        scroller.addEventListener('scroll', syncH, { passive: true });
        window.addEventListener('scroll', update, { passive: true });
        window.addEventListener('resize', () => {
            syncColumnWidths();
            update();
        });

        // prima render
        setTimeout(() => {
            syncColumnWidths();
            update();
        }, 100);
    }
    
    // Esegui al caricamento
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            initExtra1FixedScrollbar();
            initExtra1StickyHeader();
        });
    } else {
        initExtra1FixedScrollbar();
        initExtra1StickyHeader();
    }
    {% endif %}


</script>

{% endblock %}