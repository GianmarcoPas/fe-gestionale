{% extends "base.html" %}

{% block content %}

<div class="dashboard-header">
    <h2>Ciao, {{ current_user.username }} ðŸ‘‹</h2>
    <p class="subtitle">
        {% if role == 'admin' %}
            Panoramica Finanziaria e Gestionale.
        {% else %}
            Ecco la situazione aggiornata dei tuoi lavori.
        {% endif %}
    </p>
</div>

{% if role == 'admin' %}
    <div class="admin-top-section">
        
        <div class="card-widget-revenue" style="transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
            <div class="background-design">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="info-section">
                    <div class="left-side">
                    <div class="temperature" id="displayAmount">
                        {% if tot_importo is defined %}
                            â‚¬ {{ "{:,.2f}".format(tot_importo).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        {% else %}
                            â‚¬ 0,00
                        {% endif %}
                    </div>
                    <div class="date" id="displayName">Totale Lavori</div>
                </div>
            </div>
            <div class="days-section">
                <a href="{{ url_for('main.fatturazione', tipo='fe') }}" class="days-section-link" onmouseenter="updateWidget('FE', '{{ tot_fe }}')" onmouseleave="resetWidget()">
                    <button>FE</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='amin') }}" class="days-section-link" onmouseenter="updateWidget('AMIN', '{{ tot_amin }}')" onmouseleave="resetWidget()">
                    <button>AMIN</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='galvan') }}" class="days-section-link" onmouseenter="updateWidget('GALV', '{{ tot_galvan }}')" onmouseleave="resetWidget()">
                    <button>GALV</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='fh') }}" class="days-section-link" onmouseenter="updateWidget('FH', '{{ tot_fh }}')" onmouseleave="resetWidget()">
                    <button>FH</button>
                </a>
            </div>
        </div>

        <div class="admin-stats-grid">
            
            <a href="{{ url_for('main.lavori_admin', filtro_stato='tutti') }}" style="text-decoration: none; color: inherit;">
                <div class="card-styled style-blue" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
                    <div class="background-design pos-variant-1">
                        <div class="circle"></div>
                        <div class="circle"></div>
                        <div class="circle"></div>
                    </div>
                    <div class="card-content-centered">
                        <div class="card-icon-large"><i class="bi bi-folder-fill"></i></div>
                        <div class="card-number-large">{{ total_lavori }}</div>
                        <div class="card-label-large">Totale Lavori</div>
                    </div>
                </div>
            </a>

            <a href="{{ url_for('main.lavori_admin', filtro_stato='in_lavorazione') }}" style="text-decoration: none; color: inherit;">
                <div class="card-styled style-orange" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
                    <div class="background-design pos-variant-2">
                        <div class="circle"></div>
                        <div class="circle"></div>
                        <div class="circle"></div>
                    </div>
                    <div class="card-content-centered">
                        <div class="card-icon-large"><i class="bi bi-clock-history"></i></div>
                        <div class="card-number-large">{{ in_corso }}</div>
                        <div class="card-label-large">In Lavorazione</div>
                    </div>
                </div>
            </a>

            <a href="{{ url_for('main.lavori_admin', filtro_stato='completati') }}" style="text-decoration: none; color: inherit;">
                <div class="card-styled style-green" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
                    <div class="background-design pos-variant-3">
                        <div class="circle"></div>
                        <div class="circle"></div>
                        <div class="circle"></div>
                    </div>
                    <div class="card-content-centered">
                        <div class="card-icon-large"><i class="bi bi-check-circle-fill"></i></div>
                        <div class="card-number-large">{{ completati }}</div>
                        <div class="card-label-large">Completati</div>
                    </div>
                </div>
            </a>

        </div>
    </div>

    <div class="oneui-card mt-4">
        <div class="card-header-row">
            <h4>Timeline Lavori (Admin)</h4>
            <span class="badge">{{ timeline[0].label }}</span>
        </div>
        <div class="timeline-placeholder" style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
            {% for item in timeline %}
            <div class="timeline-row">
                <div style="font-size: 0.85rem; font-weight: 600; width: 40px;">{{ item.label }}</div>
                <div style="flex: 1; background: #f0f0f0; border-radius: 10px; height: 12px; position: relative; overflow: hidden;">
                    <div class="fake-bar" style="width: {{ item.width }}%; background: {{ item.color }}; height: 100%; border-radius: 10px;"></div>
                </div>
                <div style="font-size: 0.8rem; color: #888; width: 30px; text-align: right;">{{ item.count }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <script>
        const defaultAmount = "{% if tot_importo is defined %}â‚¬ {{ '{:,.2f}'.format(tot_importo).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}â‚¬ 0,00{% endif %}";
        const defaultName = "Totale Lavori";
        
        function formatCurrency(value) {
            // Formatta: â‚¬ prima, punto per migliaia, virgola per decimali
            let num = parseFloat(value) || 0;
            // Usa toFixed per avere sempre 2 decimali
            let numStr = num.toFixed(2);
            // Separa parte intera e decimale
            let parts = numStr.split('.');
            let integerPart = parts[0];
            let decimalPart = parts[1] || '00';
            
            // Aggiungi punti come separatori delle migliaia
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            return 'â‚¬ ' + integerPart + ',' + decimalPart;
        }
        
        function updateWidget(name, amount) {
            let formatted = formatCurrency(amount);
            document.getElementById('displayAmount').innerText = formatted;
            document.getElementById('displayName').innerText = "Compenso " + name;
        }
        function resetWidget() {
            document.getElementById('displayAmount').innerText = defaultAmount;
            document.getElementById('displayName').innerText = defaultName;
        }
    </script>

{% else %}

    <div class="oneui-grid">
        
        <div class="card-styled style-blue">
            <div class="background-design pos-variant-1">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-folder-fill"></i></div>
                <div class="card-number-large">{{ total_lavori }}</div>
                <div class="card-label-large">Lavori Attivi</div>
            </div>
        </div>

        <div class="card-styled style-orange">
            <div class="background-design pos-variant-2">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-clock-history"></i></div>
                <div class="card-number-large">{{ in_corso }}</div>
                <div class="card-label-large">In Lavorazione</div>
            </div>
        </div>

        <div class="card-styled style-green">
            <div class="background-design pos-variant-3">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-check-circle-fill"></i></div>
                <div class="card-number-large">{{ completati }}</div>
                <div class="card-label-large">Completati</div>
            </div>
        </div>

        <div class="oneui-card span-col-2" style="max-height: 240px; overflow-y: auto;"> <div class="card-header-row">
                <h4>AttivitÃ  Recente</h4>
                <span class="badge">{{ timeline[0].label }}</span>
            </div>
            <div class="timeline-placeholder" style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
                {% for item in timeline %}
                <div class="timeline-row">
                    <div style="font-size: 0.85rem; font-weight: 600; width: 40px;">{{ item.label }}</div>
                    <div style="flex: 1; background: #f0f0f0; border-radius: 10px; height: 12px; position: relative; overflow: hidden;">
                        <div class="fake-bar" style="width: {{ item.width }}%; background: {{ item.color }}; height: 100%; border-radius: 10px;"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #888; width: 30px; text-align: right;">{{ item.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="oneui-card">
            <h4>Notifiche Recenti</h4>
            <ul class="notification-list">
                <li>
                    <span class="dot"></span>
                    <span class="text">Admin ha assegnato <b>Lavoro #45</b></span>
                </li>
                <li>
                    <span class="dot"></span>
                    <span class="text">Nuovo file caricato in <b>Industria 4.0</b></span>
                </li>
            </ul>
        </div>

    </div>

{% endif %}

{% endblock %}