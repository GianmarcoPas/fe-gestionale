{% extends "base.html" %}

{% block content %}

<div class="dashboard-header">
    <h2>Ciao, {{ current_user.username }} ðŸ‘‹</h2>
    <p class="subtitle">
        {% if role == 'admin' %}
            Panoramica Finanziaria e Gestionale.
        {% else %}
            Ecco la situazione aggiornata dei tuoi lavori.
        {% endif %}
    </p>
</div>

{% if role == 'admin' %}
    <!-- PRIMA RIGA: Fatturazione, Timeline, Note -->
    <div class="dashboard-first-row">
        <!-- Card Fatturazione -->
        <div class="card-widget-revenue" style="transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
            <div class="background-design">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="info-section">
                <div class="left-side">
                    <div class="temperature" id="displayAmount">
                        {% if tot_importo is defined %}
                            â‚¬ {{ "{:,.2f}".format(tot_importo).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        {% else %}
                            â‚¬ 0,00
                        {% endif %}
                    </div>
                    <div class="date" id="displayName">Totale Lavori</div>
                </div>
            </div>
            <div class="days-section">
                <a href="{{ url_for('main.fatturazione', tipo='fe') }}" class="days-section-link" onmouseenter="updateWidget('FE', '{{ tot_fe }}')" onmouseleave="resetWidget()">
                    <button>FE</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='amin') }}" class="days-section-link" onmouseenter="updateWidget('AMIN', '{{ tot_amin }}')" onmouseleave="resetWidget()">
                    <button>AMIN</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='galvan') }}" class="days-section-link" onmouseenter="updateWidget('GALV', '{{ tot_galvan }}')" onmouseleave="resetWidget()">
                    <button>GALV</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='fh') }}" class="days-section-link" onmouseenter="updateWidget('FH', '{{ tot_fh }}')" onmouseleave="resetWidget()">
                    <button>FH</button>
                </a>
            </div>
        </div>

        <!-- Card Timeline Lavori -->
        <div class="card-timeline-compact">
            <div class="card-header-row">
                <h4>Timeline Lavori</h4>
                <span class="badge">{{ timeline[0].label if timeline else 'N/A' }}</span>
            </div>
            <div class="timeline-placeholder-compact">
                {% for item in timeline %}
                <div class="timeline-row">
                    <div style="font-size: 0.75rem; font-weight: 600; width: 35px;">{{ item.label }}</div>
                    <div style="flex: 1; background: #f0f0f0; border-radius: 8px; height: 10px; position: relative; overflow: hidden;">
                        <div class="fake-bar" style="width: {{ item.width }}%; background: {{ item.color }}; height: 100%; border-radius: 8px;"></div>
                    </div>
                    <div style="font-size: 0.7rem; color: #888; width: 25px; text-align: right;">{{ item.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Card Note -->
        <div class="card-notes" onclick="apriModalNote()" style="cursor: pointer;">
            <div class="card-notes-header">
                <h4>Note
                    {% if nuove_note_count and nuove_note_count > 0 %}
                    <span class="badge-new-notes" id="badgeNuoveNote">{{ nuove_note_count }}</span>
                    {% endif %}
                </h4>
                <button class="btn-add-note" onclick="event.stopPropagation(); apriModalNuovaNota()" title="Aggiungi nota">
                    <i class="bi bi-plus-circle-fill"></i>
                </button>
            </div>
            <div class="card-notes-content">
                {% if tutte_note %}
                    {% for nota in tutte_note %}
                    <div class="nota-preview">
                        <div class="nota-preview-text">{{ nota.contenuto }}</div>
                        <div class="nota-preview-meta">
                            <span class="nota-autore">{{ nota.autore.username }}</span>
                            <span class="nota-data">{{ nota.created_at.strftime('%d/%m/%Y') }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="nota-empty">Nessuna nota ancora. Clicca + per aggiungerne una.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- SECONDA RIGA: 4 Card Stato Lavori -->
    <div class="dashboard-second-row">
        <a href="{{ url_for('main.lavori_admin', filtro_stato='tutti') }}" style="text-decoration: none; color: inherit;">
            <div class="card-styled style-blue" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
                <div class="background-design pos-variant-1">
                    <div class="circle"></div>
                    <div class="circle"></div>
                    <div class="circle"></div>
                </div>
                <div class="card-content-centered">
                    <div class="card-icon-large"><i class="bi bi-folder-fill"></i></div>
                    <div class="card-number-large">{{ total_lavori }}</div>
                    <div class="card-label-large">Totale Lavori</div>
                </div>
            </div>
        </a>

        <a href="{{ url_for('main.lavori_admin', filtro_stato='in_lavorazione') }}" style="text-decoration: none; color: inherit;">
            <div class="card-styled style-orange" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
                <div class="background-design pos-variant-2">
                    <div class="circle"></div>
                    <div class="circle"></div>
                    <div class="circle"></div>
                </div>
                <div class="card-content-centered">
                    <div class="card-icon-large"><i class="bi bi-clock-history"></i></div>
                    <div class="card-number-large">{{ in_corso }}</div>
                    <div class="card-label-large">In Lavorazione</div>
                </div>
            </div>
        </a>

        <a href="{{ url_for('main.lavori_admin', filtro_stato='completati') }}" style="text-decoration: none; color: inherit;">
            <div class="card-styled style-green" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
                <div class="background-design pos-variant-3">
                    <div class="circle"></div>
                    <div class="circle"></div>
                    <div class="circle"></div>
                </div>
                <div class="card-content-centered">
                    <div class="card-icon-large"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="card-number-large">{{ completati }}</div>
                    <div class="card-label-large">Completati</div>
                </div>
            </div>
        </a>

        <a href="{{ url_for('main.lavori_admin', filtro_stato='abbandonati') }}" style="text-decoration: none; color: inherit;">
            <div class="card-styled style-red" style="cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
                <div class="background-design pos-variant-4">
                    <div class="circle"></div>
                    <div class="circle"></div>
                    <div class="circle"></div>
                </div>
                <div class="card-content-centered">
                    <div class="card-icon-large"><i class="bi bi-x-circle-fill"></i></div>
                    <div class="card-number-large">{{ abbandonati }}</div>
                    <div class="card-label-large">Abbandonati</div>
                </div>
            </div>
        </a>
    </div>

    <!-- Modal Note -->
    <div id="modalNote" class="modal-note">
        <div class="modal-note-content">
            <div class="modal-note-header">
                <h3>Note Admin</h3>
                <button class="btn-close-modal" onclick="chiudiModalNote()">&times;</button>
            </div>
            <div class="modal-note-body">
                <div id="listaNote" class="lista-note">
                    <!-- Le note verranno caricate qui via JavaScript -->
                </div>
            </div>
            <div class="modal-note-footer">
                <button class="btn-primary" onclick="apriModalNuovaNota()">
                    <i class="bi bi-plus-circle"></i> Nuova Nota
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nuova/Modifica Nota -->
    <div id="modalNuovaNota" class="modal-note">
        <div class="modal-note-content modal-note-small">
            <div class="modal-note-header">
                <h3 id="modalNotaTitolo">Nuova Nota</h3>
                <button class="btn-close-modal" onclick="chiudiModalNuovaNota()">&times;</button>
            </div>
            <div class="modal-note-body">
                <textarea id="notaContenuto" class="textarea-nota" placeholder="Inserisci il contenuto della nota..." rows="6"></textarea>
            </div>
            <div class="modal-note-footer">
                <button class="btn-secondary" onclick="chiudiModalNuovaNota()">Annulla</button>
                <button class="btn-primary" onclick="salvaNota()">Salva</button>
            </div>
        </div>
    </div>

    <script>
        const defaultAmount = "{% if tot_importo is defined %}â‚¬ {{ '{:,.2f}'.format(tot_importo).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}â‚¬ 0,00{% endif %}";
        const defaultName = "Totale Lavori";
        
        function formatCurrency(value) {
            // Formatta: â‚¬ prima, punto per migliaia, virgola per decimali
            let num = parseFloat(value) || 0;
            // Usa toFixed per avere sempre 2 decimali
            let numStr = num.toFixed(2);
            // Separa parte intera e decimale
            let parts = numStr.split('.');
            let integerPart = parts[0];
            let decimalPart = parts[1] || '00';
            
            // Aggiungi punti come separatori delle migliaia
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            return 'â‚¬ ' + integerPart + ',' + decimalPart;
        }
        
        function updateWidget(name, amount) {
            let formatted = formatCurrency(amount);
            document.getElementById('displayAmount').innerText = formatted;
            document.getElementById('displayName').innerText = "Compenso " + name;
        }
        function resetWidget() {
            document.getElementById('displayAmount').innerText = defaultAmount;
            document.getElementById('displayName').innerText = defaultName;
        }

        // Gestione Note
        let notaIdInModifica = null;
        let noteCache = {}; // Cache locale delle note per modifica sicura

        function apriModalNote() {
            document.getElementById('modalNote').style.display = 'flex';
            caricaNote();
            // Segna le note come viste e nascondi il badge
            fetch('/api/note/mark-seen', { method: 'POST' })
                .then(() => {
                    const badge = document.getElementById('badgeNuoveNote');
                    if (badge) badge.style.display = 'none';
                });
        }

        function chiudiModalNote() {
            document.getElementById('modalNote').style.display = 'none';
            document.getElementById('modalNuovaNota').style.display = 'none';
        }

        function apriModalNuovaNota() {
            notaIdInModifica = null;
            document.getElementById('modalNotaTitolo').textContent = 'Nuova Nota';
            document.getElementById('notaContenuto').value = '';
            document.getElementById('modalNuovaNota').style.display = 'flex';
        }

        function chiudiModalNuovaNota() {
            document.getElementById('modalNuovaNota').style.display = 'none';
            notaIdInModifica = null;
        }

        function apriModalModificaNota(id) {
            notaIdInModifica = id;
            document.getElementById('modalNotaTitolo').textContent = 'Modifica Nota';
            // Leggi il contenuto dalla cache JS (nessun problema di escape)
            document.getElementById('notaContenuto').value = noteCache[id] || '';
            document.getElementById('modalNuovaNota').style.display = 'flex';
        }

        function caricaNote() {
            fetch('/api/note')
                .then(response => response.json())
                .then(data => {
                    const listaNote = document.getElementById('listaNote');
                    listaNote.innerHTML = '';
                    noteCache = {}; // Reset cache
                    
                    if (data.note && data.note.length > 0) {
                        data.note.forEach(nota => {
                            // Salva il contenuto nella cache JS
                            noteCache[nota.id] = nota.contenuto;
                            
                            const divNota = document.createElement('div');
                            divNota.className = 'nota-item';
                            
                            // Costruisci contenuto
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'nota-item-content';
                            
                            const textDiv = document.createElement('div');
                            textDiv.className = 'nota-item-text';
                            textDiv.textContent = nota.contenuto;
                            
                            const metaDiv = document.createElement('div');
                            metaDiv.className = 'nota-item-meta';
                            
                            const autoreSpan = document.createElement('span');
                            autoreSpan.className = 'nota-item-autore';
                            autoreSpan.textContent = nota.autore;
                            
                            const dataSpan = document.createElement('span');
                            dataSpan.className = 'nota-item-data';
                            dataSpan.textContent = nota.created_at;
                            
                            metaDiv.appendChild(autoreSpan);
                            metaDiv.appendChild(dataSpan);
                            
                            if (nota.updated_at && nota.updated_at !== nota.created_at) {
                                const updatedSpan = document.createElement('span');
                                updatedSpan.className = 'nota-item-updated';
                                updatedSpan.textContent = '(modificata: ' + nota.updated_at + ')';
                                metaDiv.appendChild(updatedSpan);
                            }
                            
                            contentDiv.appendChild(textDiv);
                            contentDiv.appendChild(metaDiv);
                            
                            // Pulsanti azione
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'nota-item-actions';
                            
                            const editBtn = document.createElement('button');
                            editBtn.className = 'btn-edit-note';
                            editBtn.title = 'Modifica';
                            editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                            editBtn.addEventListener('click', function() {
                                apriModalModificaNota(nota.id);
                            });
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn-delete-note';
                            deleteBtn.title = 'Elimina';
                            deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                            deleteBtn.addEventListener('click', function() {
                                eliminaNota(nota.id);
                            });
                            
                            actionsDiv.appendChild(editBtn);
                            actionsDiv.appendChild(deleteBtn);
                            
                            divNota.appendChild(contentDiv);
                            divNota.appendChild(actionsDiv);
                            listaNote.appendChild(divNota);
                        });
                    } else {
                        listaNote.innerHTML = '<div class="nota-empty">Nessuna nota ancora. Clicca "Nuova Nota" per aggiungerne una.</div>';
                    }
                })
                .catch(error => {
                    console.error('Errore nel caricamento delle note:', error);
                    document.getElementById('listaNote').innerHTML = '<div class="nota-error">Errore nel caricamento delle note.</div>';
                });
        }

        function aggiornaCardNote() {
            fetch('/api/note')
                .then(response => response.json())
                .then(data => {
                    const cardNotesContent = document.querySelector('.card-notes-content');
                    if (!cardNotesContent) return;
                    
                    cardNotesContent.innerHTML = '';
                    
                    if (data.note && data.note.length > 0) {
                        data.note.forEach(nota => {
                            const divNota = document.createElement('div');
                            divNota.className = 'nota-preview';
                            
                            const textDiv = document.createElement('div');
                            textDiv.className = 'nota-preview-text';
                            textDiv.textContent = nota.contenuto;
                            
                            const metaDiv = document.createElement('div');
                            metaDiv.className = 'nota-preview-meta';
                            metaDiv.innerHTML = `<span class="nota-autore">${escapeHtml(nota.autore)}</span><span class="nota-data">${nota.created_at}</span>`;
                            
                            divNota.appendChild(textDiv);
                            divNota.appendChild(metaDiv);
                            cardNotesContent.appendChild(divNota);
                        });
                    } else {
                        cardNotesContent.innerHTML = '<div class="nota-empty">Nessuna nota ancora. Clicca + per aggiungerne una.</div>';
                    }
                })
                .catch(error => {
                    console.error('Errore nell\'aggiornamento della card note:', error);
                });
        }

        function salvaNota() {
            const contenuto = document.getElementById('notaContenuto').value.trim();
            
            if (!contenuto) {
                alert('Il contenuto della nota non puÃ² essere vuoto.');
                return;
            }

            const url = notaIdInModifica ? `/api/note/${notaIdInModifica}` : '/api/note';
            const method = notaIdInModifica ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contenuto: contenuto })
            })
            .then(response => {
                if (response.ok) return response.json();
                throw new Error('Errore nel salvataggio');
            })
            .then(data => {
                chiudiModalNuovaNota();
                caricaNote();
                aggiornaCardNote();
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore nel salvataggio della nota.');
            });
        }

        function eliminaNota(id) {
            if (!confirm('Sei sicuro di voler eliminare questa nota?')) return;

            fetch(`/api/note/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    caricaNote();
                    aggiornaCardNote();
                } else {
                    throw new Error('Errore nell\'eliminazione');
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore nell\'eliminazione della nota.');
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            if (event.target == document.getElementById('modalNote')) chiudiModalNote();
            if (event.target == document.getElementById('modalNuovaNota')) chiudiModalNuovaNota();
        }
    </script>

{% else %}

    <div class="oneui-grid">
        
        <div class="card-styled style-blue">
            <div class="background-design pos-variant-1">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-folder-fill"></i></div>
                <div class="card-number-large">{{ total_lavori }}</div>
                <div class="card-label-large">Lavori Attivi</div>
            </div>
        </div>

        <div class="card-styled style-orange">
            <div class="background-design pos-variant-2">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-clock-history"></i></div>
                <div class="card-number-large">{{ in_corso }}</div>
                <div class="card-label-large">In Lavorazione</div>
            </div>
        </div>

        <div class="card-styled style-green">
            <div class="background-design pos-variant-3">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-check-circle-fill"></i></div>
                <div class="card-number-large">{{ completati }}</div>
                <div class="card-label-large">Completati</div>
            </div>
        </div>

        <div class="oneui-card span-col-2" style="max-height: 240px; overflow-y: auto;"> <div class="card-header-row">
                <h4>AttivitÃ  Recente</h4>
                <span class="badge">{{ timeline[0].label }}</span>
            </div>
            <div class="timeline-placeholder" style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
                {% for item in timeline %}
                <div class="timeline-row">
                    <div style="font-size: 0.85rem; font-weight: 600; width: 40px;">{{ item.label }}</div>
                    <div style="flex: 1; background: #f0f0f0; border-radius: 10px; height: 12px; position: relative; overflow: hidden;">
                        <div class="fake-bar" style="width: {{ item.width }}%; background: {{ item.color }}; height: 100%; border-radius: 10px;"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #888; width: 30px; text-align: right;">{{ item.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="oneui-card">
            <h4>Notifiche Recenti</h4>
            <ul class="notification-list">
                <li>
                    <span class="dot"></span>
                    <span class="text">Admin ha assegnato <b>Lavoro #45</b></span>
                </li>
                <li>
                    <span class="dot"></span>
                    <span class="text">Nuovo file caricato in <b>Industria 4.0</b></span>
                </li>
            </ul>
        </div>

    </div>

{% endif %}

{% endblock %}