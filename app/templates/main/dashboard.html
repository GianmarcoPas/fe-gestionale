{% extends "base.html" %}

{% block content %}

<div class="dashboard-header">
    <h2>Ciao, {{ current_user.username }} ðŸ‘‹</h2>
    <p class="subtitle">
        {% if role == 'admin' %}
            Panoramica Finanziaria e Gestionale.
        {% else %}
            Ecco la situazione aggiornata dei tuoi lavori.
        {% endif %}
    </p>
</div>

{% if role == 'admin' %}
    <!-- PRIMA RIGA: Fatturazione, Timeline, Note -->
    <div class="dashboard-first-row">
        <!-- Card Fatturazione -->
        <div class="card-widget-revenue" style="transition: transform 0.2s, box-shadow 0.2s;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow=''">
            <div class="background-design">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="info-section">
                <div class="left-side">
                    <div class="temperature" id="displayAmount">
                        {% if tot_importo is defined %}
                            â‚¬ {{ "{:,.2f}".format(tot_importo).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        {% else %}
                            â‚¬ 0,00
                        {% endif %}
                    </div>
                    <div class="date" id="displayName">Totale Lavori</div>
                    <div class="date" id="displayAmount2" style="font-size: 1.2rem; margin-top: 8px; opacity: 0.9;">
                        {% if tot_importo_da_fatturare is defined %}
                            â‚¬ {{ "{:,.2f}".format(tot_importo_da_fatturare).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        {% else %}
                            â‚¬ 0,00
                        {% endif %}
                    </div>
                    <div class="date" id="displayName2" style="font-size: 0.75rem; margin-top: 2px;">Da Fatturare</div>
                    <div class="date" id="displayAmount3" style="font-size: 1.2rem; margin-top: 8px; opacity: 0.9;">
                        {% if tot_importo_incassata is defined %}
                            â‚¬ {{ "{:,.2f}".format(tot_importo_incassata).replace(",", "X").replace(".", ",").replace("X", ".") }}
                        {% else %}
                            â‚¬ 0,00
                        {% endif %}
                    </div>
                    <div class="date" id="displayName3" style="font-size: 0.75rem; margin-top: 2px;">Incassati</div>
                </div>
            </div>
            <div class="days-section">
                <a href="{{ url_for('main.fatturazione', tipo='fe') }}" class="days-section-link" onmouseenter="updateWidget('FE', '{{ tot_fe }}', '{{ tot_fe_incassata }}', '{{ tot_fe_fatturato }}')" onmouseleave="resetWidget()">
                    <button>FE</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='amin') }}" class="days-section-link" onmouseenter="updateWidget('AMIN', '{{ tot_amin }}', '{{ tot_amin_incassata }}', '{{ tot_amin_fatturato }}')" onmouseleave="resetWidget()">
                    <button>AMIN</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='galvan') }}" class="days-section-link" onmouseenter="updateWidget('GALV', '{{ tot_galvan }}', '{{ tot_galvan_incassata }}', '{{ tot_galvan_fatturato }}')" onmouseleave="resetWidget()">
                    <button>GALV</button>
                </a>
                <a href="{{ url_for('main.fatturazione', tipo='fh') }}" class="days-section-link" onmouseenter="updateWidget('FH', '{{ tot_fh }}', '{{ tot_fh_incassata }}', '{{ tot_fh_fatturato }}')" onmouseleave="resetWidget()">
                    <button>FH</button>
                </a>
            </div>
        </div>

        <!-- Card Stati Lavori Unificata -->
        <div class="card-stati-lavori-unificata">
            <a href="{{ url_for('main.lavori_admin', filtro_stato='tutti') }}" class="stato-item-link">
                <div class="stato-item style-blue-item">
                    <div class="stato-icon"><i class="bi bi-folder-fill"></i></div>
                    <div class="stato-content">
                        <div class="stato-number">{{ total_lavori }}</div>
                        <div class="stato-label">Totale Lavori</div>
                    </div>
                </div>
            </a>
            <a href="{{ url_for('main.lavori_admin', filtro_stato='in_lavorazione') }}" class="stato-item-link">
                <div class="stato-item style-orange-item">
                    <div class="stato-icon"><i class="bi bi-clock-history"></i></div>
                    <div class="stato-content">
                        <div class="stato-number">{{ in_corso }}</div>
                        <div class="stato-label">In Lavorazione</div>
                    </div>
                </div>
            </a>
            <a href="{{ url_for('main.lavori_admin', filtro_stato='completati') }}" class="stato-item-link">
                <div class="stato-item style-green-item">
                    <div class="stato-icon"><i class="bi bi-check-circle-fill"></i></div>
                    <div class="stato-content">
                        <div class="stato-number">{{ completati }}</div>
                        <div class="stato-label">Completati</div>
                    </div>
                </div>
            </a>
            <a href="{{ url_for('main.lavori_admin', filtro_stato='abbandonati') }}" class="stato-item-link">
                <div class="stato-item style-red-item">
                    <div class="stato-icon"><i class="bi bi-x-circle-fill"></i></div>
                    <div class="stato-content">
                        <div class="stato-number">{{ abbandonati }}</div>
                        <div class="stato-label">Abbandonati</div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Card Note -->
        <div class="card-notes" onclick="apriModalNote()" style="cursor: pointer;">
            <div class="card-notes-header">
                <h4>Note
                    {% if nuove_note_count and nuove_note_count > 0 %}
                    <span class="badge-new-notes" id="badgeNuoveNote">{{ nuove_note_count }}</span>
                    {% endif %}
                </h4>
                <button class="btn-add-note" onclick="event.stopPropagation(); apriModalNuovaNota()" title="Aggiungi nota">
                    <i class="bi bi-plus-circle-fill"></i>
                </button>
            </div>
            <div class="card-notes-content">
                {% if tutte_note %}
                    {% for nota in tutte_note %}
                    <div class="nota-preview">
                        <div class="nota-preview-text">{{ nota.contenuto }}</div>
                        <div class="nota-preview-meta">
                            <span class="nota-autore">{{ nota.autore.username }}</span>
                            <span class="nota-data">{{ nota.created_at.strftime('%d/%m/%Y') }}</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="nota-empty">Nessuna nota ancora. Clicca + per aggiungerne una.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- SECONDA RIGA: Da Incassare (span 2) + Timeline (span 1) -->
    <div class="dashboard-second-row">
        <!-- Card Da Incassare (occupa 2 colonne) -->
        <div class="card-incasso-split">
            <!-- Sezione Superiore: Riepilogo -->
            <a href="{{ url_for('main.lavori_admin', filtro_stato='da_incassare') }}" class="incasso-top-link">
                <div class="incasso-top">
                    <div class="incasso-top-icon">
                        <i class="bi bi-cash-coin"></i>
                    </div>
                    <div class="incasso-top-info">
                        <div class="incasso-top-number">{{ da_incassare_totale }}</div>
                        <div class="incasso-top-label">Da Incassare FE</div>
                    </div>
                    <div class="incasso-top-amount">
                        â‚¬ {{ "{:,.2f}".format(importo_da_incassare).replace(",", "X").replace(".", ",").replace("X", ".") }}
                    </div>
                </div>
            </a>
            <!-- Sezione Inferiore: Solleciti per settimane -->
            <div class="incasso-bottom">
                <div class="incasso-week-item incasso-week-2w {% if da_incassare_2w == 0 %}incasso-week-empty{% endif %}" onclick="{% if da_incassare_2w > 0 %}mostraDettagliIncasso(2){% endif %}">
                    <div class="incasso-week-icon"><i class="bi bi-exclamation-circle"></i></div>
                    <div class="incasso-week-info">
                        <span class="incasso-week-count">{{ da_incassare_2w }}</span>
                        <span class="incasso-week-label">da 2+ sett.</span>
                    </div>
                </div>
                <div class="incasso-week-item incasso-week-3w {% if da_incassare_3w == 0 %}incasso-week-empty{% endif %}" onclick="{% if da_incassare_3w > 0 %}mostraDettagliIncasso(3){% endif %}">
                    <div class="incasso-week-icon"><i class="bi bi-exclamation-triangle"></i></div>
                    <div class="incasso-week-info">
                        <span class="incasso-week-count">{{ da_incassare_3w }}</span>
                        <span class="incasso-week-label">da 3+ sett.</span>
                    </div>
                </div>
                <div class="incasso-week-item incasso-week-4w {% if da_incassare_4w == 0 %}incasso-week-empty{% endif %}" onclick="{% if da_incassare_4w > 0 %}mostraDettagliIncasso(4){% endif %}">
                    <div class="incasso-week-icon"><i class="bi bi-exclamation-octagon-fill"></i></div>
                    <div class="incasso-week-info">
                        <span class="incasso-week-count">{{ da_incassare_4w }}</span>
                        <span class="incasso-week-label">da 4+ sett.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Timeline (stessa dimensione di Note) -->
        <div class="card-timeline-compact">
            <div class="card-header-row">
                <h4>Timeline Lavori</h4>
                <span class="badge">{{ timeline[0].label if timeline else 'N/A' }}</span>
            </div>
            <div class="timeline-placeholder-compact">
                {% for item in timeline %}
                <div class="timeline-row">
                    <div style="font-size: 0.75rem; font-weight: 600; width: 35px;">{{ item.label }}</div>
                    <div style="flex: 1; background: #f0f0f0; border-radius: 8px; height: 10px; position: relative; overflow: hidden;">
                        <div class="fake-bar" style="width: {{ item.width }}%; background: {{ item.color }}; height: 100%; border-radius: 8px;"></div>
                    </div>
                    <div style="font-size: 0.7rem; color: #888; width: 25px; text-align: right;">{{ item.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Modal Dettagli Da Incassare -->
    <div id="modalIncasso" class="modal-note">
        <div class="modal-note-content modal-incasso-content">
            <div class="modal-note-header">
                <h3 id="modalIncassoTitolo">Lavori Da Incassare</h3>
                <button class="btn-close-modal" onclick="chiudiModalIncasso()">&times;</button>
            </div>
            <div class="modal-note-body" style="overflow-x: auto;">
                <table class="incasso-table" id="incassoTable">
                    <thead>
                        <tr>
                            <th>Cat.</th>
                            <th>NÂ°</th>
                            <th>Cliente</th>
                            <th>Bene/i</th>
                            <th>Importo</th>
                            <th>Sp. Amm.</th>
                            <th>Rev.</th>
                            <th>Car.</th>
                            <th>Fattura FE</th>
                            <th>Data Fatt.</th>
                            <th>Giorni</th>
                        </tr>
                    </thead>
                    <tbody id="incassoTableBody">
                    </tbody>
                </table>
                <div id="incassoEmpty" class="nota-empty" style="display: none;">Nessun lavoro trovato per questo periodo.</div>
            </div>
        </div>
    </div>

    <!-- Modal Note -->
    <div id="modalNote" class="modal-note">
        <div class="modal-note-content">
            <div class="modal-note-header">
                <h3>Note Admin</h3>
                <button class="btn-close-modal" onclick="chiudiModalNote()">&times;</button>
            </div>
            <div class="modal-note-body">
                <div id="listaNote" class="lista-note">
                    <!-- Le note verranno caricate qui via JavaScript -->
                </div>
            </div>
            <div class="modal-note-footer">
                <button class="btn-primary" onclick="apriModalNuovaNota()">
                    <i class="bi bi-plus-circle"></i> Nuova Nota
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Nuova/Modifica Nota -->
    <div id="modalNuovaNota" class="modal-note">
        <div class="modal-note-content modal-note-small">
            <div class="modal-note-header">
                <h3 id="modalNotaTitolo">Nuova Nota</h3>
                <button class="btn-close-modal" onclick="chiudiModalNuovaNota()">&times;</button>
            </div>
            <div class="modal-note-body">
                <textarea id="notaContenuto" class="textarea-nota" placeholder="Inserisci il contenuto della nota..." rows="6"></textarea>
            </div>
            <div class="modal-note-footer">
                <button class="btn-secondary" onclick="chiudiModalNuovaNota()">Annulla</button>
                <button class="btn-primary" onclick="salvaNota()">Salva</button>
            </div>
        </div>
    </div>

    <script>
        const defaultAmount = "{% if tot_importo is defined %}â‚¬ {{ '{:,.2f}'.format(tot_importo).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}â‚¬ 0,00{% endif %}";
        const defaultName = "Totale Lavori";
        const defaultAmount2 = "{% if tot_importo_da_fatturare is defined %}â‚¬ {{ '{:,.2f}'.format(tot_importo_da_fatturare).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}â‚¬ 0,00{% endif %}";
        const defaultName2 = "Da Fatturare";
        const defaultAmount3 = "{% if tot_importo_incassata is defined %}â‚¬ {{ '{:,.2f}'.format(tot_importo_incassata).replace(',', 'X').replace('.', ',').replace('X', '.') }}{% else %}â‚¬ 0,00{% endif %}";
        const defaultName3 = "Incassati";
        
        function formatCurrency(value) {
            // Formatta: â‚¬ prima, punto per migliaia, virgola per decimali
            let num = parseFloat(value) || 0;
            // Usa toFixed per avere sempre 2 decimali
            let numStr = num.toFixed(2);
            // Separa parte intera e decimale
            let parts = numStr.split('.');
            let integerPart = parts[0];
            let decimalPart = parts[1] || '00';
            
            // Aggiungi punti come separatori delle migliaia
            integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            
            return 'â‚¬ ' + integerPart + ',' + decimalPart;
        }
        
        function updateWidget(name, totale, daFatturare, fatturato) {
            // Mostra i tre valori per l'azienda
            document.getElementById('displayAmount').innerText = formatCurrency(totale);
            document.getElementById('displayName').innerText = "Compenso " + name;
            
            // Per FE: non mostrare "da fatturare", mostra "-"
            if (name === 'FE') {
                document.getElementById('displayAmount2').innerText = '-';
                document.getElementById('displayName2').innerText = "Da Fatturare";
            } else {
                document.getElementById('displayAmount2').innerText = formatCurrency(daFatturare);
                document.getElementById('displayName2').innerText = "Da Fatturare";
            }
            
            // Aggiungi una terza riga per i fatturati
            let displayAmount3 = document.getElementById('displayAmount3');
            let displayName3 = document.getElementById('displayName3');
            if (!displayAmount3) {
                const leftSide = document.querySelector('.left-side');
                displayAmount3 = document.createElement('div');
                displayAmount3.id = 'displayAmount3';
                displayAmount3.className = 'date';
                displayAmount3.style.cssText = 'font-size: 1.2rem; margin-top: 8px; opacity: 0.9;';
                displayName3 = document.createElement('div');
                displayName3.id = 'displayName3';
                displayName3.className = 'date';
                displayName3.style.cssText = 'font-size: 0.75rem; margin-top: 2px;';
                leftSide.appendChild(displayAmount3);
                leftSide.appendChild(displayName3);
            }
            displayAmount3.innerText = formatCurrency(fatturato);
            displayName3.innerText = (name === 'FE') ? "Cassa" : "Fatturato";
        }
        function resetWidget() {
            document.getElementById('displayAmount').innerText = defaultAmount;
            document.getElementById('displayName').innerText = defaultName;
            document.getElementById('displayAmount2').innerText = defaultAmount2;
            document.getElementById('displayName2').innerText = defaultName2;
            document.getElementById('displayAmount3').innerText = defaultAmount3;
            document.getElementById('displayName3').innerText = defaultName3;
            const displayAmount4 = document.getElementById('displayAmount4');
            const displayName4 = document.getElementById('displayName4');
            if (displayAmount4) {
                displayAmount4.remove();
                displayName4.remove();
            }
        }

        // Gestione Note
        let notaIdInModifica = null;
        let noteCache = {}; // Cache locale delle note per modifica sicura

        function apriModalNote() {
            document.getElementById('modalNote').style.display = 'flex';
            caricaNote();
            // Segna le note come viste e nascondi il badge
            fetch('/api/note/mark-seen', { method: 'POST' })
                .then(() => {
                    const badge = document.getElementById('badgeNuoveNote');
                    if (badge) badge.style.display = 'none';
                });
        }

        function chiudiModalNote() {
            document.getElementById('modalNote').style.display = 'none';
            document.getElementById('modalNuovaNota').style.display = 'none';
        }

        function apriModalNuovaNota() {
            notaIdInModifica = null;
            document.getElementById('modalNotaTitolo').textContent = 'Nuova Nota';
            document.getElementById('notaContenuto').value = '';
            document.getElementById('modalNuovaNota').style.display = 'flex';
        }

        function chiudiModalNuovaNota() {
            document.getElementById('modalNuovaNota').style.display = 'none';
            notaIdInModifica = null;
        }

        function apriModalModificaNota(id) {
            notaIdInModifica = id;
            document.getElementById('modalNotaTitolo').textContent = 'Modifica Nota';
            // Leggi il contenuto dalla cache JS (nessun problema di escape)
            document.getElementById('notaContenuto').value = noteCache[id] || '';
            document.getElementById('modalNuovaNota').style.display = 'flex';
        }

        function caricaNote() {
            fetch('/api/note')
                .then(response => response.json())
                .then(data => {
                    const listaNote = document.getElementById('listaNote');
                    listaNote.innerHTML = '';
                    noteCache = {}; // Reset cache
                    
                    if (data.note && data.note.length > 0) {
                        data.note.forEach(nota => {
                            // Salva il contenuto nella cache JS
                            noteCache[nota.id] = nota.contenuto;
                            
                            const divNota = document.createElement('div');
                            divNota.className = 'nota-item';
                            
                            // Costruisci contenuto
                            const contentDiv = document.createElement('div');
                            contentDiv.className = 'nota-item-content';
                            
                            const textDiv = document.createElement('div');
                            textDiv.className = 'nota-item-text';
                            textDiv.textContent = nota.contenuto;
                            
                            const metaDiv = document.createElement('div');
                            metaDiv.className = 'nota-item-meta';
                            
                            const autoreSpan = document.createElement('span');
                            autoreSpan.className = 'nota-item-autore';
                            autoreSpan.textContent = nota.autore;
                            
                            const dataSpan = document.createElement('span');
                            dataSpan.className = 'nota-item-data';
                            dataSpan.textContent = nota.created_at;
                            
                            metaDiv.appendChild(autoreSpan);
                            metaDiv.appendChild(dataSpan);
                            
                            if (nota.updated_at && nota.updated_at !== nota.created_at) {
                                const updatedSpan = document.createElement('span');
                                updatedSpan.className = 'nota-item-updated';
                                updatedSpan.textContent = '(modificata: ' + nota.updated_at + ')';
                                metaDiv.appendChild(updatedSpan);
                            }
                            
                            contentDiv.appendChild(textDiv);
                            contentDiv.appendChild(metaDiv);
                            
                            // Pulsanti azione
                            const actionsDiv = document.createElement('div');
                            actionsDiv.className = 'nota-item-actions';
                            
                            const editBtn = document.createElement('button');
                            editBtn.className = 'btn-edit-note';
                            editBtn.title = 'Modifica';
                            editBtn.innerHTML = '<i class="bi bi-pencil"></i>';
                            editBtn.addEventListener('click', function() {
                                apriModalModificaNota(nota.id);
                            });
                            
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'btn-delete-note';
                            deleteBtn.title = 'Elimina';
                            deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';
                            deleteBtn.addEventListener('click', function() {
                                eliminaNota(nota.id);
                            });
                            
                            actionsDiv.appendChild(editBtn);
                            actionsDiv.appendChild(deleteBtn);
                            
                            divNota.appendChild(contentDiv);
                            divNota.appendChild(actionsDiv);
                            listaNote.appendChild(divNota);
                        });
                    } else {
                        listaNote.innerHTML = '<div class="nota-empty">Nessuna nota ancora. Clicca "Nuova Nota" per aggiungerne una.</div>';
                    }
                })
                .catch(error => {
                    console.error('Errore nel caricamento delle note:', error);
                    document.getElementById('listaNote').innerHTML = '<div class="nota-error">Errore nel caricamento delle note.</div>';
                });
        }

        function aggiornaCardNote() {
            fetch('/api/note')
                .then(response => response.json())
                .then(data => {
                    const cardNotesContent = document.querySelector('.card-notes-content');
                    if (!cardNotesContent) return;
                    
                    cardNotesContent.innerHTML = '';
                    
                    if (data.note && data.note.length > 0) {
                        data.note.forEach(nota => {
                            const divNota = document.createElement('div');
                            divNota.className = 'nota-preview';
                            
                            const textDiv = document.createElement('div');
                            textDiv.className = 'nota-preview-text';
                            textDiv.textContent = nota.contenuto;
                            
                            const metaDiv = document.createElement('div');
                            metaDiv.className = 'nota-preview-meta';
                            metaDiv.innerHTML = `<span class="nota-autore">${escapeHtml(nota.autore)}</span><span class="nota-data">${nota.created_at}</span>`;
                            
                            divNota.appendChild(textDiv);
                            divNota.appendChild(metaDiv);
                            cardNotesContent.appendChild(divNota);
                        });
                    } else {
                        cardNotesContent.innerHTML = '<div class="nota-empty">Nessuna nota ancora. Clicca + per aggiungerne una.</div>';
                    }
                })
                .catch(error => {
                    console.error('Errore nell\'aggiornamento della card note:', error);
                });
        }

        function salvaNota() {
            const contenuto = document.getElementById('notaContenuto').value.trim();
            
            if (!contenuto) {
                alert('Il contenuto della nota non puÃ² essere vuoto.');
                return;
            }

            const url = notaIdInModifica ? `/api/note/${notaIdInModifica}` : '/api/note';
            const method = notaIdInModifica ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contenuto: contenuto })
            })
            .then(response => {
                if (response.ok) return response.json();
                throw new Error('Errore nel salvataggio');
            })
            .then(data => {
                chiudiModalNuovaNota();
                caricaNote();
                aggiornaCardNote();
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore nel salvataggio della nota.');
            });
        }

        function eliminaNota(id) {
            if (!confirm('Sei sicuro di voler eliminare questa nota?')) return;

            fetch(`/api/note/${id}`, { method: 'DELETE' })
            .then(response => {
                if (response.ok) {
                    caricaNote();
                    aggiornaCardNote();
                } else {
                    throw new Error('Errore nell\'eliminazione');
                }
            })
            .catch(error => {
                console.error('Errore:', error);
                alert('Errore nell\'eliminazione della nota.');
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // --- GESTIONE MODAL DA INCASSARE ---
        function mostraDettagliIncasso(settimane) {
            const titoli = {2: 'Da Incassare â€” 2+ Settimane', 3: 'Da Incassare â€” 3+ Settimane', 4: 'Da Incassare â€” 4+ Settimane'};
            document.getElementById('modalIncassoTitolo').textContent = titoli[settimane] || 'Lavori Da Incassare';
            document.getElementById('modalIncasso').style.display = 'flex';
            document.getElementById('incassoEmpty').style.display = 'none';
            document.getElementById('incassoTableBody').innerHTML = '<tr><td colspan="11" style="text-align:center; padding: 20px;">Caricamento...</td></tr>';

            fetch('/api/da-incassare?settimane=' + settimane)
                .then(r => r.json())
                .then(data => {
                    const tbody = document.getElementById('incassoTableBody');
                    tbody.innerHTML = '';
                    if (data.lavori && data.lavori.length > 0) {
                        document.getElementById('incassoTable').style.display = '';
                        document.getElementById('incassoEmpty').style.display = 'none';
                        data.lavori.forEach(l => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td><span class="cat-dot" style="background:${l.categoria_colore}" title="${l.categoria_label}"></span></td>
                                <td><strong>${l.numero || '-'}</strong></td>
                                <td>${escapeHtml(l.cliente)}</td>
                                <td class="incasso-beni-cell">${escapeHtml(l.beni)}</td>
                                <td style="white-space:nowrap;">â‚¬ ${Number(l.importo).toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
                                <td style="text-align:center;">${l.spese_amministrative ? '<i class="bi bi-check-circle-fill" style="color:#00A651"></i>' : '<i class="bi bi-dash" style="color:#ccc"></i>'}</td>
                                <td style="text-align:center;">${l.has_revisore ? '<i class="bi bi-check-circle-fill" style="color:#007AFF"></i>' : '<i class="bi bi-dash" style="color:#ccc"></i>'}</td>
                                <td style="text-align:center;">${l.has_caricamento ? '<i class="bi bi-check-circle-fill" style="color:#ff9f43"></i>' : '<i class="bi bi-dash" style="color:#ccc"></i>'}</td>
                                <td>${escapeHtml(l.fattura_fe)}</td>
                                <td style="white-space:nowrap;">${l.data_fattura_fe}</td>
                                <td><span class="giorni-badge giorni-${l.giorni_ritardo >= 28 ? 'critico' : l.giorni_ritardo >= 21 ? 'alto' : 'medio'}">${l.giorni_ritardo}g</span></td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        document.getElementById('incassoTable').style.display = 'none';
                        document.getElementById('incassoEmpty').style.display = 'block';
                    }
                })
                .catch(err => {
                    console.error('Errore:', err);
                    document.getElementById('incassoTableBody').innerHTML = '<tr><td colspan="11" style="text-align:center; color:red;">Errore nel caricamento</td></tr>';
                });
        }

        function chiudiModalIncasso() {
            document.getElementById('modalIncasso').style.display = 'none';
        }

        // Chiudi modal cliccando fuori
        window.onclick = function(event) {
            if (event.target == document.getElementById('modalNote')) chiudiModalNote();
            if (event.target == document.getElementById('modalNuovaNota')) chiudiModalNuovaNota();
            if (event.target == document.getElementById('modalIncasso')) chiudiModalIncasso();
        }
    </script>

{% else %}

    <div class="oneui-grid">
        
        <div class="card-styled style-blue">
            <div class="background-design pos-variant-1">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-folder-fill"></i></div>
                <div class="card-number-large">{{ total_lavori }}</div>
                <div class="card-label-large">Lavori Attivi</div>
            </div>
        </div>

        <div class="card-styled style-orange">
            <div class="background-design pos-variant-2">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-clock-history"></i></div>
                <div class="card-number-large">{{ in_corso }}</div>
                <div class="card-label-large">In Lavorazione</div>
            </div>
        </div>

        <div class="card-styled style-green">
            <div class="background-design pos-variant-3">
                <div class="circle"></div>
                <div class="circle"></div>
                <div class="circle"></div>
            </div>
            <div class="card-content-centered">
                <div class="card-icon-large"><i class="bi bi-check-circle-fill"></i></div>
                <div class="card-number-large">{{ completati }}</div>
                <div class="card-label-large">Completati</div>
            </div>
        </div>

        <div class="oneui-card span-col-2" style="max-height: 240px; overflow-y: auto;"> <div class="card-header-row">
                <h4>AttivitÃ  Recente</h4>
                <span class="badge">{{ timeline[0].label }}</span>
            </div>
            <div class="timeline-placeholder" style="display: flex; flex-direction: column; gap: 15px; margin-top: 15px;">
                {% for item in timeline %}
                <div class="timeline-row">
                    <div style="font-size: 0.85rem; font-weight: 600; width: 40px;">{{ item.label }}</div>
                    <div style="flex: 1; background: #f0f0f0; border-radius: 10px; height: 12px; position: relative; overflow: hidden;">
                        <div class="fake-bar" style="width: {{ item.width }}%; background: {{ item.color }}; height: 100%; border-radius: 10px;"></div>
                    </div>
                    <div style="font-size: 0.8rem; color: #888; width: 30px; text-align: right;">{{ item.count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="oneui-card">
            <h4>Notifiche Recenti</h4>
            <ul class="notification-list">
                <li>
                    <span class="dot"></span>
                    <span class="text">Admin ha assegnato <b>Lavoro #45</b></span>
                </li>
                <li>
                    <span class="dot"></span>
                    <span class="text">Nuovo file caricato in <b>Industria 4.0</b></span>
                </li>
            </ul>
        </div>

    </div>

{% endif %}

{% endblock %}